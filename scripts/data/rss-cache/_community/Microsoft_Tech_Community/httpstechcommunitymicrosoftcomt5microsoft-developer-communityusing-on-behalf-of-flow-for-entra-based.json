{
  "Link": "https://techcommunity.microsoft.com/t5/microsoft-developer-community/using-on-behalf-of-flow-for-entra-based-mcp-servers/ba-p/4486760",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "Author": "Pamela_Fox",
  "EnhancedContent": "In December, we presented a [series about MCP](https://aka.ms/pythonmcp/rewatch), culminating in a session about adding authentication to MCP servers. I demoed a Python MCP server that uses [Microsoft Entra](https://learn.microsoft.com/entra/fundamentals/whatis) for authentication, requiring users to first login to the Microsoft tenant before they could use a tool. Many developers asked how they could take the Entra integration further, like to check the user's group membership or query their OneDrive. That requires using an [\"on-behalf-of\" flow](https://learn.microsoft.com/entra/identity-platform/v2-oauth2-on-behalf-of-flow), where the MCP server uses the user's Entra identity to call another API, like the [Microsoft Graph API](https://learn.microsoft.com/graph/overview). In this blog post, I will explain how to use Entra with OBO flow in a Python FastMCP server.\n\n## How MCP servers can use Entra authentication\n\nThe [MCP authorization specification](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization) is based on OAuth2, with some additional features tacked on top.\n\nEvery **MCP client** is actually an **OAuth2 client**, and each **MCP server** is an **OAuth2 resource server:**\n\n![Diagram of OAuth 2.1 entities with MCP client and server](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7Qdgfkeqg2qCt7YgP399vUPvLsINoQ-tsU_uiLLgqWIP1fP5vSL19uuJFCdkc5GYa7dMDhR1Qe2gCBfmlRDF2nGNTajwXy6o8P-DKL5Yav97Z21KY9K1ZwN4RQgQorh-Iwu-Ck5Ciwc2J_DB1XaHUaChLQqjiczmCEY_5QcUeV9uCXCV-FbRUBylNfg/s1600/Screenshot%202026-01-16%20at%2012.13.34%E2%80%AFPM.png)\n\nMCP auth adds these features to help clients determine how to authorize a server:\n\n- **Protected resource metadata (PRM):** Implemented on the MCP server, provides details about the authorization server and method\n- **Authorization server metadata:** Implemented on the authorization server, gives URLs for OAuth2 endpoints\n\nAdditionally, to allow MCP servers to work with arbitrary MCP clients, MCP auth supports either of these client registration methods:\n\n- **Dynamic Client Registration (DCR):** Implemented on the authorization server, it can register new MCP clients as OAuth2 clients, even if it hasn't seen them before.\n- **Client ID Metadata Documents (CIMD):** An alternative to DCR, this requires both the MCP client to make a CIMD document available on a server, and requires the authorization server to fetch the CIMD document for details about the client.\n\nMicrosoft Entra does support authorization server metadata, but it does *not* support either DCR or CIMD. That's actually fine if you are building an MCP server that's only going to be used with pre-authorized clients, like if the server will only be used with VS Code or with a specific internal MCP client. But, if you are building an MCP server that can be used with arbitrary MCP clients, then either DCR or CIMD is required. So what do we do?\n\nFortunately, the [FastMCP](https://gofastmcp.com/) SDK implements [DCR on top of Entra](https://gofastmcp.com/integrations/azure) using an OAuth proxy pattern. FastMCP acts as the authorization server, intercepting requests and forwarding to Entra when needed, and storing OAuth client information in a designated database (like in-memory or [Cosmos DB](https://learn.microsoft.com/azure/cosmos-db/introduction)).\n\n![Diagram of OAuth proxy pattern](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgiASwccA1SpE3eIhgi7_lQcwo3gPOkYFwQtGedSx19qw3Nxmiz07XWRlafkzHz8V7ATYspcj64kN5bwY24H8TDIPK_Kbf21CNQSj8E23dOM7ja3gd39Wq9fcf86RO8a6e1kkhtVykNhDGTD8FZeVROeASl_dFSR6wa9VtLZpmJeb_fthjdl05cj9a-Cw/s1600/Screenshot%202026-01-16%20at%2010.10.23%E2%80%AFAM.png)\n\nLet's walk through the steps to set that up.\n\n## Registering the server with Entra\n\nBefore the server can use Entra to authorize users, we need to register the server with Entra via an app registration. We can do registration using the Azure Portal, Azure CLI, Microsoft Graph SDK, or even Bicep. In this demo, I use the [Python MS Graph SDK](https://github.com/microsoftgraph/msgraph-sdk-python) as it allows me to specify everything programmatically.\n\nFirst, I create the Entra app registration, specifying the sign-in audience (single-tenant), redirect URIs (including local MCP server, deployed MCP server, and VS Code redirect URIs), and the scopes for the exposed API.\n\n``` request_app = Application( display_name=\"FastMCP Server App\", sign_in_audience=\"AzureADMyOrg\", # Single tenant web=WebApplication( redirect_uris=[ \"http://localhost:8000/auth/callback\", \"https://vscode.dev/redirect\", \"http://127.0.0.1:33418\", \"https://deployedurl.com/auth/callback\" ], ), api=ApiApplication( oauth2_permission_scopes=[ PermissionScope( id=uuid.UUID(\"{\" + str(uuid.uuid4()) + \"}\"), admin_consent_display_name=\"Access FastMCP Server\", admin_consent_description=\"Allows access to the FastMCP server as the signed-in user.\", user_consent_display_name=\"Access FastMCP Server\", user_consent_description=\"Allow access to the FastMCP server on your behalf\", is_enabled=True, value=\"mcp-access\", type=\"User\", )], requested_access_token_version=2, # Required by FastMCP ) ) app = await graph_client.applications.post(request_app)\n\nawait graph_client.applications.by_application_id(app.id).patch( Application(identifier_uris=[f\"api://{app.app_id}\"]))\n\n```\n\nThanks to that configuration, when an MCP client like VS Code requests an OAuth2 token, it will request a token with the scope \"api://{app.app\\_id}/mcp-access\", and the FastMCP server will validate that incoming tokens contain that scope.\n\nNext, I create a [Service Principal](https://learn.microsoft.com/entra/identity-platform/app-objects-and-service-principals?tabs=browser) for that Entra app registration, which represents the Entra app in my tenant\n\n``` request_principal = ServicePrincipal(app_id=app.app_id, display_name=app.display_name) await graph_client.service_principals.post(request_principal) ```\n\nI need a way for the server to prove that it can use that Entra app registration, so I register a secret:\n\n``` password_credential = await graph_client.applications.by_application_id(app.id).add_password.post( AddPasswordPostRequestBody( password_credential=PasswordCredential(display_name=\"FastMCPSecret\")))\n\n```\n\nIdeally, I would like to move away from secrets, as Entra now has support for using [federated identity credentials](https://learn.microsoft.com/entra/workload-id/workload-identity-federation-config-app-trust-managed-identity) for Entra app registrations instead, but that form of credential isn't supported yet in the FastMCP SDK. If you choose to use a secret, make sure that you store the secret securely.\n\n### Granting admin consent\n\nThis next step is only necessary when our MCP server wants to use an OBO flow to exchange access tokens for other resource server tokens (Graph API tokens, in this case).\n\nFor the OBO flow to work, the Entra app registration needs permission to call the Graph API on behalf of users. *If* we controlled the client, we could force it to request the required scopes as part of the initial login dialog. However, since we are configuring this server to work with *arbitrary* MCP clients, we don't have that option.\n\nInstead, we grant [admin consent](https://learn.microsoft.com/entra/identity-platform/v2-oauth2-on-behalf-of-flow#admin-consent) to the Entra app for the necessary scopes, such that no Graph API consent dialog is needed.\n\nThis code grants admin consent to the associated service principal for the Graph API resource and scopes:\n\n``` server_principal = await graph_client.service_principals_with_app_id(app.app_id).get() grant = GrantDefinition( principal_id=server_principal.id, resource_app_id=\"00000003-0000-0000-c000-000000000000\", # Graph API scopes=[\"User.Read\", \"email\", \"offline_access\", \"openid\", \"profile\"], target_label=\"server application\") resource_principal = await graph_client.service_principals_with_app_id(grant.resource_app_id).get() desired_scope = grant.scope_string() await graph_client.oauth2_permission_grants.post( OAuth2PermissionGrant( client_id=grant.principal_id, consent_type=\"AllPrincipals\", resource_id=resource_principal.id, scope=desired_scope))\n\n```\n\nIf our MCP server needed to use an OBO flow with another resource server, we could request additional grants for those resources and scopes.\n\nOur Entra app registration is now ready for the MCP server, so let's move on to see the server code.\n\n## Using FastMCP servers with Entra\n\nIn our MCP server code, we configure FastMCP's built in [AzureProvider](https://gofastmcp.com/integrations/azure) based off the details from the Entra app registration process:\n\n``` auth = AzureProvider( client_id=os.environ[\"ENTRA_PROXY_AZURE_CLIENT_ID\"], client_secret=os.environ[\"ENTRA_PROXY_AZURE_CLIENT_SECRET\"], tenant_id=os.environ[\"AZURE_TENANT_ID\"], base_url=entra_base_url, # MCP server URL required_scopes=[\"mcp-access\"], client_storage=oauth_client_store, # in-memory or Cosmos DB ) ```\n\nTo make it easy for our MCP tools to access an identifier for the currently logged in user, we define a middleware that inspects the claims of the current token using FastMCP's `get_access_token()` and sets the \"oid\" (Entra object identifier) in the state:\n\n``` class UserAuthMiddleware(Middleware): def _get_user_id(self): token = get_access_token() if not (token and hasattr(token, \"claims\")): return None return token.claims.get(\"oid\")\n\nasync def on_call_tool(self, context: MiddlewareContext, call_next): user_id = self._get_user_id() if context.fastmcp_context is not None: context.fastmcp_context.set_state(\"user_id\", user_id) return await call_next(context)\n\nasync def on_read_resource(self, context: MiddlewareContext, call_next): user_id = self._get_user_id() if context.fastmcp_context is not None: context.fastmcp_context.set_state(\"user_id\", user_id) return await call_next(context)\n\n```\n\nWhen we initialize the FastMCP server, we set the auth provider and include that middleware:\n\n``` mcp = FastMCP(\"Expenses Tracker\", auth=auth, middleware=[UserAuthMiddleware()])\n\n```\n\nNow, every request made to the MCP server will require authentication. The server will return a 401 if a valid token isn't provided, and that 401 will prompt the MCP client to kick off the MCP authorization flow.\n\nInside each tool, we can grab the user id from the state, and use that to customize the response for the user, like to store or query items in a database.\n\n``` .tool async def add_user_expense( date: Annotated[date, \"Date of the expense in YYYY-MM-DD format\"], amount: Annotated[float, \"Positive numeric amount of the expense\"], description: Annotated[str, \"Human-readable description of the expense\"], ctx: Context, ): \"\"\"Add a new expense to Cosmos DB.\"\"\" user_id = ctx.get_state(\"user_id\") if not user_id: return \"Error: Authentication required (no user_id present)\" expense_item = { \"id\": str(uuid.uuid4()), \"user_id\": user_id, \"date\": date.isoformat(), \"amount\": amount, \"description\": description } await cosmos_container.create_item(body=expense_item)\n\n```\n\n### Using OBO flow in FastMCP server\n\nNow we can move on to using an OBO flow inside an MCP tool, to access the Graph API on behalf of the user.\n\nTo make it easy to exchange Entra tokens for Graph tokens, we use the [Python MSAL SDK](https://learn.microsoft.com/entra/msal/python/), configuring a `ConfidentialClientApplication ` based on our Entra app registration details:\n\n``` confidential_client = ConfidentialClientApplication( client_id=os.environ[\"ENTRA_PROXY_AZURE_CLIENT_ID\"], client_credential=os.environ[\"ENTRA_PROXY_AZURE_CLIENT_SECRET\"], authority=f\"https://login.microsoftonline.com/{os.environ['AZURE_TENANT_ID']}\", token_cache=TokenCache(), ) ```\n\nInside the tool that requires OBO, we ask MSAL to exchange the MCP access token for a Graph API access token:\n\n``` access_token = get_access_token() graph_resource_access_token = confidential_client.acquire_token_on_behalf_of( user_assertion=access_token.token, scopes=[\"https://graph.microsoft.com/.default\"] ) graph_token = graph_resource_access_token[\"access_token\"]\n\n```\n\nOnce we successfully acquire the token, we can use that token with the Graph API, for any operations permitted by the scopes in the admin consent granted earlier.\n\nFor this example, we call the Graph API to check whether the logged in user is a member of a particular Entra group, and restrict tool usage if not:\n\n``` async with httpx.AsyncClient() as client: url = (\"https://graph.microsoft.com/v1.0/me/transitiveMemberOf/microsoft.graph.group\" f\"?$filter=id eq '{group_id}'&$count=true\") response = await client.get( url, headers={ \"Authorization\": f\"Bearer {graph_token}\", \"ConsistencyLevel\": \"eventual\", }) data = response.json() membership_count = data.get(\"@odata.count\", 0)\n\n```\n\nYou could imagine many other ways to use an OBO flow however, like to query for more details from the Graph API, upload documents to OneDrive/SharePoint/Notes, send emails, and more!\n\n## All together now\n\nFor the full code, check out the open source [python-mcp-demos repository](https://github.com/Azure-Samples/python-mcp-demos), and follow the deployment steps for Entra. The most relevant code files are:\n\n- [auth_init.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/infra/auth_init.py): Creates the Entra app registration, service principal, client secret, and grants admin consent for OBO flow.\n- [auth_update.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/infra/auth_update.py): Updates the app registration's redirect URIs after deployment, adding the deployed server URL.\n- [auth_entra_mcp.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/servers/auth_entra_mcp.py): The MCP server itself, configured with FastMCP's AzureProvider and tools that use OBO for group membership checks.\n\nAs always, please let us know if you have further questions or ideas for other Entra integrations.\n\n*Acknowledgements: Thank you to Matt Gotteiner for his guidance in implementing the OBO flow and review of the blog post.*\n\nUpdated Jan 17, 2026\n\nVersion 1.0\n\n[mcp](/tag/mcp?nodeId=board%3AAzureDevCommunityBlog)\n\n[pamela fox](/tag/pamela%20fox?nodeId=board%3AAzureDevCommunityBlog)\n\n[python](/tag/python?nodeId=board%3AAzureDevCommunityBlog)\n\n[!\\[Pamela_Fox&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/dS0xNjA0MDc4LTQxODI4MWk5MjkyQjFBMEVGOUE5NkM5?image-dimensions=50x50)](/users/pamela_fox/1604078) [Pamela_Fox](/users/pamela_fox/1604078) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined November 08, 2022\n\n[View Profile](/users/pamela_fox/1604078)\n\n/category/azure/blog/azuredevcommunityblog [Microsoft Developer Community Blog](/category/azure/blog/azuredevcommunityblog) Follow this blog board to get notified when there's new activity",
  "FeedName": "Microsoft Tech Community",
  "Title": "Using on-behalf-of flow for Entra-based MCP servers",
  "Tags": [],
  "ProcessedDate": "2026-01-19 08:03:33",
  "OutputDir": "_community",
  "PubDate": "2026-01-19T08:00:00+00:00",
  "Description": "In December, we presented a [series about MCP](https://aka.ms/pythonmcp/rewatch), culminating in a session about adding authentication to MCP servers. I demoed a Python MCP server that uses [Microsoft Entra](https://learn.microsoft.com/entra/fundamentals/whatis) for authentication, requiring users to first login to the Microsoft tenant before they could use a tool. Many developers asked how they could take the Entra integration further, like to check the user's group membership or query their OneDrive. That requires using an [\"on-behalf-of\" flow](https://learn.microsoft.com/entra/identity-platform/v2-oauth2-on-behalf-of-flow), where the MCP server uses the user's Entra identity to call another API, like the [Microsoft Graph API](https://learn.microsoft.com/graph/overview). In this blog post, I will explain how to use Entra with OBO flow in a Python FastMCP server.\n\n## How MCP servers can use Entra authentication\n\nThe [MCP authorization specification](https://modelcontextprotocol.io/specification/2025-11-25/basic/authorization) is based on OAuth2, with some additional features tacked on top.\n\nEvery **MCP client** is actually an **OAuth2 client**, and each **MCP server** is an **OAuth2 resource server:**\n\n![Diagram of OAuth 2.1 entities with MCP client and server](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7Qdgfkeqg2qCt7YgP399vUPvLsINoQ-tsU_uiLLgqWIP1fP5vSL19uuJFCdkc5GYa7dMDhR1Qe2gCBfmlRDF2nGNTajwXy6o8P-DKL5Yav97Z21KY9K1ZwN4RQgQorh-Iwu-Ck5Ciwc2J_DB1XaHUaChLQqjiczmCEY_5QcUeV9uCXCV-FbRUBylNfg/s1600/Screenshot%202026-01-16%20at%2012.13.34%E2%80%AFPM.png)\n\nMCP auth adds these features to help clients determine how to authorize a server:\n\n- **Protected resource metadata (PRM):** Implemented on the MCP server, provides details about the authorization server and method\n- **Authorization server metadata:** Implemented on the authorization server, gives URLs for OAuth2 endpoints\n\nAdditionally, to allow MCP servers to work with arbitrary MCP clients, MCP auth supports either of these client registration methods:\n\n- **Dynamic Client Registration (DCR):** Implemented on the authorization server, it can register new MCP clients as OAuth2 clients, even if it hasn't seen them before.\n- **Client ID Metadata Documents (CIMD):** An alternative to DCR, this requires both the MCP client to make a CIMD document available on a server, and requires the authorization server to fetch the CIMD document for details about the client.\n\nMicrosoft Entra does support authorization server metadata, but it does *not* support either DCR or CIMD. That's actually fine if you are building an MCP server that's only going to be used with pre-authorized clients, like if the server will only be used with VS Code or with a specific internal MCP client. But, if you are building an MCP server that can be used with arbitrary MCP clients, then either DCR or CIMD is required. So what do we do?\n\nFortunately, the [FastMCP](https://gofastmcp.com/) SDK implements [DCR on top of Entra](https://gofastmcp.com/integrations/azure) using an OAuth proxy pattern. FastMCP acts as the authorization server, intercepting requests and forwarding to Entra when needed, and storing OAuth client information in a designated database (like in-memory or [Cosmos DB](https://learn.microsoft.com/azure/cosmos-db/introduction)).\n\n![Diagram of OAuth proxy pattern](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgiASwccA1SpE3eIhgi7_lQcwo3gPOkYFwQtGedSx19qw3Nxmiz07XWRlafkzHz8V7ATYspcj64kN5bwY24H8TDIPK_Kbf21CNQSj8E23dOM7ja3gd39Wq9fcf86RO8a6e1kkhtVykNhDGTD8FZeVROeASl_dFSR6wa9VtLZpmJeb_fthjdl05cj9a-Cw/s1600/Screenshot%202026-01-16%20at%2010.10.23%E2%80%AFAM.png)\n\nLet's walk through the steps to set that up.\n\n## Registering the server with Entra\n\nBefore the server can use Entra to authorize users, we need to register the server with Entra via an app registration. We can do registration using the Azure Portal, Azure CLI, Microsoft Graph SDK, or even Bicep. In this demo, I use the [Python MS Graph SDK](https://github.com/microsoftgraph/msgraph-sdk-python) as it allows me to specify everything programmatically.\n\nFirst, I create the Entra app registration, specifying the sign-in audience (single-tenant), redirect URIs (including local MCP server, deployed MCP server, and VS Code redirect URIs), and the scopes for the exposed API.\n\n- request\\_app = Application(\ndisplay\\_name=\"FastMCP Server App\", sign\\_in\\_audience=\"AzureADMyOrg\", # Single tenant web=WebApplication( redirect\\_uris=[ \"http://localhost:8000/auth/callback\", \"https://vscode.dev/redirect\", \"http://127.0.0.1:33418\", \"https://deployedurl.com/auth/callback\" ], ), api=ApiApplication( oauth2\\_permission\\_scopes=[ PermissionScope( id=uuid.UUID(\"{\" + str(uuid.uuid4()) + \"}\"), admin\\_consent\\_display\\_name=\"Access FastMCP Server\", admin\\_consent\\_description=\"Allows access to the FastMCP server as the signed-in user.\", user\\_consent\\_display\\_name=\"Access FastMCP Server\", user\\_consent\\_description=\"Allow access to the FastMCP server on your behalf\", is\\_enabled=True, value=\"mcp-access\", type=\"User\", )], requested\\_access\\_token\\_version=2, # Required by FastMCP ) ) app = await graph\\_client.applications.post(request\\_app)\n\nawait graph\\_client.applications.by\\_application\\_id(app.id).patch( Application(identifier\\_uris=[f\"api://{app.app\\_id}\"]))\n\nThanks to that configuration, when an MCP client like VS Code requests an OAuth2 token, it will request a token with the scope \"api://{app.app\\_id}/mcp-access\", and the FastMCP server will validate that incoming tokens contain that scope.\n\nNext, I create a [Service Principal](https://learn.microsoft.com/entra/identity-platform/app-objects-and-service-principals?tabs=browser) for that Entra app registration, which represents the Entra app in my tenant\n- request\\_principal = ServicePrincipal(app\\_id=app.app\\_id, display\\_name=app.display\\_name)\nawait graph\\_client.service\\_principals.post(request\\_principal)\n\nI need a way for the server to prove that it can use that Entra app registration, so I register a secret:\n- password\\_credential = await graph\\_client.applications.by\\_application\\_id(app.id).add\\_password.post(\nAddPasswordPostRequestBody( password\\_credential=PasswordCredential(display\\_name=\"FastMCPSecret\")))\n\nIdeally, I would like to move away from secrets, as Entra now has support for using [federated identity credentials](https://learn.microsoft.com/entra/workload-id/workload-identity-federation-config-app-trust-managed-identity) for Entra app registrations instead, but that form of credential isn't supported yet in the FastMCP SDK. If you choose to use a secret, make sure that you store the secret securely.\n\n### Granting admin consent\n\nThis next step is only necessary when our MCP server wants to use an OBO flow to exchange access tokens for other resource server tokens (Graph API tokens, in this case).\n\nFor the OBO flow to work, the Entra app registration needs permission to call the Graph API on behalf of users. *If* we controlled the client, we could force it to request the required scopes as part of the initial login dialog. However, since we are configuring this server to work with *arbitrary* MCP clients, we don't have that option.\n\nInstead, we grant [admin consent](https://learn.microsoft.com/entra/identity-platform/v2-oauth2-on-behalf-of-flow#admin-consent) to the Entra app for the necessary scopes, such that no Graph API consent dialog is needed.\n\nThis code grants admin consent to the associated service principal for the Graph API resource and scopes:\n- server\\_principal = await graph\\_client.service\\_principals\\_with\\_app\\_id(app.app\\_id).get()\ngrant = GrantDefinition( principal\\_id=server\\_principal.id, resource\\_app\\_id=\"00000003-0000-0000-c000-000000000000\", # Graph API scopes=[\"User.Read\", \"email\", \"offline\\_access\", \"openid\", \"profile\"], target\\_label=\"server application\") resource\\_principal = await graph\\_client.service\\_principals\\_with\\_app\\_id(grant.resource\\_app\\_id).get() desired\\_scope = grant.scope\\_string() await graph\\_client.oauth2\\_permission\\_grants.post( OAuth2PermissionGrant( client\\_id=grant.principal\\_id, consent\\_type=\"AllPrincipals\", resource\\_id=resource\\_principal.id, scope=desired\\_scope))\n\nIf our MCP server needed to use an OBO flow with another resource server, we could request additional grants for those resources and scopes.\n\nOur Entra app registration is now ready for the MCP server, so let's move on to see the server code.\n\n## Using FastMCP servers with Entra\n\nIn our MCP server code, we configure FastMCP's built in [AzureProvider](https://gofastmcp.com/integrations/azure) based off the details from the Entra app registration process:\n- auth = AzureProvider(\nclient\\_id=os.environ[\"ENTRA\\_PROXY\\_AZURE\\_CLIENT\\_ID\"], client\\_secret=os.environ[\"ENTRA\\_PROXY\\_AZURE\\_CLIENT\\_SECRET\"], tenant\\_id=os.environ[\"AZURE\\_TENANT\\_ID\"], base\\_url=entra\\_base\\_url, # MCP server URL required\\_scopes=[\"mcp-access\"], client\\_storage=oauth\\_client\\_store, # in-memory or Cosmos DB )\n\nTo make it easy for our MCP tools to access an identifier for the currently logged in user, we define a middleware that inspects the claims of the current token using FastMCP's `get_access_token()` and sets the \"oid\" (Entra object identifier) in the state:\n- class UserAuthMiddleware(Middleware):\ndef \\_get\\_user\\_id(self): token = get\\_access\\_token() if not (token and hasattr(token, \"claims\")): return None return token.claims.get(\"oid\")\n\nasync def on\\_call\\_tool(self, context: MiddlewareContext, call\\_next): user\\_id = self.\\_get\\_user\\_id() if context.fastmcp\\_context is not None: context.fastmcp\\_context.set\\_state(\"user\\_id\", user\\_id) return await call\\_next(context)\n\nasync def on\\_read\\_resource(self, context: MiddlewareContext, call\\_next): user\\_id = self.\\_get\\_user\\_id() if context.fastmcp\\_context is not None: context.fastmcp\\_context.set\\_state(\"user\\_id\", user\\_id) return await call\\_next(context)\n\nWhen we initialize the FastMCP server, we set the auth provider and include that middleware:\n- mcp = FastMCP(\"Expenses Tracker\",\nauth=auth, middleware=[UserAuthMiddleware()])\n\nNow, every request made to the MCP server will require authentication. The server will return a 401 if a valid token isn't provided, and that 401 will prompt the MCP client to kick off the MCP authorization flow.\n\nInside each tool, we can grab the user id from the state, and use that to customize the response for the user, like to store or query items in a database.\n- .tool\nasync def add\\_user\\_expense( date: Annotated[date, \"Date of the expense in YYYY-MM-DD format\"], amount: Annotated[float, \"Positive numeric amount of the expense\"], description: Annotated[str, \"Human-readable description of the expense\"], ctx: Context, ): \"\"\"Add a new expense to Cosmos DB.\"\"\" user\\_id = ctx.get\\_state(\"user\\_id\") if not user\\_id: return \"Error: Authentication required (no user\\_id present)\" expense\\_item = { \"id\": str(uuid.uuid4()), \"user\\_id\": user\\_id, \"date\": date.isoformat(), \"amount\": amount, \"description\": description } await cosmos\\_container.create\\_item(body=expense\\_item)\n\n### Using OBO flow in FastMCP server\n\nNow we can move on to using an OBO flow inside an MCP tool, to access the Graph API on behalf of the user.\n\n![]()\n\nTo make it easy to exchange Entra tokens for Graph tokens, we use the [Python MSAL SDK](https://learn.microsoft.com/entra/msal/python/), configuring a `ConfidentialClientApplication ` based on our Entra app registration details:\n- confidential\\_client = ConfidentialClientApplication(\nclient\\_id=os.environ[\"ENTRA\\_PROXY\\_AZURE\\_CLIENT\\_ID\"], client\\_credential=os.environ[\"ENTRA\\_PROXY\\_AZURE\\_CLIENT\\_SECRET\"], authority=f\"https://login.microsoftonline.com/{os.environ['AZURE\\_TENANT\\_ID']}\", token\\_cache=TokenCache(), )\n\nInside the tool that requires OBO, we ask MSAL to exchange the MCP access token for a Graph API access token:\n- access\\_token = get\\_access\\_token()\ngraph\\_resource\\_access\\_token = confidential\\_client.acquire\\_token\\_on\\_behalf\\_of( user\\_assertion=access\\_token.token, scopes=[\"https://graph.microsoft.com/.default\"] ) graph\\_token = graph\\_resource\\_access\\_token[\"access\\_token\"]\n\nOnce we successfully acquire the token, we can use that token with the Graph API, for any operations permitted by the scopes in the admin consent granted earlier.\n\nFor this example, we call the Graph API to check whether the logged in user is a member of a particular Entra group, and restrict tool usage if not:\n- async with httpx.AsyncClient() as client:\nurl = (\"https://graph.microsoft.com/v1.0/me/transitiveMemberOf/microsoft.graph.group\" f\"?$filter=id eq '{group\\_id}'&$count=true\") response = await client.get( url, headers={ \"Authorization\": f\"Bearer {graph\\_token}\", \"ConsistencyLevel\": \"eventual\", }) data = response.json() membership\\_count = data.get(\"@odata.count\", 0)\n\nYou could imagine many other ways to use an OBO flow however, like to query for more details from the Graph API, upload documents to OneDrive/SharePoint/Notes, send emails, and more!\n\n## All together now\n\nFor the full code, check out the open source [python-mcp-demos repository](https://github.com/Azure-Samples/python-mcp-demos), and follow the deployment steps for Entra. The most relevant code files are:\n\n- [auth_init.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/infra/auth_init.py): Creates the Entra app registration, service principal, client secret, and grants admin consent for OBO flow.\n- [auth_update.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/infra/auth_update.py): Updates the app registration's redirect URIs after deployment, adding the deployed server URL.\n- [auth_entra_mcp.py](https://github.com/Azure-Samples/python-mcp-demos/blob/main/servers/auth_entra_mcp.py): The MCP server itself, configured with FastMCP's AzureProvider and tools that use OBO for group membership checks.\n\nAs always, please let us know if you have further questions or ideas for other Entra integrations.\n\n*Acknowledgements: Thank you to Matt Gotteiner for his guidance in implementing the OBO flow and review of the blog post.*",
  "FeedLevelAuthor": "rss.livelink.threads-in-node"
}
