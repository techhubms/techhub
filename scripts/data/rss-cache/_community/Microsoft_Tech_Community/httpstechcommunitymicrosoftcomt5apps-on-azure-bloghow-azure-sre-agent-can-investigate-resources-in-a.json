{
  "ProcessedDate": "2026-02-17 23:06:10",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "Link": "https://techcommunity.microsoft.com/t5/apps-on-azure-blog/how-azure-sre-agent-can-investigate-resources-in-a-private/ba-p/4494911",
  "Author": "dbandaru",
  "OutputDir": "_community",
  "FeedLevelAuthor": "rss.livelink.threads-in-node",
  "EnhancedContent": "## Learn how Azure SRE Agent can query Log Analytics workspaces protected by Private Link (AMPLS) using an Azure Function proxy pattern with Easy Auth authentication.\n\n> >\n> **⚠️ Important Note on Network Communication**: In this pattern, Azure SRE Agent communicates over the **public network** to reach the Azure Function proxy. The proxy endpoint is secured with Easy Auth (Microsoft Entra ID) and only authenticated callers can invoke it. We are also actively working on enabling **SRE Agent to be injected directly into private networks**, which will eliminate the need for a public proxy altogether. Stay tuned for updates on private network injection support.\n> >\n\n## TL;DR\n\nWhen you configure Azure Monitor Private Link Scope (AMPLS) with `publicNetworkAccessForQuery: Disabled` , all public queries to your Log Analytics Workspace are blocked. To enable Azure SRE Agent to query these protected workspaces, deploy **Azure Functions inside your VNet** as a secure query proxy.\n\n> >\n> **What We Built**: This sample deploys to a **single subscription** with two resource groups (`rg-originations-*`\n> and `rg-workload-*`\n> ). The same pattern works identically across subscriptions. Simply deploy each resource group to a different subscription.\n> >\n\n## Why Public Queries Get Blocked\n\nMany organizations secure their Log Analytics Workspaces using **Azure Monitor Private Link Scope (AMPLS)** with Private Endpoints. This is a best practice for compliance and data security, but it means all public queries are blocked.\n\n| Resource Type | Can Live in VNet? | How to Access Privately | | --- | --- | --- | | Virtual Machine | Yes | Direct (it has a NIC) | | Container App | Yes | VNet integration | | Azure SQL | No | Private Endpoint | | Storage Account | No | Private Endpoint | | **Log Analytics Workspace** | **No** | **AMPLS + Private Endpoint** |\n\nWhen you configure `publicNetworkAccessForQuery: Disabled` on the workspace and `queryAccessMode: PrivateOnly` on the AMPLS, any query that does not come through a Private Endpoint is rejected. This includes queries from Azure SRE Agent, which runs as a cloud service outside your VNet.\n\n## The Architecture\n\nTwo resource groups: `rg-originations-ampls-demo` (LAW + AMPLS, query access disabled) and `rg-workload-ampls-demo` (VNet + Private Endpoint + Function). This pattern works across subscriptions with cross-subscription RBAC for the Function's Managed Identity.\n\n## The Problem: Blocked Queries\n\nWhen you configure AMPLS with private-only query access, any attempt to query from outside the VNet fails:\n\n``` InsufficientAccessError: The query was blocked due to private link\n2. configuration. Access is denied because this request was not made\n3. through a private endpoint.\n```\n\nThis is the expected behavior. But it means Azure SRE Agent (which runs as a cloud service, not inside your VNet) cannot directly query these workspaces.\n\n## The Solution: Azure Functions as Query Proxy\n\nDeploy **Azure Functions inside the workload VNet**. This serverless proxy:\n\n| Capability | Description | | --- | --- | | **Runs inside VNet** | VNet-integrated with `vnetRouteAllEnabled: true` | | **Uses Managed Identity** | Authenticates to LAW via Azure RBAC | | **Exposes HTTPS endpoints** | SRE Agent calls as custom HTTP tools | | **Proxies queries** | Transforms API calls into KQL queries | | **Serverless scaling** | Pay only when queries are executed |\n\n## Why This Pattern Works\n\n**Data ingestion** and **query access** use different network paths:\n\n| Operation | Direction | Network | Status | | --- | --- | --- | --- | | Log Ingestion | AMA → Private Endpoint → LAW | Private | Works | | External Query | Public Internet → LAW | Public | Blocked | | VNet Query | VNet → Private Endpoint → LAW | Private | Works | | SRE Agent Query | HTTPS → Function → PE → LAW | Hybrid | Works |\n\nThe Azure Function acts as a **bridge** between two networks: (1) Public side with HTTPS endpoint for SRE Agent, (2) Private side with VNet integration routing all outbound traffic through the Private Endpoint. This is why the pattern works. The Function \"translates\" public API calls into private network queries.\n\n## Setting Up the Architecture\n\n### Step 1: Configure the Originations LAW\n\n``` az monitor log-analytics workspace create --resource-group originations-rg --workspace-name originations-law --location eastus\n4. az monitor log-analytics workspace update --resource-group originations-rg --workspace-name originations-law --set properties.publicNetworkAccessForQuery=Disabled\n```\n\n### Step 2: Create the Azure Monitor Private Link Scope\n\n``` az monitor private-link-scope create --name originations-ampls --resource-group originations-rg\n5. # ... (see full sample on GitHub)\n```\n\n### Step 3: Create the Private Endpoint in Workload Resource Group\n\n``` az network private-endpoint create --name pe-ampls --resource-group rg-workload-ampls-demo --vnet-name vnet-workload-ampls-demo --subnet endpoints --private-connection-resource-id \"/subscriptions/.../resourceGroups/rg-originations-ampls-demo/providers/Microsoft.Insights/privateLinkScopes/ampls-originations-ampls-demo\" --group-id azuremonitor --connection-name ampls-connection ```\n\n### Step 4: Deploy the Azure Function\n\n``` az functionapp plan create --name plan-law-query --resource-group workload-rg --location eastus --sku EP1 --is-linux true\n6. az functionapp create --name func-law-query --resource-group workload-rg --plan plan-law-query --runtime python --runtime-version 3.11 --functions-version 4 --assign-identity '[system]'\n7. # ... (see full sample on GitHub)\n```\n\n### Step 5: Configure Easy Auth (Microsoft Entra ID) on the Function App\n\nInstead of function keys, we secure the Azure Function with **Easy Auth** (Microsoft Entra ID authentication). This eliminates the need to manage secrets. The SRE Agent authenticates using its Managed Identity.\n\n#### 5a. Set Function Auth Level to Anonymous\n\nSince Easy Auth handles authentication at the platform level, set `authLevel` to `anonymous` in each `function.json` :\n\n``` {\n8. \"scriptFile\": \"__init__.py\",\n9. \"bindings\": [\n10. {\"authLevel\": \"anonymous\", \"type\": \"httpTrigger\", \"direction\": \"in\", \"name\": \"req\", \"methods\": [\"get\", \"post\"]},\n11. {\"type\": \"http\", \"direction\": \"out\", \"name\": \"$return\"}\n12. ]\n13. }\n```\n\n#### 5b. Enable Easy Auth via Azure Portal\n\n1. Navigate to your **Function App** in the Azure Portal\n2. Go to **Settings** → **Authentication**\n3. Click **Add identity provider** and select **Microsoft**\n4. Configure: Create new app registration, Current tenant, Federated identity credential, Require authentication, HTTP 401 for unauthenticated\n5. Add the SRE Agent's Managed Identity Client ID under **Allowed client applications**\n6. Note the **Application (client) ID** for PythonTool configuration\n\n#### Finding the SRE Agent Managed Identity Client ID\n\n**Option 1: Azure Portal:** Navigate to your SRE Agent → Settings → Identity → copy the Client ID under System assigned or User assigned.\n\n**Option 2: Azure CLI:**\n\n``` az containerapp show --name <YOUR-SRE-AGENT-NAME> --resource-group <YOUR-SRE-AGENT-RG> --query \"identity.userAssignedIdentities\" -o json ```\n\n#### 5c. Deploy SRE Agent Tools (PythonTools with Easy Auth)\n\n**Critical**: PythonTools must use `def main(**kwargs)` . Each tool acquires a Bearer Token from the SRE Agent's Managed Identity via IDENTITY\\_ENDPOINT and calls the Azure Function endpoints. See sample repository for full subagent definition and tool implementations.\n\n#### How Easy Auth Token Acquisition Works\n\n1. **PythonTool** reads `IDENTITY_ENDPOINT`\nand `IDENTITY_HEADER` environment variables (set automatically by the SRE Agent runtime)\n2. **PythonTool** calls the identity endpoint with `resource=api://<app-id>`\nto get a Bearer Token\n3. **PythonTool** includes the token in the `Authorization: Bearer <token>`\nheader\n4. **Easy Auth** validates the token against the App Registration\n5. **Function App** executes the query using its Managed Identity\n\n> >\n> **No secrets required**: Unlike function keys, Easy Auth uses Managed Identity tokens that are automatically rotated and never stored in code or configuration.\n> >\n\n## The Investigation Flow\n\n| Step | Actor | Action | | --- | --- | --- | | 1 | **You** | \"There are errors on my workload VMs. Investigate.\" | | 2 | **SRE Agent** | Calls Azure Function's `query_logs`<br> endpoint | | 3 | **Azure Function** | Queries LAW via Private Endpoint | | 4 | **Log Analytics** | Returns results (allowed, since request came from PE) | | 5 | **Azure Function** | Returns JSON response to SRE Agent | | 6 | **SRE Agent** | Analyzes logs, identifies root cause, responds |\n\n## Security Considerations\n\n| Concern | How It's Secured | | --- | --- | | **Log Analytics** | Public query access disabled, Private Link only | | **Private Endpoint** | In isolated subnet with NSG rules | | **Azure Function** | Managed Identity for LAW access (no secrets) | | **API Authentication** | Easy Auth (Microsoft Entra ID) with Bearer Token, no secrets to manage | | **VNet Routing** | `vnetRouteAllEnabled: true`<br> for all traffic | | **Audit Trail** | All invocations logged in Application Insights |\n\n## Try It Yourself\n\n``` git clone https://github.com/BandaruDheeraj/private-law-query-sample cd private-law-query-sample azd up\n# See Step 5 for Easy Auth configuration\n./inject-failure.ps1 ```\n\nThis creates: `rg-originations-{env}` (LAW + AMPLS) and `rg-workload-{env}` (VNet + PE + Functions + VMs)\n\n## Key Takeaways\n\n**AMPLS blocks public queries by design:** When you configure Private Link with private-only query access, all external queries are rejected. This is the expected security behavior.\n\n**Azure Functions provide a serverless query proxy:** VNet-integrated Functions with Managed Identity can query private Log Analytics on behalf of SRE Agent.\n\n**Resource groups simulate cross-subscription:** This sample uses two resource groups; the same pattern works across subscriptions.\n\n**Easy Auth eliminates secret management:** Using Microsoft Entra ID authentication instead of function keys means no secrets to rotate or store.\n\n**Security is maintained end-to-end:** The workspace remains fully private; only the trusted Function can query it. The SRE Agent authenticates with its Managed Identity.\n\n## Resources\n\n| Resource | Link | | --- | --- | | **Sample Repository** | github.com/BandaruDheeraj/private-law-query-sample | | Azure Monitor Private Link | docs.microsoft.com/azure/azure-monitor/logs/private-link-security | | Azure Functions VNet Integration | docs.microsoft.com/azure/azure-functions/functions-networking-options | | AMPLS Design Guidance | docs.microsoft.com/azure/azure-monitor/logs/private-link-design | | Managed Identity for Azure Functions | docs.microsoft.com/azure/app-service/overview-managed-identity | | Azure Developer CLI (azd) | learn.microsoft.com/azure/developer/azure-developer-cli |\n\nUpdated Feb 17, 2026\n\nVersion 1.0\n\n[azure functions](/tag/azure%20functions?nodeId=board%3AAppsonAzureBlog)\n\n[azure sre agent](/tag/azure%20sre%20agent?nodeId=board%3AAppsonAzureBlog)\n\n[!\\[dbandaru&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/dS0xODc2Mjc5LTU4NDM2OWk2MjcxQjY2RTZCMEQzMDkw?image-dimensions=50x50)](/users/dbandaru/1876279) [dbandaru](/users/dbandaru/1876279) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined May 24, 2023\n\n[View Profile](/users/dbandaru/1876279)\n\n/category/azure/blog/appsonazureblog [Apps on Azure Blog](/category/azure/blog/appsonazureblog) Follow this blog board to get notified when there's new activity",
  "FeedName": "Microsoft Tech Community",
  "Tags": [],
  "Description": "> >\n> **⚠️ Important Note on Network Communication**: In this pattern, Azure SRE Agent communicates over the **public network** to reach the Azure Function proxy. The proxy endpoint is secured with Easy Auth (Microsoft Entra ID) and only authenticated callers can invoke it. We are also actively working on enabling **SRE Agent to be injected directly into private networks**, which will eliminate the need for a public proxy altogether. Stay tuned for updates on private network injection support.\n> >\n\n## TL;DR\n\nWhen you configure Azure Monitor Private Link Scope (AMPLS) with `publicNetworkAccessForQuery: Disabled` , all public queries to your Log Analytics Workspace are blocked. To enable Azure SRE Agent to query these protected workspaces, deploy **Azure Functions inside your VNet** as a secure query proxy.\n\n> >\n> **What We Built**: This sample deploys to a **single subscription** with two resource groups (`rg-originations-*`\n> and `rg-workload-*`\n> ). The same pattern works identically across subscriptions. Simply deploy each resource group to a different subscription.\n> >\n\n## Why Public Queries Get Blocked\n\nMany organizations secure their Log Analytics Workspaces using **Azure Monitor Private Link Scope (AMPLS)** with Private Endpoints. This is a best practice for compliance and data security, but it means all public queries are blocked.\n\n| Resource Type | Can Live in VNet? | How to Access Privately | | --- | --- | --- | | Virtual Machine | Yes | Direct (it has a NIC) | | Container App | Yes | VNet integration | | Azure SQL | No | Private Endpoint | | Storage Account | No | Private Endpoint | | **Log Analytics Workspace** | **No** | **AMPLS + Private Endpoint** |\n\nWhen you configure `publicNetworkAccessForQuery: Disabled` on the workspace and `queryAccessMode: PrivateOnly` on the AMPLS, any query that does not come through a Private Endpoint is rejected. This includes queries from Azure SRE Agent, which runs as a cloud service outside your VNet.\n\n## The Architecture\n\nTwo resource groups: `rg-originations-ampls-demo` (LAW + AMPLS, query access disabled) and `rg-workload-ampls-demo` (VNet + Private Endpoint + Function). This pattern works across subscriptions with cross-subscription RBAC for the Function's Managed Identity.\n\n## The Problem: Blocked Queries\n\nWhen you configure AMPLS with private-only query access, any attempt to query from outside the VNet fails:\n\n``` InsufficientAccessError: The query was blocked due to private link\n2. configuration. Access is denied because this request was not made\n3. through a private endpoint.\n```\n\nThis is the expected behavior. But it means Azure SRE Agent (which runs as a cloud service, not inside your VNet) cannot directly query these workspaces.\n\n## The Solution: Azure Functions as Query Proxy\n\nDeploy **Azure Functions inside the workload VNet**. This serverless proxy:\n\n| Capability | Description | | --- | --- | | **Runs inside VNet** | VNet-integrated with `vnetRouteAllEnabled: true` | | **Uses Managed Identity** | Authenticates to LAW via Azure RBAC | | **Exposes HTTPS endpoints** | SRE Agent calls as custom HTTP tools | | **Proxies queries** | Transforms API calls into KQL queries | | **Serverless scaling** | Pay only when queries are executed |\n\n## Why This Pattern Works\n\n**Data ingestion** and **query access** use different network paths:\n\n| Operation | Direction | Network | Status | | --- | --- | --- | --- | | Log Ingestion | AMA → Private Endpoint → LAW | Private | Works | | External Query | Public Internet → LAW | Public | Blocked | | VNet Query | VNet → Private Endpoint → LAW | Private | Works | | SRE Agent Query | HTTPS → Function → PE → LAW | Hybrid | Works |\n\nThe Azure Function acts as a **bridge** between two networks: (1) Public side with HTTPS endpoint for SRE Agent, (2) Private side with VNet integration routing all outbound traffic through the Private Endpoint. This is why the pattern works. The Function \"translates\" public API calls into private network queries.\n\n## Setting Up the Architecture\n\n### Step 1: Configure the Originations LAW\n\n``` az monitor log-analytics workspace create --resource-group originations-rg --workspace-name originations-law --location eastus\n4. az monitor log-analytics workspace update --resource-group originations-rg --workspace-name originations-law --set properties.publicNetworkAccessForQuery=Disabled\n```\n\n### Step 2: Create the Azure Monitor Private Link Scope\n\n``` az monitor private-link-scope create --name originations-ampls --resource-group originations-rg\n5. # ... (see full sample on GitHub)\n```\n\n### Step 3: Create the Private Endpoint in Workload Resource Group\n\n``` az network private-endpoint create --name pe-ampls --resource-group rg-workload-ampls-demo --vnet-name vnet-workload-ampls-demo --subnet endpoints --private-connection-resource-id \"/subscriptions/.../resourceGroups/rg-originations-ampls-demo/providers/Microsoft.Insights/privateLinkScopes/ampls-originations-ampls-demo\" --group-id azuremonitor --connection-name ampls-connection ```\n\n### Step 4: Deploy the Azure Function\n\n``` az functionapp plan create --name plan-law-query --resource-group workload-rg --location eastus --sku EP1 --is-linux true\n6. az functionapp create --name func-law-query --resource-group workload-rg --plan plan-law-query --runtime python --runtime-version 3.11 --functions-version 4 --assign-identity '[system]'\n7. # ... (see full sample on GitHub)\n```\n\n### Step 5: Configure Easy Auth (Microsoft Entra ID) on the Function App\n\nInstead of function keys, we secure the Azure Function with **Easy Auth** (Microsoft Entra ID authentication). This eliminates the need to manage secrets. The SRE Agent authenticates using its Managed Identity.\n\n#### 5a. Set Function Auth Level to Anonymous\n\nSince Easy Auth handles authentication at the platform level, set `authLevel` to `anonymous` in each `function.json` :\n\n``` {\n8. \"scriptFile\": \"__init__.py\",\n9. \"bindings\": [\n10. {\"authLevel\": \"anonymous\", \"type\": \"httpTrigger\", \"direction\": \"in\", \"name\": \"req\", \"methods\": [\"get\", \"post\"]},\n11. {\"type\": \"http\", \"direction\": \"out\", \"name\": \"$return\"}\n12. ]\n13. }\n```\n\n#### 5b. Enable Easy Auth via Azure Portal\n\n1. Navigate to your **Function App** in the Azure Portal\n2. Go to **Settings** → **Authentication**\n3. Click **Add identity provider** and select **Microsoft**\n4. Configure: Create new app registration, Current tenant, Federated identity credential, Require authentication, HTTP 401 for unauthenticated\n5. Add the SRE Agent's Managed Identity Client ID under **Allowed client applications**\n6. Note the **Application (client) ID** for PythonTool configuration\n\n#### Finding the SRE Agent Managed Identity Client ID\n\n**Option 1: Azure Portal:** Navigate to your SRE Agent → Settings → Identity → copy the Client ID under System assigned or User assigned.\n\n**Option 2: Azure CLI:**\n\n``` az containerapp show --name --resource-group --query \"identity.userAssignedIdentities\" -o json ```\n\n#### 5c. Deploy SRE Agent Tools (PythonTools with Easy Auth)\n\n**Critical**: PythonTools must use `def main(**kwargs)` . Each tool acquires a Bearer Token from the SRE Agent's Managed Identity via IDENTITY\\_ENDPOINT and calls the Azure Function endpoints. See sample repository for full subagent definition and tool implementations.\n\n#### How Easy Auth Token Acquisition Works\n\n1. **PythonTool** reads `IDENTITY_ENDPOINT`\nand `IDENTITY_HEADER` environment variables (set automatically by the SRE Agent runtime)\n2. **PythonTool** calls the identity endpoint with `resource=api://`\nto get a Bearer Token\n3. **PythonTool** includes the token in the `Authorization: Bearer `\nheader\n4. **Easy Auth** validates the token against the App Registration\n5. **Function App** executes the query using its Managed Identity\n\n> >\n> **No secrets required**: Unlike function keys, Easy Auth uses Managed Identity tokens that are automatically rotated and never stored in code or configuration.\n> >\n\n## The Investigation Flow\n\n| Step | Actor | Action | | --- | --- | --- | | 1 | **You** | \"There are errors on my workload VMs. Investigate.\" | | 2 | **SRE Agent** | Calls Azure Function's `query_logs`<br> endpoint | | 3 | **Azure Function** | Queries LAW via Private Endpoint | | 4 | **Log Analytics** | Returns results (allowed, since request came from PE) | | 5 | **Azure Function** | Returns JSON response to SRE Agent | | 6 | **SRE Agent** | Analyzes logs, identifies root cause, responds |\n\n## Security Considerations\n\n| Concern | How It's Secured | | --- | --- | | **Log Analytics** | Public query access disabled, Private Link only | | **Private Endpoint** | In isolated subnet with NSG rules | | **Azure Function** | Managed Identity for LAW access (no secrets) | | **API Authentication** | Easy Auth (Microsoft Entra ID) with Bearer Token, no secrets to manage | | **VNet Routing** | `vnetRouteAllEnabled: true`<br> for all traffic | | **Audit Trail** | All invocations logged in Application Insights |\n\n## Try It Yourself\n\n``` git clone https://github.com/BandaruDheeraj/private-law-query-sample cd private-law-query-sample azd up\n# See Step 5 for Easy Auth configuration\n./inject-failure.ps1 ```\n\nThis creates: `rg-originations-{env}` (LAW + AMPLS) and `rg-workload-{env}` (VNet + PE + Functions + VMs)\n\n## Key Takeaways\n\n**AMPLS blocks public queries by design:** When you configure Private Link with private-only query access, all external queries are rejected. This is the expected security behavior.\n\n**Azure Functions provide a serverless query proxy:** VNet-integrated Functions with Managed Identity can query private Log Analytics on behalf of SRE Agent.\n\n**Resource groups simulate cross-subscription:** This sample uses two resource groups; the same pattern works across subscriptions.\n\n**Easy Auth eliminates secret management:** Using Microsoft Entra ID authentication instead of function keys means no secrets to rotate or store.\n\n**Security is maintained end-to-end:** The workspace remains fully private; only the trusted Function can query it. The SRE Agent authenticates with its Managed Identity.\n\n## Resources\n\n| Resource | Link | | --- | --- | | **Sample Repository** | github.com/BandaruDheeraj/private-law-query-sample | | Azure Monitor Private Link | docs.microsoft.com/azure/azure-monitor/logs/private-link-security | | Azure Functions VNet Integration | docs.microsoft.com/azure/azure-functions/functions-networking-options | | AMPLS Design Guidance | docs.microsoft.com/azure/azure-monitor/logs/private-link-design | | Managed Identity for Azure Functions | docs.microsoft.com/azure/app-service/overview-managed-identity | | Azure Developer CLI (azd) | learn.microsoft.com/azure/developer/azure-developer-cli |",
  "PubDate": "2026-02-17T23:01:58+00:00",
  "Title": "How Azure SRE Agent Can Investigate Resources in a Private Network"
}
