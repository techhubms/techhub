{
  "EnhancedContent": "As cloud storage demands continue to grow, the need for ultra-fast, reliable networking becomes ever more critical. Microsoft Azure’s journey to empower its storage infrastructure with RDMA (Remote Direct Memory Access) has been transformative, but it’s not without challenges—especially when it comes to congestion control at scale. Azure’s deployment of RDMA at regional scale relies on DCQCN (Data Center Quantized Congestion Notification), a protocol that’s become central to Azure’s ability to deliver high-throughput, low-latency storage services across vast, heterogeneous data center regions.\n\n## Why congestion control matters in RDMA networks\n\nRDMA offloads the network stack to NIC hardware, reducing CPU overhead and enabling near line-rate performance. However, as Azure scaled RDMA across clusters and regions, it faced new challenges:\n\n- **Heterogeneous hardware:** Different generations of RDMA NICs (Network Interface Cards) and switches, each with their own quirks.\n- **Variable latency:** Long-haul links between datacenters introduce large round-trip time (RTT) variations.\n- **Congestion risks:** High-speed, incast-like traffic patterns can easily overwhelm buffers, leading to packet loss and degraded performance.\n\nTo address these, Azure needed a congestion control protocol that could operate reliably across diverse hardware and network conditions. Traditional TCP congestion control mechanisms don’t apply here, so Azure leverages **DCQCN combined with Priority Flow Control (PFC)** to maintain high throughput, low latency, and near-zero packet loss.\n\n### How DCQCN works\n\nDCQCN coordinates congestion control using three main entities:\n\n- **Reaction point (RP)**: The sender adjusts its rate based on feedback.\n- **Congestion point (CP)**: Switches mark packets using ECN when queues exceed thresholds.\n- **Notification point (NP)**: The receiver sends Congestion Notification Packets (CNPs) upon receiving ECN-marked packets.\n\nThis feedback loop allows RDMA flows to dynamically adapt their sending rates, preventing congestion collapse while maintaining fairness.\n\n- When the switch detects congestion, it marks packets with ECN.\n- The receiver NIC (NP) observes ECN marks and sends CNPs to the sender.\n- The sender NIC (RP) reduces its sending rate upon receiving CNPs; otherwise, it increases the rate gradually.\n\n### Interoperability challenges across different hardware generations\n\nCloud infrastructure evolves incrementally, typically at the level of individual clusters or racks, as newer server hardware generations are introduced. Within a single region, clusters often differ in their NIC configurations. Our deployment includes three generations of commodity RDMA NICs—Gen1, Gen2, and Gen3—each implementing DCQCN with distinct design variations. These discrepancies create complex and often problematic interactions when NICs from different generations interoperate.\n\n- **Gen1 NICs:** Firmware-based DCQCN, NP-side CNP coalescing, burst-based rate limiting.\n- **Gen2/Gen3 NICs:** Hardware-based DCQCN, RP-side CNP coalescing, per-packet rate limiting.\n\n**Problem:**\n\n- Gen2/Gen3 NICs sending to Gen1 can trigger excessive cache misses, slowing down Gen1’s receiver pipeline.\n- Gen1 sending to Gen2/Gen3 can cause excessive rate reductions due to frequent CNPs.\n\n**Azure’s solution:**\n\n- Move CNP coalescing to NP side for Gen2/Gen3.\n- Implement per-QP CNP rate limiting, matching Gen1’s timer.\n- Enable per-burst rate limiting on Gen2/Gen3 to reduce cache pressure.\n\n### DCQCN tuning: Achieving fairness and performance\n\nDCQCN is inherently **RTT-fair**—its rate adjustment is independent of round-trip time, making it suitable for Azure’s regional networks with RTTs ranging from microseconds to milliseconds.\n\n**Key Tuning Strategies:**\n\n- **Sparse ECN marking:** Use large ECN marking thresholds (K\\_max - K\\_min) and low marking probabilities (P\\_max) for flows with large RTTs.\n- **Joint buffer and DCQCN tuning:** Tune switch buffer thresholds and DCQCN parameters together to avoid premature congestion signals and optimize throughput.\n- **Global parameter settings:** Azure’s NICs support only global DCQCN settings, so parameters must work well across all traffic types and RTTs.\n\n## Real-world results\n\n- **High throughput & low latency:**\n- RDMA traffic runs at line rate with near-zero packet loss.\n- **CPU savings:**\n- Freed CPU cores can be repurposed for customer VMs or application logic.\n- **Performance metrics:**\n- RDMA reduces CPU utilization by up to 34.5% compared to TCP for storage frontend traffic.\n- Large I/O requests (1 MB) see up to 23.8% latency reduction for reads and 15.6% for writes.\n- **Scalability:**\n- As of November 2025, ~85% of Azure’s traffic is RDMA, supported in all public regions.\n\n## Conclusion\n\nDCQCN is a cornerstone of Azure’s RDMA-enabled storage infrastructure, enabling reliable, high-performance cloud storage at scale. By combining ECN-based signaling with dynamic rate adjustments, DCQCN ensures high throughput, low latency, and near-zero packet loss—even across heterogeneous hardware and long-haul links. Its interoperability fixes and careful tuning make it a critical enabler for RDMA adoption in modern data centers, paving the way for efficient, scalable, and resilient cloud storage.\n\nUpdated Jan 13, 2026\n\nVersion 1.0\n\n[azure networking](/tag/azure%20networking?nodeId=board%3AAzureNetworkingBlog)\n\n[!\\[VamsiVadlamuri&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/m_assets/avatars/default/avatar-8.svg?image-dimensions=50x50)](/users/vamsivadlamuri/2035323) [VamsiVadlamuri](/users/vamsivadlamuri/2035323) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined September 18, 2023\n\n[View Profile](/users/vamsivadlamuri/2035323)\n\n/category/azure/blog/azurenetworkingblog [Azure Networking Blog](/category/azure/blog/azurenetworkingblog) Follow this blog board to get notified when there's new activity",
  "Title": "Data Center Quantized Congestion Notification: Scaling congestion control for RoCE RDMA in Azure",
  "Author": "VamsiVadlamuri",
  "Tags": [],
  "OutputDir": "_community",
  "FeedName": "Microsoft Tech Community",
  "Link": "https://techcommunity.microsoft.com/t5/azure-networking-blog/data-center-quantized-congestion-notification-scaling-congestion/ba-p/4468417",
  "Description": "As cloud storage demands continue to grow, the need for ultra-fast, reliable networking becomes ever more critical. Microsoft Azure’s journey to empower its storage infrastructure with RDMA (Remote Direct Memory Access) has been transformative, but it’s not without challenges—especially when it comes to congestion control at scale. Azure’s deployment of RDMA at regional scale relies on DCQCN (Data Center Quantized Congestion Notification), a protocol that’s become central to Azure’s ability to deliver high-throughput, low-latency storage services across vast, heterogeneous data center regions.\n\n## Why congestion control matters in RDMA networks\n\nRDMA offloads the network stack to NIC hardware, reducing CPU overhead and enabling near line-rate performance. However, as Azure scaled RDMA across clusters and regions, it faced new challenges:\n\n- **Heterogeneous hardware:** Different generations of RDMA NICs (Network Interface Cards) and switches, each with their own quirks.\n- **Variable latency:** Long-haul links between datacenters introduce large round-trip time (RTT) variations.\n- **Congestion risks:** High-speed, incast-like traffic patterns can easily overwhelm buffers, leading to packet loss and degraded performance.\n\nTo address these, Azure needed a congestion control protocol that could operate reliably across diverse hardware and network conditions. Traditional TCP congestion control mechanisms don’t apply here, so Azure leverages **DCQCN combined with Priority Flow Control (PFC)** to maintain high throughput, low latency, and near-zero packet loss.\n\n### How DCQCN works\n\nDCQCN coordinates congestion control using three main entities:\n\n- **Reaction point (RP)**: The sender adjusts its rate based on feedback.\n- **Congestion point (CP)**: Switches mark packets using ECN when queues exceed thresholds.\n- **Notification point (NP)**: The receiver sends Congestion Notification Packets (CNPs) upon receiving ECN-marked packets.\n\nThis feedback loop allows RDMA flows to dynamically adapt their sending rates, preventing congestion collapse while maintaining fairness.\n\n![]()\n- When the switch detects congestion, it marks packets with ECN.\n- The receiver NIC (NP) observes ECN marks and sends CNPs to the sender.\n- The sender NIC (RP) reduces its sending rate upon receiving CNPs; otherwise, it increases the rate gradually.\n\n### Interoperability challenges across different hardware generations\n\nCloud infrastructure evolves incrementally, typically at the level of individual clusters or racks, as newer server hardware generations are introduced. Within a single region, clusters often differ in their NIC configurations. Our deployment includes three generations of commodity RDMA NICs—Gen1, Gen2, and Gen3—each implementing DCQCN with distinct design variations. These discrepancies create complex and often problematic interactions when NICs from different generations interoperate.\n\n- **Gen1 NICs:** Firmware-based DCQCN, NP-side CNP coalescing, burst-based rate limiting.\n- **Gen2/Gen3 NICs:** Hardware-based DCQCN, RP-side CNP coalescing, per-packet rate limiting.\n\n**Problem:**\n\n- Gen2/Gen3 NICs sending to Gen1 can trigger excessive cache misses, slowing down Gen1’s receiver pipeline.\n- Gen1 sending to Gen2/Gen3 can cause excessive rate reductions due to frequent CNPs.\n\n**Azure’s solution:**\n\n- Move CNP coalescing to NP side for Gen2/Gen3.\n- Implement per-QP CNP rate limiting, matching Gen1’s timer.\n- Enable per-burst rate limiting on Gen2/Gen3 to reduce cache pressure.\n\n### DCQCN tuning: Achieving fairness and performance\n\nDCQCN is inherently **RTT-fair**—its rate adjustment is independent of round-trip time, making it suitable for Azure’s regional networks with RTTs ranging from microseconds to milliseconds.\n\n**Key Tuning Strategies:**\n\n- **Sparse ECN marking:** Use large ECN marking thresholds (K\\_max - K\\_min) and low marking probabilities (P\\_max) for flows with large RTTs.\n- **Joint buffer and DCQCN tuning:** Tune switch buffer thresholds and DCQCN parameters together to avoid premature congestion signals and optimize throughput.\n- **Global parameter settings:** Azure’s NICs support only global DCQCN settings, so parameters must work well across all traffic types and RTTs.\n\n## Real-world results\n\n- **High throughput & low latency:**\n- RDMA traffic runs at line rate with near-zero packet loss.\n- **CPU savings:**\n- Freed CPU cores can be repurposed for customer VMs or application logic.\n- **Performance metrics:**\n- RDMA reduces CPU utilization by up to 34.5% compared to TCP for storage frontend traffic.\n- Large I/O requests (1 MB) see up to 23.8% latency reduction for reads and 15.6% for writes.\n- **Scalability:**\n- As of November 2025, ~85% of Azure’s traffic is RDMA, supported in all public regions.\n\n## Conclusion\n\nDCQCN is a cornerstone of Azure’s RDMA-enabled storage infrastructure, enabling reliable, high-performance cloud storage at scale. By combining ECN-based signaling with dynamic rate adjustments, DCQCN ensures high throughput, low latency, and near-zero packet loss—even across heterogeneous hardware and long-haul links. Its interoperability fixes and careful tuning make it a critical enabler for RDMA adoption in modern data centers, paving the way for efficient, scalable, and resilient cloud storage.",
  "ProcessedDate": "2026-01-13 23:02:46",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "PubDate": "2026-01-13T22:35:21+00:00",
  "FeedLevelAuthor": "rss.livelink.threads-in-node"
}
