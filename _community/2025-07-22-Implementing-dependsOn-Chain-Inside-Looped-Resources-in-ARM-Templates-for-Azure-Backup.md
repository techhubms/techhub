---
layout: "post"
title: "Implementing dependsOn Chain Inside Looped Resources in ARM Templates for Azure Backup"
description: "The author details challenges in using ARM templates to create a sequential dependsOn chain between loop-generated resources, specifically for backing up Azure file shares. Despite attempts at various workarounds, ARM templates' limitations cause validation errors. The author seeks community advice or best practices for achieving this dependency chain."
author: "AdPsychological9128"
excerpt_separator: <!--excerpt_end-->
canonical_url: "https://www.reddit.com/r/azuredevops/comments/1m6d7gm/implementing_dependson_chain_inside_looped/"
viewing_mode: "external"
feed_name: "Reddit Azure DevOps"
feed_url: "https://www.reddit.com/r/azuredevops/.rss"
date: 2025-07-22 12:49:16 +00:00
permalink: "/2025-07-22-Implementing-dependsOn-Chain-Inside-Looped-Resources-in-ARM-Templates-for-Azure-Backup.html"
categories: ["Azure", "DevOps"]
tags: ["ARM Templates", "Azure", "Azure Backup", "Azure DevOps", "Azure Recovery Services", "Community", "Dependson", "DevOps", "IaC", "Protected Items", "Resource Deployment", "Resource Loops", "Sequential Deployment", "Validation Errors"]
tags_normalized: ["arm templates", "azure", "azure backup", "azure devops", "azure recovery services", "community", "dependson", "devops", "iac", "protected items", "resource deployment", "resource loops", "sequential deployment", "validation errors"]
---

AdPsychological9128 discusses their struggle with enforcing a dependsOn chain within a loop of ARM template resources for Azure file share backup, and seeks community solutions.<!--excerpt_end-->

## Implementing dependsOn Chain Inside Looped Resources in ARM Templates (Azure Backup for File Shares)

### Author: AdPsychological9128

#### Scenario

The author is automating Azure Recovery Services deployments to protect (i.e., back up) Azure file shares with ARM templates. Their goal is to ensure that each resource generated by looping over an array is deployed only after the prior oneâ€”enforcing sequential execution using the `dependsOn` property.

#### Objective

- Loop over an array (`protectedItemsArray`) of resources (protected file shares).
- Dynamically generate resource IDs and related properties.
- Build each resource's `dependsOn` property to reference the preceding resource within the same loop, so deployments occur in sequence.

#### Challenges

It appears that ARM templates do not natively support establishing a `dependsOn` chain (i.e., making each looped resource depend directly on the previous loop iteration). Several approaches have been attempted, but all result in validation errors:

##### Attempted Approaches

1. **Returning an Array for First Iteration, String for Others:**

   For the first array element: try returning an empty array for `dependsOn`.
   For later elements: try constructing a resource ID referencing the previous item.

   Example:

   ```json
   "[if(greater(copyIndex(), 0), concat('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems/', parameters('protectedItemsArray')[sub(copyIndex(), 1)].vaultName, '/Azure/', variables('containerSuffix'), ';', parameters('protectedItemsArray')[sub(copyIndex(), 1)].storageAccountResourceGroup, ';', parameters('protectedItemsArray')[sub(copyIndex(), 1)].storageAccountName, '/AzureFileShare;', parameters('protectedItemsArray')[sub(copyIndex(), 1)].fileShareName), json('[]'))]"
   ```
   
   **Failure:** This approach fails because `json('[]')` returns an array whereas a resource ID string is expected.

2. **Using `json(null())` or Empty String:**

   ```json
   "[if(greater(copyIndex(), 0), concat(...), json(null()))]"
   ```
   
   **Failure:** `json(null())` is invalid for this context.

3. **Returning `json('[]')`, `json('')`, or `string('')`:**
   
   All these variants result in validation errors because ARM requires a valid string for a resource ID in `dependsOn`, not an array or an empty value.

#### Questions for the Community

- Has anyone successfully implemented a dependsOn chain between looped resources in ARM templates, so each resource depends on the previous?
- Are there established best practices or usable workarounds?
- Is this scenario even supported in ARM templates as of now? If so, any guidance, sample code, or documentation references would be appreciated.

#### Additional Context

- The author is specifically automating Azure Backup for file shares.
- The focus is on forcing sequential resource deployment inside a loop rather than deploying all resources concurrently.

#### Request

If you have any solutions, related documentation, or workaround strategies, please share your insights.

---

Source: [Reddit post by u/AdPsychological9128](https://www.reddit.com/r/azuredevops/comments/1m6d7gm/implementing_dependson_chain_inside_looped/)

This post appeared first on "Reddit Azure DevOps". [Read the entire article here](https://www.reddit.com/r/azuredevops/comments/1m6d7gm/implementing_dependson_chain_inside_looped/)
