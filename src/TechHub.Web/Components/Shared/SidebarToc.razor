@using System.Text.RegularExpressions
@* Automatically generates table of contents from HTML headings *@

@if (tocItems.Count > 0)
{
    <div class="sidebar-section sidebar-toc">
        <h3>Table of Contents</h3>
        <nav aria-label="Table of Contents">
            <ul>
                @foreach (var item in tocItems)
                {
                    <li class="toc-level-@item.Level">
                        <a href="#@item.Id">@item.Text</a>
                    </li>
                }
            </ul>
        </nav>
    </div>
}

@code {
    [Parameter, EditorRequired]
    public required string HtmlContent { get; set; }

    private List<TocItem> tocItems = [];

    protected override void OnParametersSet()
    {
        tocItems = ExtractHeadings(HtmlContent);
    }

    private static List<TocItem> ExtractHeadings(string html)
    {
        var items = new List<TocItem>();
        if (string.IsNullOrWhiteSpace(html))
            return items;

        // Match headings with IDs: <h2 id="heading-id">Text</h2> or <h2>Text {#heading-id}</h2>
        var headingPattern = @"<h([2-6])(?:\s+id=[""']([^""']+)[""'])?[^>]*>(.*?)</h\1>";
        var matches = Regex.Matches(html, headingPattern, RegexOptions.IgnoreCase);

        foreach (Match match in matches)
        {
            var level = int.Parse(match.Groups[1].Value);
            var id = match.Groups[2].Value;
            var text = Regex.Replace(match.Groups[3].Value, @"<[^>]+>", ""); // Strip HTML tags

            // Extract ID from markdown {#id} syntax if not in attribute
            if (string.IsNullOrEmpty(id) && text.Contains("{#"))
            {
                var idMatch = Regex.Match(text, @"\{#([^}]+)\}");
                if (idMatch.Success)
                {
                    id = idMatch.Groups[1].Value;
                    text = text.Replace(idMatch.Value, "").Trim();
                }
            }

            // Generate ID from text if still not found
            if (string.IsNullOrEmpty(id))
            {
                id = GenerateId(text);
            }

            items.Add(new TocItem
            {
                Level = level,
                Id = id,
                Text = text
            });
        }

        return items;
    }

    private static string GenerateId(string text)
    {
        // Convert to lowercase and replace spaces/special chars with hyphens
        return Regex.Replace(text.ToLowerInvariant(), @"[^a-z0-9]+", "-").Trim('-');
    }

    private record TocItem
    {
        public required int Level { get; init; }
        public required string Id { get; init; }
        public required string Text { get; init; }
    }
}