@using TechHub.Core.DTOs
@using TechHub.Web.Services
@inject TechHubApiClient ApiClient
@inject ILogger<CollectionContent> Logger
@attribute [StreamRendering]

<div class="collection-content @(isLoading ? "loading" : "")">
    <h2 class="collection-title">@GetCollectionDisplayName()</h2>
    
    @if (isLoading && !contentItems.Any())
    {
        <div class="content-grid">
            @* Skeleton cards while loading - mimics actual content card structure *@
            @for (int i = 0; i < 6; i++)
            {
                <div class="content-item-card skeleton-card">
                    <div class="content-header">
                        <div class="skeleton skeleton-card-title"></div>
                        <div class="skeleton skeleton-card-meta"></div>
                    </div>
                    <div class="skeleton skeleton-card-description"></div>
                    <div class="skeleton skeleton-card-description" style="width: 80%;"></div>
                    <div class="content-tags">
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error">
            <h2>Error Loading Content</h2>
            <p>@errorMessage</p>
            <button @onclick="LoadContent">Retry</button>
        </div>
    }
    else if (contentItems.Any())
    {
        <div class="content-grid">
            @foreach (var item in contentItems)
            {
                <ContentItemCard Item="@item" ShowCollectionBadge="@ShowCollectionBadge" />
            }
        </div>
    }
    else
    {
        <div class="no-content">
            <p>No content available for this collection.</p>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public required string SectionName { get; set; }

    [Parameter, EditorRequired]
    public required string CollectionName { get; set; }

    [Parameter]
    public string SectionCategory { get; set; } = string.Empty;

    [Parameter]
    public IReadOnlyList<CollectionReferenceDto> Collections { get; set; } = Array.Empty<CollectionReferenceDto>();

    private List<ContentItemDto> contentItems = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string previousCollectionName = string.Empty;

    private bool ShowCollectionBadge => 
        SectionCategory.Equals("All", StringComparison.OrdinalIgnoreCase) || 
        CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        previousCollectionName = CollectionName;
        await LoadContent();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload if collection actually changed
        if (CollectionName != previousCollectionName)
        {
            previousCollectionName = CollectionName;
            await LoadContent();
        }
    }

    private async Task LoadContent()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        Logger.LogDebug("LoadContent START: Section={SectionName}, Collection={CollectionName}, Category={SectionCategory}", 
            SectionName, CollectionName, SectionCategory);
        
        try
        {
            IEnumerable<ContentItemDto>? items = null;

            // Handle "all" collection - get all content for this section across all collections
            if (CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                if (SectionCategory.Equals("All", StringComparison.OrdinalIgnoreCase))
                {
                    // /all/all - get everything
                    Logger.LogDebug("Calling ApiClient.GetContentAsync(\"\", \"\") for /all/all");
                    items = await ApiClient.GetContentAsync("", "");
                }
                else
                {
                    // /section/all - get all content for this section's category
                    Logger.LogDebug("Calling ApiClient.GetContentAsync({Category}, ) for section category={Category}", SectionCategory, SectionCategory);
                    items = await ApiClient.GetContentAsync(SectionCategory, "");
                }
            }
            // Special handling for "All" section with specific collection
            else if (SectionCategory.Equals("All", StringComparison.OrdinalIgnoreCase))
            {
                // /all/news - get all news across all sections
                Logger.LogDebug("Calling ApiClient.GetContentAsync(, {Collection}) for collection={Collection}", CollectionName, CollectionName);
                items = await ApiClient.GetContentAsync("", CollectionName);
            }
            else
            {
                // /section/collection - get specific collection for specific category
                Logger.LogDebug("Calling ApiClient.GetContentAsync({Category}, {Collection}) for category={Category}, collection={Collection}", 
                    SectionCategory, CollectionName, SectionCategory, CollectionName);
                items = await ApiClient.GetContentAsync(SectionCategory, CollectionName);
            }

            contentItems = items?.ToList() ?? new List<ContentItemDto>();
            Logger.LogDebug("LoadContent COMPLETE: Loaded {Count} items, isLoading will be set to false", contentItems.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load content for {SectionName}/{CollectionName}", SectionName, CollectionName);
            errorMessage = "Unable to load content";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            Logger.LogDebug("LoadContent FINALLY: isLoading={IsLoading}, contentItems.Count={Count}", isLoading, contentItems.Count);
        }
    }

    private string GetCollectionDisplayName()
    {
        if (CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
        {
            return "All";
        }
        
        return Collections
            .FirstOrDefault(c => c.Name == CollectionName)?.Title 
            ?? CollectionName;
    }
}
