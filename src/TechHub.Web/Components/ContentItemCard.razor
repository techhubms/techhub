@using TechHub.Core.Models

<a href="@Item.GetHref(SectionName)"
   class="card"
   target="@Item.GetTarget()"
   rel="@Item.GetRel()"
   aria-label="@Item.GetAriaLabel()">
        <div class="card-header">
            <h3 class="card-title">@Item.Title</h3>
            <div class="card-meta">
                <time datetime="@FormatDateIso(Item.DateEpoch)">@FormatDate(Item.DateEpoch)</time>
                @if (!string.IsNullOrWhiteSpace(Item.Author))
                {
                    <span class="content-author">by @Item.Author</span>
                }
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Item.Excerpt))
        {
            <div class="card-description">
                <SafeMarkup Html="@Item.Excerpt" />
            </div>
        }

        @if (Item.Tags.Any() || (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName)))
        {
            <div class="card-tags" @onclick:preventDefault @onclick:stopPropagation>
                @foreach (var tag in Item.Tags.Take(5))
                {
                    <span class="badge-purple-static">@tag</span>
                }
                @if (Item.Tags.Count > 5)
                {
                    <span class="badge-grey">+@(Item.Tags.Count - 5) more</span>
                }
                @if (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName))
                {
                    <span class="badge-grey">@CapitalizeCollection(Item.CollectionName)</span>
                }
            </div>
        }
</a>

@code {
    [Parameter, EditorRequired]
    public ContentItem Item { get; set; } = null!;

    /// <summary>
    /// The current section name. When set, content links will stay within this section.
    /// When null, links fall back to the item's PrimarySectionName.
    /// </summary>
    [Parameter]
    public string? SectionName { get; set; }

    [Parameter]
    public bool ShowCollectionBadge { get; set; } = true;

    [Parameter]
    public bool ShowSectionName { get; set; } = true;

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        var now = DateTimeOffset.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalDays < 1)
            return "Today";
        if (diff.TotalDays < 2)
            return "Yesterday";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)} weeks ago";

        return dateTime.ToString("MMM d, yyyy");
    }

    private static string FormatDateIso(long epochSeconds) =>
        DateTimeOffset.FromUnixTimeSeconds(epochSeconds).ToString("yyyy-MM-dd");

    private string CapitalizeCollection(string collection)
    {
        if (string.IsNullOrWhiteSpace(collection))
            return collection;

        // Capitalize first letter of each word
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(collection.ToLower());
    }
}