@using TechHub.Core.Models
@inject NavigationManager Navigation

<div class="card"
   aria-label="@Item.GetAriaLabel()">
        <div class="card-header">
            <h3 class="card-title">
                <a href="@Item.GetHref(SectionName)"
                   class="card-link"
                   target="@Item.GetTarget()"
                   rel="@Item.GetRel()"
                   aria-label="@Item.GetAriaLabel()">@Item.Title</a>
            </h3>
            <div class="card-meta">
                <time datetime="@FormatDateIso(Item.DateEpoch)">@FormatDate(Item.DateEpoch)</time>@if (!string.IsNullOrWhiteSpace(Item.Author))
                {<span class="content-author"> by @Item.Author</span>}
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Item.Excerpt))
        {
            <div class="card-description">
                <SafeMarkup Html="@Item.Excerpt" />
            </div>
        }

        @if (Item.Tags.Any() || (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName)))
        {
            <div class="card-tags">
                @if (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName))
                {
                    <a href="@GetCollectionUrl()" class="badge-purple"
                       aria-label="View @CapitalizeCollection(Item.CollectionName) collection">
                        @CapitalizeCollection(Item.CollectionName)
                    </a>
                }
                @{
                    var visibleTags = _showAllTags ? Item.Tags : Item.Tags.Take(5);
                    var hiddenCount = Item.Tags.Count - 5;
                }
                @foreach (var tag in visibleTags)
                {
                    var isActive = IsTagActive(tag);
                    var tagCssClass = isActive
                        ? "badge-tag badge-tag-clickable badge-tag-active"
                        : "badge-tag badge-tag-clickable";
                    var tagAriaLabel = isActive
                        ? $"Remove filter: {tag}"
                        : $"Filter by {tag}";

                    <button type="button" class="@tagCssClass"
                            @onclick="() => HandleTagClick(tag)"
                            @onclick:stopPropagation="true"
                            aria-label="@tagAriaLabel">
                        @tag
                    </button>
                }
                @if (!_showAllTags && hiddenCount > 0)
                {
                    <button type="button" class="badge-expandable"
                            @onclick="ExpandTags"
                            @onclick:stopPropagation="true"
                            aria-label="Show @hiddenCount more tags">
                        +@hiddenCount more
                    </button>
                }
            </div>
        }
</div>

@code {
    [Parameter, EditorRequired]
    public ContentItem Item { get; set; } = null!;

    /// <summary>
    /// The current section name. When set, content links will stay within this section.
    /// When null, links fall back to the item's PrimarySectionName.
    /// </summary>
    [Parameter]
    public string? SectionName { get; set; }

    [Parameter]
    public bool ShowCollectionBadge { get; set; } = true;

    [Parameter]
    public bool ShowSectionName { get; set; } = true;

    /// <summary>
    /// List of currently active filter tags (from URL query string).
    /// Tags matching these will be highlighted and clicking them will deselect the filter.
    /// </summary>
    [Parameter]
    public IReadOnlyList<string>? ActiveFilterTags { get; set; }

    private bool _showAllTags;

    private string GetCollectionUrl()
    {
        var section = SectionName ?? Item.PrimarySectionName;
        return $"/{section}/{Item.CollectionName}";
    }

    private bool IsTagActive(string tag)
    {
        if (ActiveFilterTags == null || ActiveFilterTags.Count == 0)
        {
            return false;
        }

        var normalizedTag = tag.Trim().ToLowerInvariant();
        return ActiveFilterTags.Any(t => string.Equals(t.Trim(), normalizedTag, StringComparison.OrdinalIgnoreCase));
    }

    private void HandleTagClick(string tag)
    {
        // Toggle tag in the filter query string.
        // If the tag is already active, remove it (deselect). Otherwise, add it.
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        var tagList = query.TryGetValue("tags", out var existingTags)
            ? existingTags.ToString().Split(',', StringSplitOptions.RemoveEmptyEntries).ToList()
            : new List<string>();

        var normalizedTag = tag.Trim().ToLowerInvariant();
        if (tagList.Contains(normalizedTag, StringComparer.OrdinalIgnoreCase))
        {
            // Tag is active — remove it (deselect)
            tagList.RemoveAll(t => string.Equals(t, normalizedTag, StringComparison.OrdinalIgnoreCase));
        }
        else
        {
            // Tag is not active — add it
            tagList.Add(normalizedTag);
        }

        var queryParams = new Dictionary<string, object?>
        {
            ["tags"] = tagList.Count > 0 ? string.Join(",", tagList) : null
        };

        // Preserve existing query parameters
        if (query.TryGetValue("search", out var search) && !string.IsNullOrEmpty(search))
            queryParams["search"] = search.ToString();
        if (query.TryGetValue("from", out var from) && !string.IsNullOrEmpty(from))
            queryParams["from"] = from.ToString();
        if (query.TryGetValue("to", out var to) && !string.IsNullOrEmpty(to))
            queryParams["to"] = to.ToString();

        var basePath = uri.GetLeftPart(UriPartial.Path);
        var newUrl = Navigation.GetUriWithQueryParameters(basePath, queryParams);
        Navigation.NavigateTo(newUrl);
    }

    private void ExpandTags()
    {
        _showAllTags = true;
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        var now = DateTimeOffset.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalDays < 1)
            return "Today";
        if (diff.TotalDays < 2)
            return "Yesterday";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)} weeks ago";

        return dateTime.ToString("MMM d, yyyy");
    }

    private static string FormatDateIso(long epochSeconds) =>
        DateTimeOffset.FromUnixTimeSeconds(epochSeconds).ToString("yyyy-MM-dd");

    private string CapitalizeCollection(string collection)
    {
        if (string.IsNullOrWhiteSpace(collection))
            return collection;

        // Capitalize first letter of each word
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(collection.ToLower());
    }
}