@using TechHub.Core.DTOs

@{
    // External links: ViewingMode is "external" (default) - opens external source in new tab
    // Internal links: ViewingMode is "internal" - navigates to our content detail page
    var isExternal = string.IsNullOrWhiteSpace(Item.ViewingMode) || Item.ViewingMode == "external";
    var targetUrl = isExternal
        ? Item.ExternalUrl ?? "" // External content uses canonical source URL
        : Item.Url;              // Internal content uses our detail page
}

@if (isExternal)
{
    <a href="@targetUrl" class="content-item-card" target="_blank" rel="noopener noreferrer">
        <article>
            <div class="content-header">
                <h3 class="content-title">@Item.Title</h3>
                <div class="content-meta">
                    <time datetime="@Item.DateIso">@FormatDate(Item.DateEpoch)</time>
                    @if (!string.IsNullOrWhiteSpace(Item.Author))
                    {
                        <span class="content-author">by @Item.Author</span>
                    }
                </div>
            </div>
        
        @if (!string.IsNullOrWhiteSpace(Item.Excerpt))
        {
            <div class="content-excerpt">
                @((MarkupString)Item.Excerpt)
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(Item.Description))
        {
            <p class="content-description">@Item.Description</p>
        }
        
        @if (Item.Tags.Any() || (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName)))
        {
            <div class="content-tags" @onclick:preventDefault @onclick:stopPropagation>
                @if (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName))
                {
                    <span class="collection-badge-white" @onclick:preventDefault @onclick:stopPropagation>@CapitalizeCollection(Item.CollectionName)</span>
                }
                @foreach (var tag in Item.Tags.Take(5))
                {
                    <span class="tag" @onclick:preventDefault @onclick:stopPropagation>@tag</span>
                }
                @if (Item.Tags.Count > 5)
                {
                    <span class="tag-more" @onclick:preventDefault @onclick:stopPropagation>+@(Item.Tags.Count - 5) more</span>
                }
            </div>
        }
        
        @if (!string.IsNullOrWhiteSpace(Item.VideoId) || !string.IsNullOrWhiteSpace(Item.ExternalUrl))
        {
            <div class="content-footer">
                @if (!string.IsNullOrWhiteSpace(Item.VideoId))
                {
                    <span class="video-indicator">ðŸŽ¥ Video</span>
                }
                @if (!string.IsNullOrWhiteSpace(Item.ExternalUrl))
                {
                    <span class="external-indicator">ðŸ”— External</span>
                }
            </div>
        }
        </article>
    </a>
}
else
{
    <a href="@targetUrl" class="content-item-card" data-enhance-nav="true">
        <article>
            <div class="content-header">
                <h3 class="content-title">@Item.Title</h3>
                <div class="content-meta">
                    <time datetime="@Item.DateIso">@FormatDate(Item.DateEpoch)</time>
                    @if (!string.IsNullOrWhiteSpace(Item.Author))
                    {
                        <span class="content-author">by @Item.Author</span>
                    }
                </div>
            </div>
        
        @if (!string.IsNullOrWhiteSpace(Item.Excerpt))
        {
            <div class="content-excerpt">
                @((MarkupString)Item.Excerpt)
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(Item.Description))
        {
            <p class="content-description">@Item.Description</p>
        }
        
        @if (Item.Tags.Any() || (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName)))
        {
            <div class="content-tags" @onclick:preventDefault @onclick:stopPropagation>
                @if (ShowCollectionBadge && !string.IsNullOrWhiteSpace(Item.CollectionName))
                {
                    <span class="collection-badge-white" @onclick:preventDefault @onclick:stopPropagation>@CapitalizeCollection(Item.CollectionName)</span>
                }
                @foreach (var tag in Item.Tags.Take(5))
                {
                    <span class="tag" @onclick:preventDefault @onclick:stopPropagation>@tag</span>
                }
                @if (Item.Tags.Count > 5)
                {
                    <span class="tag-more" @onclick:preventDefault @onclick:stopPropagation>+@(Item.Tags.Count - 5) more</span>
                }
            </div>
        }
        
        @if (!string.IsNullOrWhiteSpace(Item.VideoId) || !string.IsNullOrWhiteSpace(Item.ExternalUrl))
        {
            <div class="content-footer">
                @if (!string.IsNullOrWhiteSpace(Item.VideoId))
                {
                    <span class="video-indicator">ðŸŽ¥ Video</span>
                }
                @if (!string.IsNullOrWhiteSpace(Item.ExternalUrl))
                {
                    <span class="external-indicator">ðŸ”— External</span>
                }
            </div>
        }
        </article>
    </a>
}

@code {
    [Parameter, EditorRequired]
    public ContentItemDto Item { get; set; } = null!;

    [Parameter]
    public bool ShowCollectionBadge { get; set; } = true;

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        var now = DateTimeOffset.UtcNow;
        var diff = now - dateTime;

        if (diff.TotalDays < 1)
            return "Today";
        if (diff.TotalDays < 2)
            return "Yesterday";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)} weeks ago";
        
        return dateTime.ToString("MMM d, yyyy");
    }

    private string CapitalizeCollection(string collection)
    {
        if (string.IsNullOrWhiteSpace(collection))
            return collection;
        
        // Capitalize first letter of each word
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(collection.ToLower());
    }
}
