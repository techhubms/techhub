@* ============================================================================
   Sub-Navigation Component
   
   Horizontal navigation below page header showing collections and custom pages.
   Used across section pages to provide secondary navigation.
   On the homepage, shows sections as navigation items.
   
   Usage:
     Section page:  <SubNav Section="@sectionData" />
     Homepage:      <SubNav Sections="@allSections" />
   ============================================================================ *@

@using TechHub.Core.Models
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

@if (Section != null)
{
    <nav class="sub-nav" aria-label="@Section.Title navigation">
        @* Desktop: horizontal button bar *@
        <div class="sub-nav-wrapper">
            <a href="/@Section.Name/all" class="btn-subnav @(IsActive($"/{Section.Name}/all") ? "active" : "")"
               @onclick="@(() => OnSubNavClick($"/{Section.Name}/all"))" @onclick:preventDefault="@IsActive($"/{Section.Name}/all")">
                All
            </a>

            @foreach (var collection in RegularCollections)
            {
                var url = $"/{Section.Name}/{collection.Name}";
                <a href="@url" class="btn-subnav @(IsActive(url) ? "active" : "")"
                   @onclick="@(() => OnSubNavClick(url))" @onclick:preventDefault="@IsActive(url)">
                    @collection.Title
                </a>
            }

            @foreach (var customPage in CustomPages)
            {
                <a href="@customPage.Url" class="btn-subnav btn-subnav-custom @(IsActive(customPage.Url) ? "active" : "")"
                   @onclick="@(() => OnSubNavClick(customPage.Url))" @onclick:preventDefault="@IsActive(customPage.Url)">
                    @customPage.Title
                </a>
            }
        </div>

        @* Mobile: dropdown showing active page *@
        <div class="sub-nav-mobile">
            <button class="sub-nav-dropdown-toggle" @onclick="ToggleDropdown" aria-expanded="@(dropdownOpen ? "true" : "false")">
                <span>@ActiveLabel</span>
                <span class="sub-nav-chevron @(dropdownOpen ? "expanded" : "")"></span>
            </button>
            @if (dropdownOpen)
            {
                <div class="sub-nav-dropdown-menu">
                    <a href="/@Section.Name/all" class="sub-nav-dropdown-item @(IsActive($"/{Section.Name}/all") ? "active" : "")"
                       @onclick="@(() => OnSubNavDropdownClick($"/{Section.Name}/all"))" @onclick:preventDefault="@IsActive($"/{Section.Name}/all")">
                        All
                    </a>
                    @foreach (var collection in RegularCollections)
                    {
                        var url = $"/{Section.Name}/{collection.Name}";
                        <a href="@url" class="sub-nav-dropdown-item @(IsActive(url) ? "active" : "")"
                           @onclick="@(() => OnSubNavDropdownClick(url))" @onclick:preventDefault="@IsActive(url)">
                            @collection.Title
                        </a>
                    }
                    @foreach (var customPage in CustomPages)
                    {
                        <a href="@customPage.Url" class="sub-nav-dropdown-item sub-nav-dropdown-custom @(IsActive(customPage.Url) ? "active" : "")"
                           @onclick="@(() => OnSubNavDropdownClick(customPage.Url))" @onclick:preventDefault="@IsActive(customPage.Url)">
                            @customPage.Title
                        </a>
                    }
                </div>
            }
        </div>
    </nav>
}
else if (Sections != null && Sections.Any())
{
    @* Homepage SubNav: show sections as navigation items *@
    <nav class="sub-nav sub-nav-homepage" aria-label="Sections navigation">
        @* Desktop: horizontal button bar (hidden on homepage via CSS) *@
        <div class="sub-nav-wrapper">
            @foreach (var sectionItem in Sections)
            {
                var url = $"/{sectionItem.Name}";
                <a href="@url" class="btn-subnav">
                    @sectionItem.Title
                </a>
            }
        </div>

        @* Mobile: dropdown showing sections *@
        <div class="sub-nav-mobile">
            <button class="sub-nav-dropdown-toggle" @onclick="ToggleDropdown" aria-expanded="@(dropdownOpen ? "true" : "false")">
                <span>Home</span>
                <span class="sub-nav-chevron @(dropdownOpen ? "expanded" : "")"></span>
            </button>
            @if (dropdownOpen)
            {
                <div class="sub-nav-dropdown-menu">
                    @foreach (var sectionItem in Sections)
                    {
                        var url = $"/{sectionItem.Name}";
                        <a href="@url" class="sub-nav-dropdown-item" @onclick="CloseDropdown">
                            @sectionItem.Title
                        </a>
                    }
                </div>
            }
        </div>
    </nav>
}
else
{
    @* Empty SubNav - just shows border *@
    <nav class="sub-nav sub-nav-empty" aria-hidden="true"></nav>
}

@code {
    [Parameter]
    public Section? Section { get; set; }

    /// <summary>
    /// List of all sections. Used on the homepage to show section links in the subnav.
    /// </summary>
    [Parameter]
    public IEnumerable<Section>? Sections { get; set; }

    private bool dropdownOpen;

    private IEnumerable<Collection> RegularCollections =>
    Section?.Collections?.Where(c => !c.IsCustom) ?? Enumerable.Empty<Collection>();

    private IEnumerable<Collection> CustomPages =>
    Section?.Collections?
        .Where(c => c.IsCustom)
        .OrderBy(c => c.Order)
        .ThenBy(c => c.Title) ?? Enumerable.Empty<Collection>();

    private string ActiveLabel
    {
        get
        {
            if (Section == null) return "";

            foreach (var collection in RegularCollections)
            {
                var url = $"/{Section.Name}/{collection.Name}";
                if (IsActive(url)) return collection.Title;
            }

            foreach (var customPage in CustomPages)
            {
                if (IsActive(customPage.Url)) return customPage.Title;
            }

            return "All";
        }
    }

    private void ToggleDropdown() => dropdownOpen = !dropdownOpen;

    private void CloseDropdown() => dropdownOpen = false;

    /// <summary>
    /// When clicking the already-active subnav item, scroll to top instead of staying in place.
    /// </summary>
    private async Task OnSubNavClick(string url)
    {
        if (IsActive(url))
        {
            await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

    /// <summary>
    /// Same as OnSubNavClick but also closes the mobile dropdown.
    /// </summary>
    private async Task OnSubNavDropdownClick(string url)
    {
        CloseDropdown();
        if (IsActive(url))
        {
            await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        }
    }

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        dropdownOpen = false;
        // Re-render to update active state when the URL changes
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private bool IsActive(string url)
    {
        // Get current path directly from NavigationManager
        var currentUri = new Uri(Navigation.Uri);
        var currentPath = currentUri.AbsolutePath.TrimEnd('/');
        var targetPath = url.TrimEnd('/');

        // For section root (e.g., /ai), also match /{sectionName}/all
        if (targetPath.EndsWith("/all", StringComparison.OrdinalIgnoreCase))
        {
            var sectionPath = targetPath[..^4]; // Remove "/all"
                                                // Match /ai/all or just /ai
            if (currentPath.Equals(targetPath, StringComparison.OrdinalIgnoreCase) ||
            currentPath.Equals(sectionPath, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }

        // For collections and custom pages - exact match or content detail pages under them
        if (currentPath.Equals(targetPath, StringComparison.OrdinalIgnoreCase) ||
        currentPath.StartsWith(targetPath + "/", StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return false;
    }
}