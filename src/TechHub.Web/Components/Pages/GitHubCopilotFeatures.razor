@page "/github-copilot/features"
@rendermode InteractiveServer
@using TechHub.Core.Models
@using TechHub.Web.Services

@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ErrorService ErrorService
@inject ILogger<GitHubCopilotFeatures> Logger

<PageTitle>@(pageData?.Title ?? "GitHub Copilot Features") - Tech Hub</PageTitle>

@if (pageData != null)
{
    <HeadContent>
        <link rel="canonical" href="https://tech.hub.ms/github-copilot/features" />
    </HeadContent>

    <SkipLink />

    <Header SectionName="github-copilot" />

    <main class="page-with-sidebar">
        <aside class="sidebar">
            <SidebarToc HtmlContent="@GetRenderedContent()" Title="Table of Contents" />

            <div class="sidebar-section">
                <h3 class="sidebar-heading">Filters</h3>
                <div class="filter-controls">
                    <label class="filter-toggle">
                        <input type="checkbox" @bind="showGhesOnly" @bind:after="ApplyFilters" />
                        <span>Show GHES Support Only</span>
                    </label>
                    <label class="filter-toggle">
                        <input type="checkbox" @bind="showVideosOnly" @bind:after="ApplyFilters" />
                        <span>Show Features with Videos Only</span>
                    </label>
                </div>
            </div>
        </aside>

        <article id="skiptohere" tabindex="-1" class="article-body">
            <div class="content-detail-header">
                <h1 class="page-h1">@pageData.Title</h1>
                @if (!string.IsNullOrWhiteSpace(pageData.Description))
                {
                    <p class="page-description">@pageData.Description</p>
                }
            </div>

            <div class="custom-page-container">
                <div class="custom-page-intro">
                    <p>@pageData.Intro</p>
                    <p class="custom-page-note"><strong>Note:</strong> @pageData.Note</p>
                    <div class="custom-page-links">
                        <a href="@pageData.Links.Pricing" class="btn" target="_blank" rel="noopener">View Pricing</a>
                        <a href="@pageData.Links.PlanDetails" class="btn" target="_blank" rel="noopener">Plan Details</a>
                    </div>
                </div>

                <section class="features-tiers">
                    <h2>Subscription Tiers</h2>
                    <div class="features-tiers-grid">
                        @foreach (var tier in pageData.SubscriptionTiers)
                        {
                            <div id="tier-@tier.Id" class="features-tier-card">
                                <h3>@tier.Name</h3>
                                <p class="features-tier-tagline">@tier.Tagline</p>
                                @if (tier.Price != null)
                                {
                                    <div class="features-tier-price">
                                        <span class="price-amount">$@tier.Price.Monthly</span>
                                        <span class="price-period">@tier.Price.Currency @(tier.Price.PerUser ? "per user " :
                                                                            "")per month</span>
                                        @if (tier.Price.Yearly.HasValue)
                                        {
                                            <span class="price-yearly">or $@tier.Price.Yearly per year</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="features-tier-price">
                                        <span class="price-amount">Free</span>
                                    </div>
                                }
                                <ul class="features-tier-features">
                                    @foreach (var feature in tier.Features)
                                    {
                                        <li>@feature</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </section>

                @foreach (var featureSection in pageData.FeatureSections)
                {
                    // Filter videos that belong to this tier's plans (e.g., Free videos have "Free" in Plans array)
                    var sectionVideos = filteredVideoItems.Where(v =>
                        featureSection.Plans.Any(p => v.Plans.Contains(p, StringComparer.OrdinalIgnoreCase)))
                        .ToList();

                    <div class="features-video-section">
                        <h2 id="@featureSection.Id">@featureSection.Title</h2>
                        <p class="features-section-plans">Available in: @string.Join(", ", featureSection.Plans)</p>
                        @if (sectionVideos.Any())
                        {
                            <div class="cards-grid">
                                @foreach (var feature in sectionVideos)
                                {
                                    var isAvailable = !feature.Draft;
                                    var featureId = $"feature-{feature.Slug}";

                                    @if (isAvailable)
                                    {
                                        <a href="@feature.GetHref(SectionName)" class="card">
                                            <div class="card-header">
                                                <h3 id="@featureId" class="card-title">@feature.Title</h3>
                                            </div>
                                            <p class="card-description">@feature.Excerpt</p>
                                            <div class="card-badges">
                                                @if (feature.GhesSupport)
                                                {
                                                    <span class="badge-success">✓ GHES Support</span>
                                                }
                                                <span class="badge-info">View Video</span>
                                            </div>
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="card-static">
                                            <div class="card-header">
                                                <h3 id="@featureId" class="card-title">@feature.Title</h3>
                                            </div>
                                            <p class="card-description">@feature.Excerpt</p>
                                            <div class="card-badges">
                                                @if (feature.GhesSupport)
                                                {
                                                    <span class="badge-success">✓ GHES Support</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </article>
    </main>
}

@code {
    private const string SectionName = "github-copilot";
    private FeaturesPageData? pageData;
    private List<TechHub.Core.Models.ContentItem> videoItems = new();
    private List<TechHub.Core.Models.ContentItem> filteredVideoItems = new();

    // Filter state
    private bool showGhesOnly = false;
    private bool showVideosOnly = false;

    /// <summary>
    /// Apply client-side filters to video items based on toggle states
    /// </summary>
    private void ApplyFilters()
    {
        filteredVideoItems = videoItems;

        if (showGhesOnly)
        {
            filteredVideoItems = filteredVideoItems.Where(v => v.GhesSupport).ToList();
        }

        if (showVideosOnly)
        {
            // Show only non-draft features (available now)
            filteredVideoItems = filteredVideoItems.Where(v => !v.Draft).ToList();
        }

        // Note: StateHasChanged() not needed because @bind:after triggers re-render automatically
    }

    /// <summary>
    /// Generate HTML content for TOC extraction.
    /// SidebarToc will extract headings from this HTML automatically.
    /// </summary>
    private string GetRenderedContent()
    {
        if (pageData == null)
            return string.Empty;

        var sb = new System.Text.StringBuilder();

        // Subscription tiers
        foreach (var tier in pageData.SubscriptionTiers)
        {
            sb.Append($"<h2 id=\"tier-{tier.Id}\">{tier.Name}</h2>");
        }

        // Feature sections with individual feature titles
        foreach (var featureSection in pageData.FeatureSections)
        {
            sb.Append($"<h2 id=\"{featureSection.Id}\">{featureSection.Title}</h2>");

            // Add h3 for each feature in this section (use videoItems, not filteredVideoItems, so TOC shows all features)
            var sectionVideos = videoItems.Where(v =>
                featureSection.Plans.Any(p => v.Plans.Contains(p, StringComparer.OrdinalIgnoreCase)))
                .ToList();

            foreach (var feature in sectionVideos)
            {
                // Slugify the title for the ID (same as feature card h3)
                var featureId = $"feature-{feature.Slug}";
                sb.Append($"<h3 id=\"{featureId}\">{feature.Title}</h3>");
            }
        }

        return sb.ToString();
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            pageData = await ApiClient.GetFeaturesDataAsync();

            if (pageData == null)
            {
                Navigation.NavigateTo("/not-found");
                return;
            }

            if (!string.IsNullOrEmpty(pageData.VideoCollection))
            {
                // Query videos collection from API with ghc_feature=true to get GitHub Copilot features (including drafts)
                var allVideos = await ApiClient.GetGhcFeaturesAsync();
                videoItems = (allVideos ?? Enumerable.Empty<TechHub.Core.Models.ContentItem>())
                    .OrderByDescending(v => v.DateEpoch)
                    .ToList();

                // Initialize filtered list with all items
                filteredVideoItems = videoItems;
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }
}