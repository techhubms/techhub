@page "/github-copilot/features"
@using TechHub.Core.DTOs
@using TechHub.Web.Services

@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ErrorService ErrorService
@inject ILogger<GitHubCopilotFeatures> Logger

<PageTitle>@(pageData?.Title ?? "GitHub Copilot Features") - Tech Hub</PageTitle>

@if (pageData != null)
{
    <HeadContent>
        <link rel="canonical" href="https://tech.hub.ms/github-copilot/features" />
    </HeadContent>

    <SkipLink />

    <Header SectionName="github-copilot" />

    <main class="page-with-sidebar">
        <aside class="sidebar">
            <SidebarToc HtmlContent="@GetRenderedContent()" Title="Table of Contents" />
        </aside>

        <article id="skiptohere" tabindex="-1" class="article-body">
            <div class="content-detail-header">
                <h1 class="page-h1">@pageData.Title</h1>
                @if (!string.IsNullOrWhiteSpace(pageData.Description))
                {
                    <p class="page-description">@pageData.Description</p>
                }
            </div>

            <div class="custom-page-container">
                <div class="custom-page-intro">
                    <p>@pageData.Intro</p>
                    <p class="custom-page-note"><strong>Note:</strong> @pageData.Note</p>
                    <div class="custom-page-links">
                        <a href="@pageData.Links.Pricing" target="_blank" rel="noopener">View Pricing</a>
                        <a href="@pageData.Links.PlanDetails" target="_blank" rel="noopener">Plan Details</a>
                    </div>
                </div>

                <section class="features-tiers">
                    <h2>Subscription Tiers</h2>
                    <div class="features-tiers-grid">
                        @foreach (var tier in pageData.SubscriptionTiers)
                        {
                            <div id="tier-@tier.Id" class="features-tier-card">
                                <h3>@tier.Name</h3>
                                <p class="features-tier-tagline">@tier.Tagline</p>
                                @if (tier.Price != null)
                                {
                                    <div class="features-tier-price">
                                        <span class="price-amount">$@tier.Price.Monthly</span>
                                        <span class="price-period">@tier.Price.Currency @(tier.Price.PerUser ? "per user " :
                                                                            "")per month</span>
                                        @if (tier.Price.Yearly.HasValue)
                                        {
                                            <span class="price-yearly">or $@tier.Price.Yearly per year</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="features-tier-price">
                                        <span class="price-amount">Free</span>
                                    </div>
                                }
                                <ul class="features-tier-features">
                                    @foreach (var feature in tier.Features)
                                    {
                                        <li>@feature</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </section>

                @foreach (var featureSection in pageData.FeatureSections)
                {
                    var sectionVideos = videoItems.Where(v =>
                    featureSection.Plans.Any(p => v.Tags?.Contains(p, StringComparer.OrdinalIgnoreCase) == true)).ToList();

                    <div class="features-video-section">
                        <h2 id="@featureSection.Id">@featureSection.Title</h2>
                        <p class="features-section-plans">Available in: @string.Join(", ", featureSection.Plans)</p>
                        @if (sectionVideos.Any())
                        {
                            <div class="content-list">
                                @foreach (var video in sectionVideos)
                                {
                                    <ContentItemCard Item="@video" ShowSectionName="false" />
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </article>
    </main>
}

@code {
    private FeaturesPageData? pageData;
    private List<ContentItemDto> videoItems = new();

    /// <summary>
    /// Generate HTML content for TOC extraction.
    /// SidebarToc will extract headings from this HTML automatically.
    /// </summary>
    private string GetRenderedContent()
    {
        if (pageData == null)
            return string.Empty;

        var sb = new System.Text.StringBuilder();

        // Subscription tiers
        foreach (var tier in pageData.SubscriptionTiers)
        {
            sb.Append($"<h2 id=\"tier-{tier.Id}\">{tier.Name}</h2>");
        }

        // Feature sections
        foreach (var featureSection in pageData.FeatureSections)
        {
            sb.Append($"<h2 id=\"{featureSection.Id}\">{featureSection.Title}</h2>");
        }

        return sb.ToString();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            pageData = await ApiClient.GetFeaturesDataAsync();

            if (pageData == null)
            {
                Navigation.NavigateTo("/not-found");
                return;
            }

            if (!string.IsNullOrEmpty(pageData.VideoCollection))
            {
                var allVideos = await ApiClient.GetContentAsync(null, "videos");
                videoItems = (allVideos ?? Enumerable.Empty<ContentItemDto>())
                .Where(v => v.CollectionName == pageData.VideoCollection)
                .OrderByDescending(v => v.DateEpoch)
                .ToList();
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }
}