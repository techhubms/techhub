@page "/{sectionName}"
@page "/{sectionName}/{collectionName}"
@using TechHub.Core.Models
@using TechHub.Web.Services

@inject SectionCache SectionCache
@inject NavigationManager Navigation

<PageTitle>@PageTitleText</PageTitle>

<HeadContent>
    <link rel="alternate" type="application/rss+xml" title="Tech Hub - @(section?.Title ?? SectionName) - RSS Feed"
        href="@($"/{SectionName}/feed.xml")" />
</HeadContent>

<SkipLink />

<Header SectionName="@SectionName" />

<main class="page-with-sidebar">
    <aside class="sidebar">
        <SidebarSearch SearchQuery="@searchQuery" OnSearchQueryChanged="HandleSearchQueryChanged" />
        <DateRangeSlider FromDate="@fromDate" ToDate="@toDate"
            OnDateRangeChanged="HandleDateRangeChanged" />
        <SidebarTagCloud SectionName="@SectionName" CollectionName="@CollectionName"
            Title="Popular Tags" NavigationMode="TagCloudNavigationMode.Filter" SelectedTags="@selectedTags"
            FromDate="@fromDateString" ToDate="@toDateString"
            SearchQuery="@searchQuery"
            OnSelectionChanged="HandleTagSelectionChanged" />
        <SidebarRssLinks Links="@(new[] { new SidebarRssLinks.RssLink("RSS Feed", $"/{SectionName}/feed.xml") })" />
    </aside>

    <section>
        <ContentItemsGrid SectionName="@SectionName" CollectionName="@CollectionName" FilterTags="@selectedTags"
            SearchQuery="@searchQuery" FromDate="@fromDateString" ToDate="@toDateString"
            @key="@CollectionName" />
    </section>
</main>

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string? CollectionName { get; set; }

    [SupplyParameterFromQuery(Name = "tags")]
    public string? TagsParam { get; set; }

    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchParam { get; set; }

    [SupplyParameterFromQuery(Name = "from")]
    public string? FromParam { get; set; }

    [SupplyParameterFromQuery(Name = "to")]
    public string? ToParam { get; set; }

    private List<string> selectedTags = new();
    private string searchQuery = string.Empty;
    private TechHub.Core.Models.Section? section;
    private TechHub.Core.Models.Collection? collection;
    private DateOnly? fromDate;
    private DateOnly? toDate;
    private string? fromDateString;
    private string? toDateString;
    private bool IsAll => string.Equals(CollectionName, "all", StringComparison.OrdinalIgnoreCase);
    private string PageTitleText => IsAll
        ? $"{section?.Title ?? SectionName} - Tech Hub"
        : $"{collection?.Title ?? CollectionName} - {section?.Title ?? SectionName} - Tech Hub";

    protected override void OnInitialized()
    {
        // Default to "all" when accessed via /{sectionName} route
        CollectionName ??= "all";

        // Verify section exists, redirect to 404 if not
        section = SectionCache.GetSectionByName(SectionName);
        if (section == null)
        {
            Navigation.NavigateTo("/not-found");
            return;
        }

        // Get collection (not applicable for "all")
        if (!IsAll)
        {
            collection = section.Collections.FirstOrDefault(c =>
                c.Name.Equals(CollectionName, StringComparison.OrdinalIgnoreCase));
        }

        // Parse tags and dates from URL
        ParseTagsFromUrl();
        ParseSearchFromUrl();
        ParseDatesFromUrl();
    }

    protected override void OnParametersSet()
    {
        ParseTagsFromUrl();
        ParseSearchFromUrl();
        ParseDatesFromUrl();
    }

    private void ParseTagsFromUrl()
    {
        if (!string.IsNullOrEmpty(TagsParam))
        {
            // Parse tags from URL
            var rawTags = TagsParam.Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(t => Uri.UnescapeDataString(t.Trim()).ToLowerInvariant())
            .ToList();

            // Deduplicate and normalize tags
            selectedTags = rawTags
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

            // If duplicates were removed, clean up the URL
            if (rawTags.Count != selectedTags.Count)
            {
                UpdateUrl();
            }
        }
        else
        {
            selectedTags = new List<string>();
        }
    }

    private void ParseSearchFromUrl()
    {
        searchQuery = SearchParam ?? string.Empty;
    }

    private void ParseDatesFromUrl()
    {
        fromDate = ParseDate(FromParam);
        toDate = ParseDate(ToParam);
        fromDateString = fromDate?.ToString("yyyy-MM-dd");
        toDateString = toDate?.ToString("yyyy-MM-dd");
    }

    private static DateOnly? ParseDate(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return null;
        }

        return DateOnly.TryParse(value, out var date) ? date : null;
    }

    private void UpdateUrl()
    {
        var queryParams = new Dictionary<string, object?>
        {
            ["search"] = string.IsNullOrWhiteSpace(searchQuery) ? null : searchQuery,
            ["tags"] = selectedTags.Count > 0 ? string.Join(",", selectedTags.Select(t => Uri.EscapeDataString(t))) : null,
            ["from"] = fromDate?.ToString("yyyy-MM-dd"),
            ["to"] = toDate?.ToString("yyyy-MM-dd")
        };

        var url = Navigation.GetUriWithQueryParameters(queryParams);
        Navigation.NavigateTo(url, new NavigationOptions { ReplaceHistoryEntry = true });
    }

    private void HandleSearchQueryChanged(string query)
    {
        searchQuery = query;
        UpdateUrl();
    }

    private void HandleTagSelectionChanged(List<string> tags)
    {
        selectedTags = tags;
        UpdateUrl();
    }

    private void HandleDateRangeChanged(DateRangeChangedEventArgs args)
    {
        fromDate = args.FromDate;
        toDate = args.ToDate;
        fromDateString = fromDate?.ToString("yyyy-MM-dd");
        toDateString = toDate?.ToString("yyyy-MM-dd");
        UpdateUrl();
    }
}