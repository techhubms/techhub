@page "/{sectionName}/{collectionName}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

@if (sectionData == null)
{
    <p class="error-message">Error: Section data could not be loaded.</p>
}
else
{
    <PageTitle>@GetCollectionDisplayName(CollectionName) - @sectionData.Title - Tech Hub</PageTitle>

    <HeadContent>
        <link rel="alternate" type="application/rss+xml" title="Tech Hub - @sectionData.Title - RSS Feed"
            href="@($"{sectionData.Url}/feed.xml")" />
    </HeadContent>

    <PageHeader Section="@sectionData" />

    <div class="page-with-sidebar">
        <aside class="sidebar">
            <SidebarRssLinks Links="@(new[] { new SidebarRssLinks.RssLink("RSS Feed", $"{sectionData.Url}/feed.xml") })" />
        </aside>

        <main class="page-main-content">
            <ContentItemsGrid SectionName="@SectionName" CollectionName="@CollectionName" SectionTitle="@sectionData.Title"
                Collections="@sectionData.Collections" @key="@CollectionName" />
        </main>
    </div>
}

@code {
    [Inject] public required ErrorService ErrorService { get; set; }
    [Inject] public required ILogger<SectionCollection> Logger { get; set; }

    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string CollectionName { get; set; } = null!;

    private SectionDto? sectionData;

    protected override async Task OnInitializedAsync()
    {
        await LoadSection();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload section if section name changed
        if (sectionData != null && sectionData.Name != SectionName)
        {
            await LoadSection();
        }
    }

    private async Task LoadSection()
    {
        try
        {
            sectionData = await ApiClient.GetSectionAsync(SectionName);
            if (sectionData == null)
            {
                Navigation.NavigateTo("/not-found");
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }
}