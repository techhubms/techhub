@page "/{sectionName}/{collectionName}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(section != null ? $"{GetCollectionDisplayName(CollectionName)} - {section.Title}" : $"{GetCollectionDisplayName(CollectionName)}") - Tech Hub</PageTitle>

@if (section != null)
{
    <HeadContent>
        <link rel="alternate" type="application/rss+xml" 
              title="Tech Hub - @(section.Title) - RSS Feed" 
              href="@($"{section.Url}/feed.xml")" />
    </HeadContent>
}

<div class="section-page-grid">
    @if (isLoadingSection)
    {
        @* Show skeleton while loading section data *@
        <header class="section-header skeleton-header">
            <div class="section-header-content">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-description"></div>
            </div>
        </header>
        
        <nav class="collection-nav">
            <h2>Collections</h2>
            <ul class="skeleton-nav">
                <li><div class="skeleton skeleton-nav-item"></div></li>
                <li><div class="skeleton skeleton-nav-item"></div></li>
                <li><div class="skeleton skeleton-nav-item"></div></li>
            </ul>
        </nav>
    }
    else if (section != null)
    {
        var sectionData = section;
        @* Pass section data to children - no redundant API calls *@
        <PageHeader Section="@sectionData" />
        
        <SidebarCollectionNav Section="@sectionData"
                       SelectedCollection="@CollectionName" />
        
        <ContentItemsGrid SectionName="@SectionName"
                          CollectionName="@CollectionName"
                          SectionCategory="@sectionData.Category"
                          Collections="@sectionData.Collections" 
                          @key="@CollectionName" />
    }
    else
    {
        @* Error state *@
        <header class="section-header error-header">
            <div class="section-header-content">
                <h1>Section Not Found</h1>
                <p>Unable to load section "@SectionName"</p>
            </div>
        </header>
    }
</div>

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string CollectionName { get; set; } = null!;

    private SectionDto? section;
    private bool isLoadingSection = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSection();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload section if section name changed
        var currentSectionName = section?.Name;
        if (currentSectionName != null && currentSectionName != SectionName)
        {
            await LoadSection();
        }
    }

    private async Task LoadSection()
    {
        isLoadingSection = true;
        
        try
        {
            section = await ApiClient.GetSectionAsync(SectionName);
        }
        catch
        {
            section = null;
        }
        finally
        {
            isLoadingSection = false;
        }
    }
}
