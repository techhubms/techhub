@page "/{sectionName}"
@page "/{sectionName}/{collectionName}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ILogger<Section> Logger

<PageTitle>@PageTitle - Tech Hub</PageTitle>

<div class="section-page-grid">
    @if (isLoadingSection)
    {
        @* Show skeleton while loading section data *@
        <header class="section-header skeleton-header">
            <div class="section-header-content">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-description"></div>
            </div>
        </header>
        
        <nav class="collection-nav">
            <h2>Collections</h2>
            <ul class="skeleton-nav">
                <li><div class="skeleton skeleton-nav-item"></div></li>
                <li><div class="skeleton skeleton-nav-item"></div></li>
                <li><div class="skeleton skeleton-nav-item"></div></li>
            </ul>
        </nav>
    }
    else if (section != null)
    {
        var sectionData = section;
        @* Pass section data to children - no redundant API calls *@
        <SectionHeader Section="@sectionData" />
        
        <CollectionNav Section="@sectionData"
                       SelectedCollection="@selectedCollection"
                       IsLoadingContent="@isLoadingContent"
                       OnCollectionChange="@HandleCollectionChange" />
        
        <CollectionContent SectionName="@SectionName"
                          CollectionName="@selectedCollection"
                          SectionCategory="@sectionData.Category"
                          Collections="@sectionData.Collections" 
                          @key="@selectedCollection" />
    }
    else
    {
        @* Error state *@
        <header class="section-header error-header">
            <div class="section-header-content">
                <h1>Section Not Found</h1>
                <p>Unable to load section "@SectionName"</p>
            </div>
        </header>
    }
</div>

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string? CollectionName { get; set; }

    private string selectedCollection = string.Empty;
    private SectionDto? section;
    private bool isLoadingSection = true;
    private bool isLoadingContent = false;

    private string PageTitle => section?.Title ?? SectionName;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogDebug("Section OnInitializedAsync START: SectionName={SectionName}, CollectionName={CollectionName}", 
            SectionName, CollectionName);
        selectedCollection = CollectionName ?? "all";
        await LoadSection();
        Logger.LogDebug("Section OnInitializedAsync COMPLETE: section={SectionTitle}, isLoadingSection={IsLoading}", 
            section?.Title, isLoadingSection);
    }

    protected override async Task OnParametersSetAsync()
    {
        Logger.LogDebug("Section OnParametersSetAsync: SectionName={SectionName}, CollectionName={CollectionName}, selectedCollection={Selected}", 
            SectionName, CollectionName, selectedCollection);
        
        // Handle URL changes (browser back/forward, direct navigation)
        if (CollectionName != selectedCollection)
        {
            selectedCollection = CollectionName ?? "all";
        }
        
        // Reload section if section name changed
        var currentSectionName = section?.Name;
        if (currentSectionName != null && currentSectionName != SectionName)
        {
            await LoadSection();
        }
    }

    private async Task LoadSection()
    {
        Logger.LogDebug("LoadSection START: SectionName={SectionName}", SectionName);
        isLoadingSection = true;
        
        try
        {
            section = await ApiClient.GetSectionAsync(SectionName);
            Logger.LogDebug("LoadSection API call complete: section={SectionTitle}, category={Category}", 
                section?.Title, section?.Category);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "LoadSection FAILED for {SectionName}", SectionName);
            section = null;
        }
        finally
        {
            isLoadingSection = false;
            Logger.LogDebug("LoadSection FINALLY: isLoadingSection={IsLoading}, section={Section}", 
                isLoadingSection, section?.Title ?? "null");
        }
    }

    private Task HandleCollectionChange(string collectionName)
    {
        selectedCollection = collectionName;
        isLoadingContent = true;
        StateHasChanged();
        
        // Reset loading state after a brief delay (CollectionContent will manage its own loading)
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            isLoadingContent = false;
            await InvokeAsync(StateHasChanged);
        });
        
        return Task.CompletedTask;
    }
}
