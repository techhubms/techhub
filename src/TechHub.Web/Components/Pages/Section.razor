@page "/{sectionName}"
@page "/{sectionName}/{collectionName}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>@PageTitle - Tech Hub</PageTitle>

<div class="section-page-grid">
    @* Header loads independently *@
    <SectionHeader SectionName="@SectionName" />
    
    @* Navigation loads independently *@
    <CollectionNav SectionName="@SectionName" 
                   SelectedCollection="@selectedCollection"
                   IsLoadingContent="@isLoadingContent"
                   OnCollectionChange="@HandleCollectionChange" />
    
    @* Content loads independently *@
    @if (sectionCategory != null)
    {
        <CollectionContent SectionName="@SectionName"
                          CollectionName="@selectedCollection"
                          SectionCategory="@sectionCategory"
                          Collections="@collections" 
                          @key="@selectedCollection" />
    }
</div>

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string? CollectionName { get; set; }

    private string selectedCollection = string.Empty;
    private string? sectionCategory;
    private IReadOnlyList<CollectionReferenceDto> collections = Array.Empty<CollectionReferenceDto>();
    private bool isLoadingContent = false;

    private string PageTitle => SectionName;

    protected override async Task OnInitializedAsync()
    {
        selectedCollection = CollectionName ?? "all";
        await LoadSectionMetadata();
    }

    protected override Task OnParametersSetAsync()
    {
        // Handle URL changes (browser back/forward, direct navigation)
        if (CollectionName != selectedCollection)
        {
            selectedCollection = CollectionName ?? "all";
        }
        
        return Task.CompletedTask;
    }

    private async Task LoadSectionMetadata()
    {
        try
        {
            var section = await ApiClient.GetSectionAsync(SectionName);
            if (section != null)
            {
                sectionCategory = section.Category;
                collections = section.Collections;
            }
        }
        catch (Exception)
        {
            sectionCategory = string.Empty;
            collections = Array.Empty<CollectionReferenceDto>();
        }
    }

    private Task HandleCollectionChange(string collectionName)
    {
        selectedCollection = collectionName;
        isLoadingContent = true;
        StateHasChanged();
        
        // Reset loading state after a brief delay (CollectionContent will manage its own loading)
        _ = Task.Run(async () =>
        {
            await Task.Delay(100);
            isLoadingContent = false;
            await InvokeAsync(StateHasChanged);
        });
        
        return Task.CompletedTask;
    }
}
