@page "/{sectionName}"
@using TechHub.Core.Models
@using TechHub.Web.Services

@inject SectionCache SectionCache
@inject NavigationManager Navigation

<PageTitle>@(section?.Title ?? SectionName) - Tech Hub</PageTitle>

<HeadContent>
    <link rel="alternate" type="application/rss+xml" title="Tech Hub - @(section?.Title ?? SectionName) - RSS Feed"
        href="@($"/{SectionName}/feed.xml")" />
</HeadContent>

<SkipLink />

<Header SectionName="@SectionName" />

<main class="page-with-sidebar">
    <aside class="sidebar">
        <SidebarSearch SearchQuery="@searchQuery" OnSearchQueryChanged="HandleSearchQueryChanged" />
        <DateRangeSlider FromDate="@fromDate" ToDate="@toDate"
            OnDateRangeChanged="HandleDateRangeChanged" />
        <SidebarTagCloud SectionName="@SectionName" Title="Popular Tags"
            NavigationMode="TagCloudNavigationMode.Filter" SelectedTags="@selectedTags"
            FromDate="@fromDateString" ToDate="@toDateString"
            OnSelectionChanged="HandleTagSelectionChanged" />
        <SidebarRssLinks Links="@(new[] { new SidebarRssLinks.RssLink("RSS Feed", $"/{SectionName}/feed.xml") })" />
    </aside>

    <section>
        <ContentItemsGrid SectionName="@SectionName" CollectionName="all" FilterTags="@selectedTags"
            SearchQuery="@searchQuery" FromDate="@fromDateString" ToDate="@toDateString" />
    </section>
</main>

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [SupplyParameterFromQuery(Name = "tags")]
    public string? TagsParam { get; set; }

    [SupplyParameterFromQuery(Name = "search")]
    public string? SearchParam { get; set; }

    [SupplyParameterFromQuery(Name = "from")]
    public string? FromParam { get; set; }

    [SupplyParameterFromQuery(Name = "to")]
    public string? ToParam { get; set; }

    private List<string> selectedTags = new();
    private string searchQuery = string.Empty;
    private TechHub.Core.Models.Section? section;
    private DateOnly? fromDate;
    private DateOnly? toDate;
    private string? fromDateString;
    private string? toDateString;

    protected override void OnInitialized()
    {
        // Verify section exists, redirect to 404 if not
        section = SectionCache.GetSectionByName(SectionName);
        if (section == null)
        {
            Navigation.NavigateTo("/not-found");
            return;
        }

        // Parse tags and dates from URL
        ParseTagsFromUrl();
        ParseSearchFromUrl();
        ParseDatesFromUrl();
    }

    protected override void OnParametersSet()
    {
        ParseTagsFromUrl();
        ParseSearchFromUrl();
        ParseDatesFromUrl();
    }

    private void ParseSearchFromUrl()
    {
        searchQuery = SearchParam ?? string.Empty;
    }

    private void ParseTagsFromUrl()
    {
        if (!string.IsNullOrEmpty(TagsParam))
        {
            // Parse tags from URL
            var rawTags = TagsParam.Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(t => Uri.UnescapeDataString(t.Trim()).ToLowerInvariant())
            .ToList();

            // Deduplicate and normalize tags
            selectedTags = rawTags
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .ToList();

            // If duplicates were removed, clean up the URL
            if (rawTags.Count != selectedTags.Count)
            {
                UpdateUrl();
            }
        }
        else
        {
            selectedTags = new List<string>();
        }
    }

    private void ParseDatesFromUrl()
    {
        fromDate = ParseDate(FromParam);
        toDate = ParseDate(ToParam);
        fromDateString = fromDate?.ToString("yyyy-MM-dd");
        toDateString = toDate?.ToString("yyyy-MM-dd");
    }

    private static DateOnly? ParseDate(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return null;
        }

        return DateOnly.TryParse(value, out var date) ? date : null;
    }

    private void UpdateUrl()
    {
        var basePath = $"/{SectionName}";
        var queryParams = new List<string>();

        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            queryParams.Add($"search={Uri.EscapeDataString(searchQuery)}");
        }

        if (selectedTags.Count > 0)
        {
            var tagsParam = string.Join(",", selectedTags.Select(t => Uri.EscapeDataString(t)));
            queryParams.Add($"tags={tagsParam}");
        }

        if (fromDate.HasValue)
        {
            queryParams.Add($"from={fromDate.Value:yyyy-MM-dd}");
        }

        if (toDate.HasValue)
        {
            queryParams.Add($"to={toDate.Value:yyyy-MM-dd}");
        }

        var url = queryParams.Count > 0
            ? $"{basePath}?{string.Join("&", queryParams)}"
            : basePath;

        Navigation.NavigateTo(url, replace: true);
    }

    private void HandleSearchQueryChanged(string query)
    {
        searchQuery = query;
        UpdateUrl();
    }

    private void HandleTagSelectionChanged(List<string> tags)
    {
        selectedTags = tags;
        StateHasChanged();
    }

    private void HandleDateRangeChanged(DateRangeChangedEventArgs args)
    {
        fromDate = args.FromDate;
        toDate = args.ToDate;
        fromDateString = fromDate?.ToString("yyyy-MM-dd");
        toDateString = toDate?.ToString("yyyy-MM-dd");

        // URL update is handled by the DateRangeSlider component directly,
        // because this parent page is static SSR and cannot call NavigateTo
        // during the interactive phase.

        StateHasChanged();
    }
}