@page "/github-copilot/vscode-updates"
@page "/github-copilot/vscode-updates/{VideoSlug}"
@using TechHub.Core.Models
@using TechHub.Web.Services

@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ErrorService ErrorService
@inject ILogger<GitHubCopilotVSCodeUpdates> Logger

<PageTitle>@GetPageTitle() - Tech Hub</PageTitle>

<HeadContent>
    <link rel="canonical" href="https://tech.hub.ms/github-copilot/vscode-updates" />
</HeadContent>

<SkipLink />

<Header SectionName="github-copilot" />

<main class="page-with-sidebar">
    <aside class="sidebar">
        @if (videoItems.Any())
        {
            <div class="sidebar-section">
                <h2 class="sidebar-h2">All Updates</h2>
                <ul class="sidebar-list">
                    @foreach (var video in videoItems)
                    {
                        var isActive = video.Slug == selectedVideoSlug;
                        <li>
                            <a href="/github-copilot/vscode-updates/@video.Slug"
                                class="sidebar-content-button @(isActive ? "active" : "")">
                                <span class="sidebar-content-button-title">@video.Title</span>
                                <span class="sidebar-content-button-meta">
                                    <time datetime="@FormatDateIso(video.DateEpoch)">@FormatDate(video.DateEpoch)</time>
                                </span>
                            </a>
                        </li>
                    }
                </ul>
            </div>
        }

        @if (selectedVideoDetail != null && !string.IsNullOrWhiteSpace(selectedVideoDetail.RenderedHtml))
        {
            <SidebarToc HtmlContent="@selectedVideoDetail.RenderedHtml" Title="Table of Contents" />
        }
    </aside>

    @if (selectedVideoDetail != null)
    {
        <ContentItemDetail Item="@selectedVideoDetail" Id="skiptohere" />
    }
    else
    {
        <article id="skiptohere" tabindex="-1" class="article-body">
            <p class="no-content-message">No updates available yet.</p>
        </article>
    }
</main>

@code {
    private const string VideoCollectionName = "vscode-updates";

    [Parameter]
    public string? VideoSlug { get; set; }

    private List<TechHub.Core.Models.ContentItem> videoItems = new();
    private TechHub.Core.Models.ContentItem? selectedVideoDetail;
    private string selectedVideoSlug = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPageData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // When URL parameter changes, reload the selected video
        if (videoItems.Any())
        {
            await LoadSelectedVideo();
        }
    }

    private async Task LoadPageData()
    {
        try
        {
            var allVideos = await ApiClient.GetContentAsync(null, "videos");
            videoItems = (allVideos ?? Enumerable.Empty<TechHub.Core.Models.ContentItem>())
                .Where(v => v.SubcollectionName == VideoCollectionName)
                .OrderByDescending(v => v.DateEpoch)
                .ToList();

            await LoadSelectedVideo();
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }

    private async Task LoadSelectedVideo()
    {
        if (!videoItems.Any()) return;

        // Use URL parameter or default to first (latest) video
        selectedVideoSlug = !string.IsNullOrEmpty(VideoSlug)
        ? VideoSlug
        : videoItems.First().Slug;

        // Verify the slug exists in our list
        var videoExists = videoItems.Any(v => v.Slug == selectedVideoSlug);
        if (!videoExists)
        {
            selectedVideoSlug = videoItems.First().Slug;
        }

        selectedVideoDetail = await ApiClient.GetContentDetailAsync(
        "github-copilot",
        "videos",
        selectedVideoSlug);
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }

    private static string FormatDateIso(long epochSeconds) =>
        DateTimeOffset.FromUnixTimeSeconds(epochSeconds).ToString("yyyy-MM-dd");

    private string GetPageTitle()
    {
        // If a specific video is selected, use its title
        if (selectedVideoDetail != null)
        {
            return selectedVideoDetail.Title;
        }

        // Otherwise use the page title
        return "Visual Studio Code Updates";
    }
}