@page "/{sectionName}/{collection}/{itemId}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(item?.Title ?? "Loading...") - Tech Hub</PageTitle>

@if (sectionData != null)
{
    <HeadContent>
        <link rel="canonical" href="@($"https://tech.hub.ms/{SectionName.ToLowerInvariant()}/{Collection.ToLowerInvariant()}/{ItemId.ToLowerInvariant()}")" />
        <link rel="alternate" type="application/rss+xml" 
              title="Tech Hub - @(sectionData.Title) - RSS Feed" 
              href="@($"{sectionData.Url}/feed.xml")" />
    </HeadContent>
}

@if (isLoading)
{
    <div class="loading">
        <p>Loading content...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="error">
        <h2>Error Loading Content</h2>
        <p>@errorMessage</p>
        <button @onclick="LoadContent">Retry</button>
    </div>
}
else if (sectionData != null && item != null)
{
    @* Category Header (same as section pages) *@
    <PageHeader Section="@sectionData" />
    
    <div class="page-with-sidebar">
        @* Sidebar with metadata *@
        <aside class="sidebar">
            @* Collections Navigation *@
            <div class="sidebar-section collections-nav">
                <h2 class="sidebar-h2">Collections</h2>
                <ul class="sidebar-links">
                    <li>
                        <a href="/@(sectionData.Name)/all" 
                           class="@(Collection.ToLowerInvariant() == "all" ? "active" : "")">
                            All
                        </a>
                    </li>
                    @foreach (var collection in sectionData.Collections.Where(c => !c.IsCustom))
                    {
                        <li>
                            <a href="/@(sectionData.Name)/@(collection.Name)" 
                               class="@(Collection.ToLowerInvariant() == collection.Name.ToLowerInvariant() ? "active" : "")">
                                @collection.Title
                            </a>
                        </li>
                    }
                </ul>
            </div>

            @* Tags Section *@
            @if (item.Tags.Any())
            {
                <div class="sidebar-section article-tags">
                    <h2 class="sidebar-h2">Tags</h2>
                    <div class="tags-cloud">
                        @foreach (var tag in item.Tags)
                        {
                            <a href="/@(SectionName.ToLowerInvariant())?tags=@Uri.EscapeDataString(tag)" class="sidebar-tag">@tag</a>
                        }
                    </div>
                </div>
            }
        </aside>

        @* Main content area *@
        <main class="page-main-content" id="top">
            <ContentItemDetail Item="@item" />

            <nav class="content-navigation">
                <a href="#top" @onclick="ScrollToTop" @onclick:preventDefault class="nav-button primary">Back to Top</a>
                <a href="/@(SectionName.ToLowerInvariant())" class="nav-button secondary">Back to @GetSectionDisplayName(SectionName)</a>
            </nav>
        </main>
    </div>
}

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string Collection { get; set; } = null!;

    [Parameter]
    public string ItemId { get; set; } = null!;

    private SectionDto? sectionData;
    private ContentItemDetailDto? item;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadContent();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(SectionName) && !string.IsNullOrEmpty(Collection) && !string.IsNullOrEmpty(ItemId))
        {
            await LoadContent();
        }
    }

    private async Task LoadContent()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Load section and item in parallel
            var sectionTask = ApiClient.GetSectionAsync(SectionName.ToLowerInvariant());
            var itemTask = ApiClient.GetContentDetailAsync(SectionName.ToLowerInvariant(), Collection.ToLowerInvariant(), ItemId.ToLowerInvariant());
            
            await Task.WhenAll(sectionTask, itemTask);
            
            sectionData = await sectionTask;
            item = await itemTask;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load content: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ScrollToTop()
    {
        Navigation.NavigateTo(Navigation.Uri.Split('#')[0], forceLoad: false);
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }
}

