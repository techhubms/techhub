@page "/{sectionName}/{collection}/{itemId}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(item?.Title ?? "Loading...") - Tech Hub</PageTitle>

@if (sectionData == null)
{
    <p class="error-message">Error: Section data could not be loaded.</p>
}
else
{
    <HeadContent>
        <link rel="canonical"
            href="@($"https://tech.hub.ms/{SectionName.ToLowerInvariant()}/{Collection.ToLowerInvariant()}/{ItemId.ToLowerInvariant()}")" />
        <link rel="alternate" type="application/rss+xml" title="Tech Hub - @sectionData.Title - RSS Feed"
            href="@($"{sectionData.Url}/feed.xml")" />
    </HeadContent>

    <PageHeader Section="@sectionData" />

    <div class="page-with-sidebar">
        @* Sidebar with metadata *@
        <aside class="sidebar">
            @* Collections Navigation *@
            <SidebarCollectionNav Section="@sectionData" SelectedCollection="@Collection" />

            @* Tags Section - only show when item is loaded *@
            @if (item != null)
            {
                <SidebarTags Tags="@item.Tags" Title="Tags" BaseUrl="@($"/{SectionName.ToLowerInvariant()}")"
                    CssClass="article-tags" />
            }
        </aside>

        @* Main content area *@
        <main class="page-main-content" id="top">
            @if (isLoadingItem)
            {
                <div class="loading">
                    <p>Loading content...</p>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="error">
                    <h2>Error Loading Content</h2>
                    <p>@errorMessage</p>
                    <button @onclick="LoadItem">Retry</button>
                </div>
            }
            else if (item != null)
            {
                <ContentItemDetail Item="@item" />

                <nav class="content-navigation">
                    <a href="#top" @onclick="ScrollToTop" @onclick:preventDefault class="nav-button primary">Back to Top</a>
                    <a href="/@(SectionName.ToLowerInvariant())" class="nav-button secondary">Back to
                        @GetSectionDisplayName(SectionName)</a>
                </nav>
            }
        </main>
    </div>
}

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string Collection { get; set; } = null!;

    [Parameter]
    public string ItemId { get; set; } = null!;

    private SectionDto? sectionData;
    private ContentItemDetailDto? item;
    private bool isLoadingItem = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        // Load section first (SSR)
        await LoadSection();
        // Then load item (can be async)
        await LoadItem();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(SectionName) && !string.IsNullOrEmpty(Collection) && !string.IsNullOrEmpty(ItemId))
        {
            // Reload section if changed
            if (sectionData != null && sectionData.Name != SectionName)
            {
                await LoadSection();
            }
            await LoadItem();
        }
    }

    private async Task LoadSection()
    {
        try
        {
            sectionData = await ApiClient.GetSectionAsync(SectionName.ToLowerInvariant());
            if (sectionData == null)
            {
                Navigation.NavigateTo("/not-found");
            }
        }
        catch
        {
            Navigation.NavigateTo("/not-found");
        }
    }

    private async Task LoadItem()
    {
        isLoadingItem = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            item = await ApiClient.GetContentDetailAsync(SectionName.ToLowerInvariant(), Collection.ToLowerInvariant(),
            ItemId.ToLowerInvariant());
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load content: {ex.Message}";
        }
        finally
        {
            isLoadingItem = false;
            StateHasChanged();
        }
    }

    private void ScrollToTop()
    {
        Navigation.NavigateTo(Navigation.Uri.Split('#')[0], forceLoad: false);
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }
}