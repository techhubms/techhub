@page "/{sectionName}/{collectionName}/{slug}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services

@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(item?.Title ?? "Loading...") - Tech Hub</PageTitle>

<HeadContent>
    <link rel="canonical"
        href="@($"https://tech.hub.ms/{SectionName.ToLowerInvariant()}/{CollectionName.ToLowerInvariant()}/{Slug.ToLowerInvariant()}")" />
    <link rel="alternate" type="application/rss+xml" title="Tech Hub - @GetSectionDisplayName(SectionName) - RSS Feed"
        href="@($"/{SectionName}/feed.xml")" />
</HeadContent>

<Header SectionName="@SectionName" />

<main class="page-with-sidebar">
    <aside class="sidebar">
        @if (item != null)
        {
            var navigationUrl = GetPrimarySectionUrl();
            @* Tag cloud for this content item - navigate to primary section with tag filter *@
            <SidebarTagCloud Scope="TagCloudScope.Content" SectionName="@SectionName" CollectionName="@CollectionName"
                Slug="@Slug" Title="Tags" NavigationMode="TagCloudNavigationMode.Navigate"
                NavigationBaseUrl="@navigationUrl" />
            <SidebarToc HtmlContent="@item.RenderedHtml" Title="Table of Contents" />
        }
    </aside>

    @* Main content area *@
    <article>
        @if (item != null)
        {
            <ContentItemDetail Item="@item" />
        }
    </article>
</main>

<ConditionalScripts LoadSyntaxHighlighting="true" LoadMermaid="true" LoadTocScrollSpy="true" />

@code {
    [Inject] public required ErrorService ErrorService { get; set; }
    [Inject] public required ILogger<ContentItem> Logger { get; set; }
    [Inject] public required SectionCache SectionCache { get; set; }

    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string CollectionName { get; set; } = null!;

    [Parameter]
    public string Slug { get; set; } = null!;

    private ContentItemDetailDto? item;

    protected override async Task OnInitializedAsync()
    {
        // Verify section exists
        if (SectionCache.GetSectionByName(SectionName) == null)
        {
            Navigation.NavigateTo("/not-found");
            return;
        }

        // Load item
        await LoadItem();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(SectionName) && !string.IsNullOrEmpty(CollectionName) && !string.IsNullOrEmpty(Slug))
        {
            await LoadItem();
        }
    }

    private async Task LoadItem()
    {
        try
        {
            item = await ApiClient.GetContentDetailAsync(SectionName.ToLowerInvariant(), CollectionName.ToLowerInvariant(),
            Slug.ToLowerInvariant());

            if (item == null)
            {
                Navigation.NavigateTo("/not-found");
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }

    private void ScrollToTop()
    {
        Navigation.NavigateTo(Navigation.Uri.Split('#')[0], forceLoad: false);
    }

    /// <summary>
    /// Gets the URL for the primary section (used for tag click navigation)
    /// Falls back to current section if primarySection is not available
    /// </summary>
    private string GetPrimarySectionUrl()
    {
        var primarySection = item?.PrimarySectionName;
        if (!string.IsNullOrEmpty(primarySection))
        {
            // Convert display name to URL slug if needed
            return $"/{SectionHelper.GetSectionUrl(primarySection)}";
        }

        // Fallback to current section
        return $"/{SectionName.ToLowerInvariant()}";
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }
}