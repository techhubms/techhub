@page "/{sectionName}/{collectionName}/{slug}"
@using TechHub.Core.Models
@using TechHub.Web.Services
@implements IDisposable

@inject IJSRuntime JS
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(item?.Title ?? (isLoading ? "" : "Not Found")) - Tech Hub</PageTitle>

<main class="page-with-sidebar">
    <aside class="sidebar">
        <MobileSidebarToolbar>
        @if (item != null)
        {
            @* Tag cloud showing this content item's tags with real section counts *@
            <MobileSidebarPanel Label="Tags" Icon="tags">
            <SidebarTagCloud Tags="@item.Tags"
                SectionName="@SectionName"
                Title="Tags" NavigationMode="TagCloudNavigationMode.Navigate"
                NavigationBaseUrl="@($"/{SectionName.ToLowerInvariant()}")" />
            </MobileSidebarPanel>
            <MobileSidebarPanel Label="Table of Contents" Icon="toc">
            <SidebarToc HtmlContent="@item.RenderedHtml" Title="Table of Contents" />
            </MobileSidebarPanel>
        }
        </MobileSidebarToolbar>
    </aside>

    @* Main content area *@
    @if (item != null)
    {
        <ContentItemDetail Item="@item" />
    }
    else if (!isLoading)
    {
        <section>
            <h1>Not Found</h1>
            <p>Sorry, the content you are looking for does not exist.</p>
            <p><a href="/" class="back-link">‚Üê Back to Home</a></p>
        </section>
    }
</main>

@code {
    [Inject] public required ErrorService ErrorService { get; set; }
    [Inject] public required ILogger<ContentItem> Logger { get; set; }
    [Inject] public required SectionCache SectionCache { get; set; }
    [Inject] public required PersistentComponentState ApplicationState { get; set; }

    private PersistingComponentStateSubscription? _persistSubscription;

    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string CollectionName { get; set; } = null!;

    [Parameter]
    public string Slug { get; set; } = null!;

    private TechHub.Core.Models.ContentItemDetail? item;
    private TechHub.Core.Models.Section? section;
    private bool isLoading = true;
    private string? _previousSectionName;
    private string? _previousCollectionName;
    private string? _previousSlug;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (item != null)
        {
            await JS.InvokeVoidAsync("markScriptsLoading");
            await JS.InvokeVoidAsync("initHighlighting");
            await JS.InvokeVoidAsync("initMermaid");
            await JS.InvokeVoidAsync("initTocScrollSpy");
            await JS.InvokeVoidAsync("markScriptsReady");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Verify section exists
        section = SectionCache.GetSectionByName(SectionName);
        if (section == null)
        {
            Navigation.NavigateTo("/not-found");
            return;
        }

        _persistSubscription = ApplicationState.RegisterOnPersisting(PersistState);

        // Initialize change-tracking fields from current parameter values
        _previousSectionName = SectionName;
        _previousCollectionName = CollectionName;
        _previousSlug = Slug;

        if (!string.IsNullOrEmpty(SectionName) && !string.IsNullOrEmpty(CollectionName) && !string.IsNullOrEmpty(Slug))
        {
            await LoadItem();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload when route parameters actually change (e.g., navigating between content items)
        if (SectionName != _previousSectionName || CollectionName != _previousCollectionName || Slug != _previousSlug)
        {
            _previousSectionName = SectionName;
            _previousCollectionName = CollectionName;
            _previousSlug = Slug;

            section = SectionCache.GetSectionByName(SectionName);
            if (section == null)
            {
                Navigation.NavigateTo("/not-found");
                return;
            }

            await LoadItem();
        }
    }

    private async Task LoadItem()
    {
        try
        {
            isLoading = true;

            var stateKey = $"content-item-{SectionName}-{CollectionName}-{Slug}";
            if (ApplicationState.TryTakeFromJson<TechHub.Core.Models.ContentItemDetail>(stateKey, out var restored) && restored != null)
            {
                item = restored;
                return;
            }

            item = await ApiClient.GetContentDetailAsync(SectionName.ToLowerInvariant(), CollectionName.ToLowerInvariant(),
            Slug.ToLowerInvariant());

            if (item == null)
            {
                // Content not found - navigate to not found page
                Navigation.NavigateTo("/not-found");
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task PersistState()
    {
        if (item != null)
        {
            var stateKey = $"content-item-{SectionName}-{CollectionName}-{Slug}";
            ApplicationState.PersistAsJson(stateKey, item);
        }
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _persistSubscription?.Dispose();
        GC.SuppressFinalize(this);
    }

    private void ScrollToTop()
    {
        Navigation.NavigateTo(Navigation.Uri.Split('#')[0], forceLoad: false);
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }
}