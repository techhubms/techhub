@page "/ai/sdlc"
@using TechHub.Core.Models
@using TechHub.Web.Services
@rendermode InteractiveServer

@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ErrorService ErrorService
@inject ILogger<AISDLC> Logger

<PageTitle>@(pageData?.Title ?? "AI SDLC") - Tech Hub</PageTitle>

@if (sectionData != null && pageData != null)
{
    <HeadContent>
        <link rel="canonical" href="https://tech.hub.ms/ai/sdlc" />
    </HeadContent>

    <SkipLink />

    <Header SectionName="ai" />

    <main class="page-with-sidebar">
        <aside class="sidebar">
            <SidebarToc HtmlContent="@GetRenderedContent()" Title="Table of Contents" />
        </aside>

        <article id="skiptohere" tabindex="-1" class="article-body">
            <div class="content-detail-header">
                <h1 class="page-h1">@pageData.Title</h1>
                @if (!string.IsNullOrWhiteSpace(pageData.Description))
                {
                    <p class="page-description">@pageData.Description</p>
                }
            </div>

            <div class="custom-page-container">
                <div class="custom-page-intro">
                    <p>@pageData.Intro</p>
                </div>

                @* SDLC Phases *@
                <section class="sdlc-phases">
                    <h2>SDLC Phases</h2>
                    @{
                        int phaseIndex = 0;
                        foreach (var phase in pageData.Phases)
                        {
                            var currentIndex = phaseIndex;
                            <div class="sdlc-phase-card sdlc-phase-@phase.Id">
                                <button class="sdlc-phase-header" type="button" aria-expanded="@IsPhaseExpanded(currentIndex)" @onclick="() => TogglePhase(currentIndex)">
                                    <span class="sdlc-phase-icon">@phase.Icon</span>
                                    <h3 id="phase-@phase.Id">@phase.Name</h3>
                                    <span class="sdlc-phase-toggle @(IsPhaseExpanded(currentIndex) ? "expanded" : "")">â–¼</span>
                                </button>

                                <div class="sdlc-phase-content @(IsPhaseExpanded(currentIndex) ? "expanded" : "")">
                                <div class="sdlc-phase-what">
                                    <h4>What</h4>
                                    <p>@phase.What</p>
                                </div>

                                @if (!string.IsNullOrEmpty(phase.How))
                                {
                                    <div class="sdlc-phase-how">
                                        <h4>How</h4>
                                        <p>@phase.How</p>
                                    </div>
                                }

                                <div class="sdlc-phase-tools">
                                    <h4>Tools</h4>
                                    <ul>
                                        @foreach (var tool in phase.Tools)
                                        {
                                            <li><a href="@tool.Url" target="_blank" rel="noopener">@tool.Name</a></li>
                                        }
                                    </ul>
                                </div>

                                <div class="sdlc-phase-ai">
                                    <h4>AI Enhancements</h4>
                                    <p>@phase.AIEnhancements.Intro</p>
                                    <div class="sdlc-roles">
                                        @foreach (var role in phase.AIEnhancements.Roles)
                                        {
                                            <div class="sdlc-role">
                                                <strong>@role.Role:</strong> @role.Content
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (phase.TestingTypes != null)
                                {
                                    <div class="sdlc-phase-testing">
                                        <h4>Testing Types</h4>
                                        <div class="sdlc-testing-types">
                                            @foreach (var testType in phase.TestingTypes)
                                            {
                                                <div class="sdlc-testing-type">
                                                    <strong>@testType.Name:</strong> @testType.Description
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(phase.Handover))
                                {
                                    <div class="sdlc-phase-handover">
                                        <h4>Handover</h4>
                                        <p>@phase.Handover</p>
                                    </div>
                                }

                                <div class="sdlc-phase-best-practices">
                                    <h4>Best Practices</h4>
                                    <p>@phase.BestPractices</p>
                                </div>
                            </div>
                        </div>
                        phaseIndex++;
                    }
                    }
                </section>

                @* Preconditions *@
                <section class="sdlc-preconditions">
                    <h2 id="preconditions">Preconditions for Success</h2>
                    <div class="sdlc-preconditions-grid">
                        @foreach (var precondition in pageData.Preconditions)
                        {
                            <div id="precondition-@precondition.Id" class="sdlc-precondition-card">
                                <div class="sdlc-precondition-header">
                                    <span class="sdlc-precondition-icon">@precondition.Icon</span>
                                    <h3 id="precondition-@(precondition.Title.ToLowerInvariant().Replace(" ", "-"))">@precondition.Title</h3>
                                </div>
                                <p>@precondition.Description</p>
                                <div class="sdlc-precondition-actions">
                                    <h4>Actions</h4>
                                    <ul>
                                        @foreach (var action in precondition.Actions)
                                        {
                                            <li>@action</li>
                                        }
                                    </ul>
                                </div>
                                @if (!string.IsNullOrEmpty(precondition.Example))
                                {
                                    <div class="sdlc-precondition-example">
                                        <h4>Example</h4>
                                        <p>@precondition.Example</p>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(precondition.Why))
                                {
                                    <div class="sdlc-precondition-why">
                                        <h4>Why</h4>
                                        <p>@precondition.Why</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </section>

                @* Benefits *@
                <section class="sdlc-benefits">
                    <h2 id="benefits">Benefits of AI in SDLC</h2>
                    <div class="sdlc-benefits-grid">
                        @foreach (var benefit in pageData.AdditionalInfo.Benefits)
                        {
                            <div class="sdlc-benefit-card">
                                <span class="sdlc-benefit-icon">@benefit.Icon</span>
                                <h3 id="benefit-@(benefit.Title.ToLowerInvariant().Replace(" ", "-"))">@benefit.Title</h3>
                                <p>@benefit.Description</p>
                            </div>
                        }
                    </div>
                </section>

                @* Metrics *@
                <section class="sdlc-metrics">
                    <h2 id="metrics">Measuring Success</h2>
                    <p>@pageData.AdditionalInfo.Metrics.Intro</p>
                    <div class="sdlc-metrics-frameworks">
                        @foreach (var framework in pageData.AdditionalInfo.Metrics.Frameworks)
                        {
                            <div class="sdlc-framework-card">
                                <span class="sdlc-framework-icon">@framework.Icon</span>
                                <h3 id="metric-@(framework.Name.ToLowerInvariant().Replace(" ", "-"))">@framework.Name</h3>
                                <p>@framework.Description</p>
                            </div>
                        }
                    </div>
                    <div class="sdlc-metrics-see-also">
                        <a
                            href="@pageData.AdditionalInfo.Metrics.SeeAlso.Url">@pageData.AdditionalInfo.Metrics.SeeAlso.Text</a>
                    </div>
                </section>

                @* Challenges *@
                <section class="sdlc-challenges">
                    <h2 id="challenges">Challenges</h2>
                    <div class="sdlc-challenges-grid">
                        @foreach (var challenge in pageData.AdditionalInfo.Challenges)
                        {
                            <div class="sdlc-challenge-card">
                                <h3 id="challenge-@(challenge.Title.ToLowerInvariant().Replace(" ", "-"))">@challenge.Title</h3>
                                <p>@challenge.Description</p>
                            </div>
                        }
                    </div>
                </section>

                @* Methodologies *@
                <section class="sdlc-methodologies">
                    <h2 id="methodologies">Methodologies</h2>
                    <div class="sdlc-methodologies-grid">
                        @foreach (var methodology in pageData.AdditionalInfo.Methodologies)
                        {
                            <div class="sdlc-methodology-card">
                                <h3 id="methodology-@(methodology.Name.ToLowerInvariant().Replace(" ", "-"))">@methodology.Name</h3>
                                <span class="sdlc-methodology-type">@methodology.Type</span>
                                <p>@methodology.Description</p>
                                <div class="sdlc-methodology-details">
                                    <div><strong>Best For:</strong> @methodology.BestFor</div>
                                    <div><strong>Cycle Time:</strong> @methodology.CycleTime</div>
                                    <div><strong>Flexibility:</strong> @methodology.Flexibility</div>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            </div>
        </article>
    </main>
}

@code {
    private TechHub.Core.Models.Section? sectionData;
    private SDLCPageData? pageData;
    private HashSet<int> expandedPhases = new(); // No phases expanded by default

    private string GetRenderedContent()
    {
        if (pageData == null)
            return string.Empty;

        var sb = new System.Text.StringBuilder();

        // SDLC Phases (h2 for phase names, already rendered as h3 in actual HTML)
        foreach (var phase in pageData.Phases)
        {
            sb.Append($"<h2 id=\"phase-{phase.Id}\">{phase.Name}</h2>");
        }

        // Additional sections with their h3 subsections
        sb.Append("<h2 id=\"preconditions\">Preconditions</h2>");
        foreach (var precondition in pageData.Preconditions)
        {
            var preconditionId = $"precondition-{precondition.Title.ToLowerInvariant().Replace(" ", "-")}";
            sb.Append($"<h3 id=\"{preconditionId}\">{precondition.Title}</h3>");
        }

        sb.Append("<h2 id=\"benefits\">Benefits</h2>");
        foreach (var benefit in pageData.AdditionalInfo.Benefits)
        {
            var benefitId = $"benefit-{benefit.Title.ToLowerInvariant().Replace(" ", "-")}";
            sb.Append($"<h3 id=\"{benefitId}\">{benefit.Title}</h3>");
        }

        sb.Append("<h2 id=\"metrics\">Metrics</h2>");
        foreach (var framework in pageData.AdditionalInfo.Metrics.Frameworks)
        {
            var metricId = $"metric-{framework.Name.ToLowerInvariant().Replace(" ", "-")}";
            sb.Append($"<h3 id=\"{metricId}\">{framework.Name}</h3>");
        }

        sb.Append("<h2 id=\"challenges\">Challenges</h2>");
        foreach (var challenge in pageData.AdditionalInfo.Challenges)
        {
            var challengeId = $"challenge-{challenge.Title.ToLowerInvariant().Replace(" ", "-")}";
            sb.Append($"<h3 id=\"{challengeId}\">{challenge.Title}</h3>");
        }

        sb.Append("<h2 id=\"methodologies\">Methodologies</h2>");
        foreach (var methodology in pageData.AdditionalInfo.Methodologies)
        {
            var methodologyId = $"methodology-{methodology.Name.ToLowerInvariant().Replace(" ", "-")}";
            sb.Append($"<h3 id=\"{methodologyId}\">{methodology.Name}</h3>");
        }

        return sb.ToString();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            sectionData = await ApiClient.GetSectionAsync("ai");
            pageData = await ApiClient.GetSDLCDataAsync();

            if (sectionData == null || pageData == null)
            {
                Navigation.NavigateTo("/not-found");
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }

    private void TogglePhase(int index)
    {
        if (expandedPhases.Contains(index))
        {
            expandedPhases.Remove(index);
        }
        else
        {
            expandedPhases.Add(index);
        }
    }

    private bool IsPhaseExpanded(int index) => expandedPhases.Contains(index);
}