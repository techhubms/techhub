@page "/Error"
@using System.Diagnostics
@using TechHub.Web.Services
@inject IWebHostEnvironment Environment
@inject ErrorService ErrorService

<PageTitle>Error</PageTitle>

<Header>
    <SectionBanner Title="Error" Description="An error occurred while processing your request" />
</Header>

<div class="page-without-sidebar">
    <main class="page-main-content">
        @if (IsDevelopmentOrTest)
        {
            @* Development/Test Mode: Show detailed exception information *@
            @if (LastException != null)
            {
                <div class="error-details">
                    <h2>Exception Details</h2>
                    <p><strong>Type:</strong> @LastException.GetType().FullName</p>
                    <p><strong>Message:</strong> @LastException.Message</p>

                    @if (!string.IsNullOrEmpty(LastException.StackTrace))
                    {
                        <h3>Stack Trace</h3>
                        <pre
                            style="background: #f5f5f5; padding: 1rem; overflow-x: auto; border-radius: 4px;">@LastException.StackTrace</pre>
                    }

                    @if (LastException.InnerException != null)
                    {
                        <h3>Inner Exception</h3>
                        <p><strong>Type:</strong> @LastException.InnerException.GetType().FullName</p>
                        <p><strong>Message:</strong> @LastException.InnerException.Message</p>
                        @if (!string.IsNullOrEmpty(LastException.InnerException.StackTrace))
                        {
                            <pre
                                style="background: #f5f5f5; padding: 1rem; overflow-x: auto; border-radius: 4px;">@LastException.InnerException.StackTrace</pre>
                        }
                    }
                </div>
            }
            else
            {
                <div class="error-message">
                    <p>No exception details available.</p>
                </div>
            }

            @if (ShowRequestId)
            {
                <p style="margin-top: 2rem;">
                    <strong>Request ID:</strong> <code>@RequestId</code>
                </p>
            }

            <div
                style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <h3>⚠️ Development/Test Mode</h3>
                <p>
                    You're seeing detailed exception information because the application is running in
                    <strong>@Environment.EnvironmentName</strong> environment.
                </p>
                <p>
                    <strong>Note:</strong> This information should never be displayed to users in production as it may
                    contain sensitive details about your application's internals.
                </p>
            </div>
        }
        else
        {
            @* Production Mode: Show friendly error message only *@
            <div class="error-message">
                <h2>Something went wrong</h2>
                <p>
                    We're sorry, but an unexpected error occurred while processing your request.
                    The error has been logged and our team will investigate.
                </p>
                <p>
                    Please try again later or <a href="/">return to the homepage</a>.
                </p>

                @if (ShowRequestId)
                {
                    <p style="margin-top: 2rem; font-size: 0.875rem; color: #666;">
                        If you need to contact support, please reference this Request ID: <code>@RequestId</code>
                    </p>
                }
            </div>
        }
    </main>
</div>

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);
    private Exception? LastException { get; set; }
    private bool IsDevelopmentOrTest => Environment.IsDevelopment() || Environment.IsEnvironment("Test");

    protected override void OnInitialized()
    {
        RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
        LastException = ErrorService.GetLastException();
    }
}