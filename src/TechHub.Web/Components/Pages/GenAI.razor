@page "/ai/genai-basics"
@page "/ai/genai-applied"
@page "/ai/genai-advanced"
@using TechHub.Core.Models
@using TechHub.Web.Services
@implements IDisposable

@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@inject ErrorService ErrorService
@inject ILogger<GenAI> Logger
@inject PersistentComponentState ApplicationState

<PageTitle>@(pageData?.Title ?? PageType) - Tech Hub</PageTitle>

@if (sectionData != null && pageData != null)
{
    <HeadContent>
        <link rel="canonical" href="@GetCanonicalUrl()" />
    </HeadContent>

    <SkipLink />

    <Header SectionName="ai" />

    <main class="page-with-sidebar">
        <aside class="sidebar">
            <SidebarToc HtmlContent="@GetRenderedContent()" Title="Table of Contents" />
        </aside>

        <article class="article-body">
            <div class="content-detail-header">
                <h1 id="skiptohere" class="page-h1">@pageData.Title</h1>
                @if (!string.IsNullOrWhiteSpace(pageData.Description))
                {
                    <p class="page-description">@pageData.Description</p>
                }
            </div>

            <div class="genai-container">
                @foreach (var genAISection in pageData.Sections)
                {
                    <section class="genai-section">
                        <h2 id="@GenerateSectionId(genAISection.Title)">@genAISection.Title</h2>

                        @* Content is already rendered HTML from API *@
                        <div class="genai-content">
                            <SafeMarkup Html="@genAISection.Content" />
                        </div>

                        @* FAQ blocks *@
                        @if (genAISection.Faq != null && genAISection.Faq.Any())
                        {
                            <div class="genai-faq">
                                <div class="genai-faq-header">
                                    <span class="genai-faq-icon" aria-hidden="true">‚ùì</span>
                                    <span class="genai-faq-title">@genAISection.Title FAQ</span>
                                </div>
                                @foreach (var faq in genAISection.Faq)
                                {
                                    <div class="genai-faq-item">
                                        <div class="genai-faq-question">@faq.Question</div>
                                        <div class="genai-faq-answer">@faq.Answer</div>
                                    </div>
                                }
                            </div>
                        }

                        @* More information links *@
                        @if (genAISection.MoreInfo != null && genAISection.MoreInfo.Any())
                        {
                            <div class="genai-more-info">
                                <div class="genai-more-info-header">
                                    <span class="genai-more-info-icon" aria-hidden="true">üìö</span>
                                    <span class="genai-more-info-title">More information</span>
                                </div>
                                <ul>
                                    @foreach (var link in genAISection.MoreInfo)
                                    {
                                        <li><a href="@link.Url" target="_blank" rel="noopener">@link.Text</a></li>
                                    }
                                </ul>
                            </div>
                        }
                    </section>
                }
            </div>
        </article>
    </main>
}

@code {
    private TechHub.Core.Models.Section? sectionData;
    private GenAIPageData? pageData;
    private PersistingComponentStateSubscription? _persistSubscription;
    private string? _previousPageType;
    private string PageType => DeterminePageType();

    /// <summary>
    /// Determine which page type based on current route
    /// </summary>
    private string DeterminePageType()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath.ToLowerInvariant();

        if (path.Contains("genai-basics")) return "basics";
        if (path.Contains("genai-applied")) return "applied";
        if (path.Contains("genai-advanced")) return "advanced";

        return "basics"; // fallback
    }

    /// <summary>
    /// Get canonical URL based on page type
    /// </summary>
    private string GetCanonicalUrl()
    {
        return PageType switch
        {
            "basics" => "https://tech.hub.ms/ai/genai-basics",
            "applied" => "https://tech.hub.ms/ai/genai-applied",
            "advanced" => "https://tech.hub.ms/ai/genai-advanced",
            _ => "https://tech.hub.ms/ai/genai-basics"
        };
    }

    /// <summary>
    /// Generate section ID from title (lowercase, special chars removed, spaces to hyphens)
    /// </summary>
    private static string GenerateSectionId(string title)
    {
        return title
        .ToLowerInvariant()
        .Replace(" ", "-", StringComparison.Ordinal)
        .Replace(":", "", StringComparison.Ordinal)
        .Replace("&", "and", StringComparison.Ordinal)
        .Replace("(", "", StringComparison.Ordinal)
        .Replace(")", "", StringComparison.Ordinal)
        .Trim();
    }

    /// <summary>
    /// Generate HTML content for TOC extraction.
    /// SidebarToc will extract headings from this HTML automatically.
    /// Includes both H2 section titles AND all nested headings from content.
    /// </summary>
    private string GetRenderedContent()
    {
        if (pageData == null)
            return string.Empty;

        var sb = new System.Text.StringBuilder();
        foreach (var genAISection in pageData.Sections)
        {
            // Add H2 section title
            sb.Append($"<h2 id=\"{GenerateSectionId(genAISection.Title)}\">{genAISection.Title}</h2>");

            // Add all content HTML which includes nested headings (h3, h4, etc.)
            sb.Append(genAISection.Content);
        }
        return sb.ToString();
    }

    protected override async Task OnInitializedAsync()
    {
        _persistSubscription = ApplicationState.RegisterOnPersisting(PersistState);
        _previousPageType = PageType;
        await LoadPageData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload when the page type changes (navigating between genai-basics/applied/advanced)
        var currentPageType = PageType;
        if (currentPageType != _previousPageType)
        {
            _previousPageType = currentPageType;
            await LoadPageData();
        }
    }

    private async Task LoadPageData()
    {
        var stateKey = $"genai-{PageType}";
        if (ApplicationState.TryTakeFromJson<PersistedGenAIData>(stateKey, out var restored) && restored != null)
        {
            sectionData = restored.SectionData;
            pageData = restored.PageData;
            return;
        }

        try
        {
            sectionData = await ApiClient.GetSectionAsync("ai");

            // Load appropriate page data based on route
            pageData = PageType switch
            {
                "basics" => await ApiClient.GetGenAIBasicsDataAsync(),
                "applied" => await ApiClient.GetGenAIAppliedDataAsync(),
                "advanced" => await ApiClient.GetGenAIAdvancedDataAsync(),
                _ => await ApiClient.GetGenAIBasicsDataAsync()
            };

            if (sectionData == null || pageData == null)
            {
                Navigation.NavigateTo("/not-found");
            }
        }
        catch (Exception ex)
        {
            ErrorService.HandleError(ex, Navigation, Logger);
        }
    }

    private Task PersistState()
    {
        if (sectionData != null && pageData != null)
        {
            var stateKey = $"genai-{PageType}";
            ApplicationState.PersistAsJson(stateKey, new PersistedGenAIData
            {
                SectionData = sectionData,
                PageData = pageData
            });
        }
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _persistSubscription?.Dispose();
        GC.SuppressFinalize(this);
    }

    private sealed class PersistedGenAIData
    {
        public TechHub.Core.Models.Section? SectionData { get; set; }
        public GenAIPageData? PageData { get; set; }
    }
}