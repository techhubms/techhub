@page "/{sectionName}/{collection}/{itemId}"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>@(item?.Title ?? "Loading...") - Tech Hub</PageTitle>

@if (sectionData != null)
{
    <HeadContent>
        <link rel="canonical" href="@($"https://tech.hub.ms/{SectionName.ToLowerInvariant()}/{Collection.ToLowerInvariant()}/{ItemId.ToLowerInvariant()}")" />
    </HeadContent>
}

@if (isLoading)
{
    <div class="loading">
        <p>Loading content...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="error">
        <h2>Error Loading Content</h2>
        <p>@errorMessage</p>
        <button @onclick="LoadContent">Retry</button>
    </div>
}
else if (sectionData != null && item != null)
{
    @* Section Header (same as section pages) *@
    <PageHeader Section="@sectionData" />
    
    <div class="content-detail-page">
        @* Sidebar with breadcrumbs and metadata *@
        <aside class="sidebar">
            @* Breadcrumbs *@
            <nav class="breadcrumbs" aria-label="Breadcrumb">
                <ol>
                    <li><a href="/@(SectionName.ToLowerInvariant())">@GetSectionDisplayName(SectionName)</a></li>
                    <li><a href="/@(SectionName.ToLowerInvariant())/@(Collection.ToLowerInvariant())">@GetCollectionDisplayName(Collection)</a></li>
                    <li aria-current="page">@item.Title</li>
                </ol>
            </nav>

            @* Metadata *@
            <div class="sidebar-section">
                <h3>Published</h3>
                <time datetime="@item.DateIso">@FormatDate(item.DateEpoch)</time>
            </div>

            @if (!string.IsNullOrWhiteSpace(item.Author))
            {
                <div class="sidebar-section">
                    <h3>Author</h3>
                    <p>@item.Author</p>
                </div>
            }

            <div class="sidebar-section">
                <h3>Collection</h3>
                <p>@GetCollectionDisplayName(item.CollectionName)</p>
            </div>

            @if (item.Categories.Any())
            {
                <div class="sidebar-section">
                    <h3>Categories</h3>
                    <div class="category-tags">
                        @foreach (var category in item.Categories)
                        {
                            <span class="category-tag">@category</span>
                        }
                    </div>
                </div>
            }

            @if (item.Tags.Any())
            {
                <div class="sidebar-section">
                    <h3>Tags</h3>
                    <div class="content-tags">
                        @foreach (var tag in item.Tags)
                        {
                            <span class="sidebar-content-tag">@tag</span>
                        }
                    </div>
                </div>
            }
            
            @* Collections Navigation *@
            <div class="sidebar-section">
                <h3>Collections</h3>
                <ul class="sidebar-links">
                    <li>
                        <a href="/@(sectionData.Name)/all" 
                           class="@(Collection == "all" ? "active" : "")">
                            All
                        </a>
                    </li>
                    @foreach (var collection in sectionData.Collections.Where(c => !c.IsCustom))
                    {
                        <li>
                            <a href="/@(sectionData.Name)/@(collection.Name)" 
                               class="@(Collection == collection.Name ? "active" : "")">
                                @collection.Title
                            </a>
                        </li>
                    }
                </ul>
            </div>
            
            @* Subscribe *@
            <div class="sidebar-section">
                <h3>Subscribe</h3>
                <ul class="sidebar-links">
                    <li>
                        <a href="@($"{sectionData.Url}/feed.xml")" target="_blank" rel="noopener noreferrer">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
                            </svg>
                            RSS Feed
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        @* Main content area *@
        <main class="content-main" id="top">
            <ContentDetail Item="@item" />

            <nav class="content-navigation">
                <a href="#top" @onclick="ScrollToTop" @onclick:preventDefault class="nav-button primary">Back to Top</a>
                <a href="/@(SectionName.ToLowerInvariant())" class="nav-button secondary">Back to @GetSectionDisplayName(SectionName)</a>
            </nav>
        </main>
    </div>
}

@code {
    [Parameter]
    public string SectionName { get; set; } = null!;

    [Parameter]
    public string Collection { get; set; } = null!;

    [Parameter]
    public string ItemId { get; set; } = null!;

    private SectionDto? sectionData;
    private ContentItemDetailDto? item;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadContent();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(SectionName) && !string.IsNullOrEmpty(Collection) && !string.IsNullOrEmpty(ItemId))
        {
            await LoadContent();
        }
    }

    private async Task LoadContent()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Load section and item in parallel
            var sectionTask = ApiClient.GetSectionAsync(SectionName.ToLowerInvariant());
            var itemTask = ApiClient.GetContentDetailAsync(SectionName.ToLowerInvariant(), Collection.ToLowerInvariant(), ItemId.ToLowerInvariant());
            
            await Task.WhenAll(sectionTask, itemTask);
            
            sectionData = await sectionTask;
            item = await itemTask;
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load content: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ScrollToTop()
    {
        Navigation.NavigateTo(Navigation.Uri.Split('#')[0], forceLoad: false);
    }

    private string FormatDate(long epochSeconds)
    {
        var dateTime = DateTimeOffset.FromUnixTimeSeconds(epochSeconds);
        return dateTime.ToString("MMMM d, yyyy");
    }
}

