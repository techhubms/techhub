@page "/"
@using TechHub.Core.DTOs
@using TechHub.Web.Services
@using static TechHub.Web.Services.SectionHelper

<PageTitle>Tech Hub - Microsoft Technology News & Resources</PageTitle>

<HeadContent>
    <link rel="alternate" type="application/rss+xml" title="Tech Hub - All Content - RSS Feed" href="/all/feed.xml" />
</HeadContent>

<PageHeader Title="Tech Hub"
    Description="Your source for Microsoft technology news, tutorials, and community content" />

<div class="page-with-sidebar">
    @* Sidebar (Left Column) *@
    <aside class="sidebar">
        @* Latest Roundup *@
        @if (roundups != null && roundups.Any())
        {
            <div class="sidebar-section latest-roundup">
                <h2 class="sidebar-h2">Latest Roundup</h2>
                <a href="/all/roundups/@(roundups.First().Slug.ToLowerInvariant())" class="sidebar-featured-link">
                    <span class="sidebar-featured-title">@roundups.First().Title</span>
                    <span class="sidebar-featured-date">@DateTime.Parse(roundups.First().DateIso).ToString("MMM dd, yyyy")</span>
                </a>
            </div>
        }

        @* Latest Items *@
        @if (latestItems != null && latestItems.Any())
        {
            <div class="sidebar-section latest-items">
                <h2 class="sidebar-h2">Latest Content</h2>
                <ul class="sidebar-list">
                    @foreach (var item in latestItems.Take(5))
                    {
                        var sectionUrl = GetSectionUrl(item.PrimarySection);
                        <li>
                            <a href="/@(sectionUrl)/@(item.CollectionName.ToLowerInvariant())/@(item.Slug.ToLowerInvariant())"
                                class="sidebar-content-button">
                                <span class="sidebar-content-button-title">@item.Title</span>
                                <span class="sidebar-content-button-meta">
                                    <span class="sidebar-item-section">@item.PrimarySection</span>
                                    <span class="sidebar-content-button-meta-separator">•</span>
                                    <span
                                        class="sidebar-item-collection">@(GetCollectionDisplayName(item.CollectionName))</span>
                                    <span class="sidebar-content-button-meta-separator">•</span>
                                    <span class="sidebar-item-date">@DateTime.Parse(item.DateIso).ToString("MMM dd, yyyy")</span>
                                </span>
                            </a>
                        </li>
                    }
                </ul>
            </div>
        }

        @* Subscribe Section *@
        <SidebarRssLinks Links="@rssLinks" />

        @* Popular Tags *@
        <SidebarTags Tags="@popularTags" Title="Popular Tags" BaseUrl="/all" MaxTags="15" CssClass="popular-tags" />
    </aside>

    <div class="home-main-content">
        @if (errorMessage != null)
        {
            <div class="error">
                <h2>Error Loading Content</h2>
                <p>@errorMessage</p>
            </div>
        }
        else if (sections != null && sections.Any())
        {
            <SectionCardsGrid Sections="@sections" />
        }
        else
        {
            <div class="no-content">
                <p>No sections available.</p>
            </div>
        }
    </div>
</div>

@code {
    [Inject] public required TechHubApiClient ApiClient { get; set; }

    private static readonly SidebarRssLinks.RssLink[] rssLinks = [
    new("RSS Feed - All Content", "/all/feed.xml"),
new("RSS Feed - Roundups", "/all/roundups/feed.xml"),
new("Newsletter", "https://mailchi.mp/1c8d4b5ea99c/tech-hub", GetNewsletterIcon())
    ];

    private IEnumerable<SectionDto>? sections;
    private IEnumerable<ContentItemDto>? roundups;
    private IEnumerable<ContentItemDto>? latestItems;
    private IEnumerable<string>? popularTags;
    private string? errorMessage;

    private static RenderFragment GetNewsletterIcon() => @<svg width="16" height="16" viewBox="0 0 24 24"
            fill="currentColor" aria-hidden="true">
            <path
                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
    </svg>;

protected override async Task OnInitializedAsync()
{
try
{
// Fetch all content in parallel
var sectionsTask = ApiClient.GetAllSectionsAsync();
var roundupsTask = ApiClient.GetContentAsync(section: null, collection: "roundups");
var latestItemsTask = ApiClient.GetLatestItemsAsync(count: 5);
var popularTagsTask = ApiClient.GetPopularTagsAsync(count: 15);

await Task.WhenAll(sectionsTask, roundupsTask, latestItemsTask, popularTagsTask);

sections = await sectionsTask;

// Get roundups and order by date descending to get the latest ones first
var allRoundups = await roundupsTask;
roundups = allRoundups?.OrderByDescending(r => r.DateEpoch);

latestItems = await latestItemsTask;
popularTags = await popularTagsTask;
}
catch (Exception ex)
{
errorMessage = $"Failed to load content: {ex.Message}";
}
}
}