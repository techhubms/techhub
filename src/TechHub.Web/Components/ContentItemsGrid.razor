@using TechHub.Core.Models
@using TechHub.Core.Configuration
@using TechHub.Web.Services
@inject TechHubApiClient ApiClient
@inject SectionCache SectionCache
@inject ILogger<ContentItemsGrid> Logger
@attribute [StreamRendering]

<section class="collection-content @(isLoading ? "loading" : "")" aria-label="@GetCollectionTitle() content">
    <h1 id="main-content" class="page-h1" tabindex="-1">@GetPageTitle()</h1>

    @if (isLoading && !contentItems.Any())
    {
        <div class="content-grid" role="feed" aria-busy="true" aria-label="Loading content">
            @* Skeleton cards while loading - mimics actual content card structure *@
            @for (int i = 0; i < 6; i++)
            {
                <div class="skeleton-card" aria-hidden="true">
                    <div class="content-header">
                        <div class="skeleton skeleton-card-title"></div>
                        <div class="skeleton skeleton-card-meta"></div>
                    </div>
                    <div class="skeleton skeleton-card-description"></div>
                    <div class="skeleton skeleton-card-description" style="width: 80%;"></div>
                    <div class="content-tags">
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error" role="alert">
            <h2>Error Loading Content</h2>
            <p>@errorMessage</p>
            <button @onclick="LoadContent" aria-label="Retry loading content">Retry</button>
        </div>
    }
    else if (FilteredContentItems.Any())
    {
        <div class="content-grid" role="feed" aria-busy="false">
            @foreach (var item in FilteredContentItems)
            {
                <ContentItemCard Item="@item" ShowCollectionBadge="@ShowCollectionBadge" SectionName="@SectionName" />
            }
        </div>
    }
    else if (FilterTags != null && FilterTags.Count > 0 && contentItems.Any())
    {
        <div class="no-content" role="status">
            <p>No content matches the selected tags. Try selecting different tags or clearing filters.</p>
        </div>
    }
    else
    {
        <div class="no-content" role="status">
            <p>No content available for this collection.</p>
        </div>
    }
</section>

@code {
    [Parameter, EditorRequired]
    public required string SectionName { get; set; }

    [Parameter, EditorRequired]
    public required string CollectionName { get; set; }

    /// <summary>
    /// Tags to filter content by (client-side filtering with OR logic)
    /// </summary>
    [Parameter]
    public List<string>? FilterTags { get; set; }

    private List<ContentItem> contentItems = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string previousCollectionName = string.Empty;
    private List<string>? previousFilterTags;

    private bool ShowCollectionBadge =>
    SectionName.Equals("all", StringComparison.OrdinalIgnoreCase) ||
    CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase);

    /// <summary>
    /// Returns content items filtered by selected tags (if any)
    /// Uses AND logic - content must have ALL selected tags
    /// </summary>
    private IEnumerable<ContentItem> FilteredContentItems
    {
        get
        {
            if (FilterTags == null || FilterTags.Count == 0)
            {
                return contentItems;
            }

            // Filter items that have ALL of the selected tags (AND logic)
            // Case-insensitive matching
            var normalizedTags = FilterTags.Select(t => t.ToLowerInvariant()).ToHashSet();
            return contentItems.Where(item =>
            {
                if (item.Tags == null || item.Tags.Count == 0)
                {
                    return false;
                }

                var itemTagsLower = item.Tags.Select(t => t.ToLowerInvariant()).ToHashSet();
                // ALL selected tags must be present in the item's tags
                return normalizedTags.All(selectedTag => itemTagsLower.Contains(selectedTag));
            });
        }
    }

    protected override async Task OnInitializedAsync()
    {
        previousCollectionName = CollectionName;
        previousFilterTags = FilterTags?.ToList();
        await LoadContent();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload if collection actually changed
        if (CollectionName != previousCollectionName)
        {
            previousCollectionName = CollectionName;
            await LoadContent();
        }

        // Check if filter tags changed (triggers re-render but not reload)
        var tagsChanged = !TagsAreEqual(FilterTags, previousFilterTags);
        if (tagsChanged)
        {
            previousFilterTags = FilterTags?.ToList();
            // No need to reload - filtering is done client-side via FilteredContentItems
            StateHasChanged();
        }
    }

    private static bool TagsAreEqual(List<string>? a, List<string>? b)
    {
        if (a == null && b == null) return true;
        if (a == null || b == null) return false;
        if (a.Count != b.Count) return false;
        return a.OrderBy(x => x).SequenceEqual(b.OrderBy(x => x));
    }

    private async Task LoadContent()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        Logger.LogDebug("LoadContent START: Section={SectionName}, Collection={CollectionName}",
        SectionName, CollectionName);

        try
        {
            IEnumerable<ContentItem>? items = null;

            // Always use the unified collection endpoint with "all" as virtual collection
            // /section/all -> GetCollectionItemsAsync(section, "all")
            // /all/all -> GetCollectionItemsAsync("all", "all")
            // /section/collection -> GetCollectionItemsAsync(section, collection)
            Logger.LogDebug("Calling ApiClient.GetCollectionItemsAsync({SectionName}, {CollectionName})",
                SectionName, CollectionName);
            items = await ApiClient.GetCollectionItemsAsync(SectionName, CollectionName);

            contentItems = items?.ToList() ?? new List<ContentItem>();
            Logger.LogDebug("LoadContent COMPLETE: Loaded {Count} items, isLoading will be set to false", contentItems.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load content for {SectionName}/{CollectionName}", SectionName, CollectionName);
            errorMessage = "Unable to load content";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            Logger.LogDebug("LoadContent FINALLY: isLoading={IsLoading}, contentItems.Count={Count}", isLoading,
            contentItems.Count);
        }
    }

    private string GetCollectionTitle()
    {
        if (CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
        {
            return "All";
        }

        // Try to get DisplayName from section cache first
        var section = SectionCache.GetSectionByName(SectionName);
        var collection = section?.Collections.FirstOrDefault(c => c.Name == CollectionName);
        if (collection != null)
        {
            return collection.DisplayName ?? collection.Title ?? CollectionName;
        }

        // Fallback to SectionHelper
        return SectionHelper.GetCollectionTitle(CollectionName);
    }

    private string GetPageTitle()
    {
        var collectionDisplay = GetCollectionTitle();
        var isAllSection = SectionName.Equals("all", StringComparison.OrdinalIgnoreCase);
        var isAllCollection = CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase);

        // Get proper section display name (e.g., "GitHub Copilot" instead of "github-copilot")
        var sectionDisplayName = SectionHelper.GetSectionDisplayName(SectionName);

        if (isAllSection && isAllCollection)
        {
            // /all → "Browse All Posts"
            return "Browse All Posts";
        }
        else if (isAllSection && !isAllCollection)
        {
            // /all/news → "Browse All News"
            return $"Browse All {collectionDisplay}";
        }
        else if (!isAllSection && isAllCollection)
        {
            // /github-copilot → "Browse All GitHub Copilot Content"
            return $"Browse All {sectionDisplayName} Content";
        }
        else
        {
            // /github-copilot/news → "Browse GitHub Copilot News"
            return $"Browse {sectionDisplayName} {collectionDisplay}";
        }
    }
}