@using TechHub.Core.DTOs
@using TechHub.Core.Configuration
@using TechHub.Web.Services
@using Microsoft.Extensions.Options
@inject TechHubApiClient ApiClient
@inject SectionCache SectionCache
@inject ILogger<ContentItemsGrid> Logger
@inject IOptions<WebAppSettings> AppSettings
@attribute [StreamRendering]

<section class="collection-content @(isLoading ? "loading" : "")" aria-label="@GetCollectionDisplayName() content">
    <h1 id="main-content" class="page-h1" tabindex="-1">@GetPageTitle()</h1>

    @if (isLoading && !contentItems.Any())
    {
        <div class="content-grid" role="feed" aria-busy="true" aria-label="Loading content">
            @* Skeleton cards while loading - mimics actual content card structure *@
            @for (int i = 0; i < 6; i++)
            {
                <div class="skeleton-card" aria-hidden="true">
                    <div class="content-header">
                        <div class="skeleton skeleton-card-title"></div>
                        <div class="skeleton skeleton-card-meta"></div>
                    </div>
                    <div class="skeleton skeleton-card-description"></div>
                    <div class="skeleton skeleton-card-description" style="width: 80%;"></div>
                    <div class="content-tags">
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                        <div class="skeleton skeleton-card-tag"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error" role="alert">
            <h2>Error Loading Content</h2>
            <p>@errorMessage</p>
            <button @onclick="LoadContent" aria-label="Retry loading content">Retry</button>
        </div>
    }
    else if (contentItems.Any())
    {
        <div class="content-grid" role="feed" aria-busy="false">
            @foreach (var item in contentItems)
            {
                <ContentItemCard Item="@item" ShowCollectionBadge="@ShowCollectionBadge" />
            }
        </div>
    }
    else
    {
        <div class="no-content" role="status">
            <p>No content available for this collection.</p>
        </div>
    }
</section>

@code {
    [Parameter, EditorRequired]
    public required string SectionName { get; set; }

    [Parameter, EditorRequired]
    public required string CollectionName { get; set; }

    private List<ContentItemDto> contentItems = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string previousCollectionName = string.Empty;

    private bool ShowCollectionBadge =>
    SectionName.Equals("all", StringComparison.OrdinalIgnoreCase) ||
    CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        previousCollectionName = CollectionName;
        await LoadContent();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only reload if collection actually changed
        if (CollectionName != previousCollectionName)
        {
            previousCollectionName = CollectionName;
            await LoadContent();
        }
    }

    private async Task LoadContent()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        Logger.LogDebug("LoadContent START: Section={SectionName}, Collection={CollectionName}",
        SectionName, CollectionName);

        try
        {
            IEnumerable<ContentItemDto>? items = null;

            // Handle "all" collection - get all content for this section across all collections
            if (CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                if (SectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
                {
                    // /all/all - get everything
                    Logger.LogDebug("Calling ApiClient.GetContentAsync(\"\", \"\") for /all/all");
                    items = await ApiClient.GetContentAsync("", "");
                }
                else
                {
                    // /section/all - get all content for this section (use SectionName)
                    Logger.LogDebug("Calling ApiClient.GetContentAsync({SectionName}, '') for section={SectionName}", SectionName);
                    items = await ApiClient.GetContentAsync(SectionName, "");
                }
            }
            // Special handling for "All" section with specific collection
            else if (SectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                // /all/news - get all news across all sections
                Logger.LogDebug("Calling ApiClient.GetContentAsync('', {Collection}) for collection={Collection}", CollectionName,
                CollectionName);
                items = await ApiClient.GetContentAsync("", CollectionName);
            }
            else
            {
                // /section/collection - get specific collection for specific section (use SectionName)
                Logger.LogDebug("Calling ApiClient.GetContentAsync({SectionName}, {Collection}) for section={SectionName}, collection={Collection}",
                SectionName, CollectionName, SectionName, CollectionName);
                items = await ApiClient.GetContentAsync(SectionName, CollectionName);
            }

            contentItems = items?.ToList() ?? new List<ContentItemDto>();
            Logger.LogDebug("LoadContent COMPLETE: Loaded {Count} items, isLoading will be set to false", contentItems.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load content for {SectionName}/{CollectionName}", SectionName, CollectionName);
            errorMessage = "Unable to load content";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            Logger.LogDebug("LoadContent FINALLY: isLoading={IsLoading}, contentItems.Count={Count}", isLoading,
            contentItems.Count);
        }
    }

    private string GetCollectionDisplayName()
    {
        if (CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase))
        {
            return "All";
        }

        // Try to get DisplayName from section cache first
        var section = SectionCache.GetSectionByName(SectionName);
        var collection = section?.Collections.FirstOrDefault(c => c.Name == CollectionName);
        if (collection != null)
        {
            return collection.DisplayName ?? collection.Title ?? CollectionName;
        }

        // Fallback to SectionHelper
        return SectionHelper.GetCollectionDisplayName(CollectionName);
    }

    private string GetPageTitle()
    {
        var collectionDisplay = GetCollectionDisplayName();
        var isAllSection = SectionName.Equals("all", StringComparison.OrdinalIgnoreCase);
        var isAllCollection = CollectionName.Equals("all", StringComparison.OrdinalIgnoreCase);

        // Get proper section display name (e.g., "GitHub Copilot" instead of "github-copilot")
        var sectionDisplayName = SectionHelper.GetSectionDisplayName(SectionName);

        if (isAllSection && isAllCollection)
        {
            // /all → "Browse All Posts"
            return "Browse All Posts";
        }
        else if (isAllSection && !isAllCollection)
        {
            // /all/news → "Browse All News"
            return $"Browse All {collectionDisplay}";
        }
        else if (!isAllSection && isAllCollection)
        {
            // /github-copilot → "Browse All GitHub Copilot Content"
            return $"Browse All {sectionDisplayName} Content";
        }
        else
        {
            // /github-copilot/news → "Browse GitHub Copilot News"
            return $"Browse {sectionDisplayName} {collectionDisplay}";
        }
    }
}