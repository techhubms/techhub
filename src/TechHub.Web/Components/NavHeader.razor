@using TechHub.Core.Models
@using TechHub.Web.Services
@inject SectionCache SectionCache
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<nav class="main-nav" aria-label="Primary navigation">
    <div class="main-nav-content">
        <a href="/" class="site-logo @(IsActivePage("/") ? "home-active" : "")" aria-label="Tech Hub Home">
            <span class="logo-text">Tech Hub</span>
        </a>

        @* Desktop navigation links (hidden on mobile via CSS) *@
        <div class="nav-links">
            @foreach (var item in SectionCache.Sections)
            {
                <a href="/@item.Name" class="nav-link @(IsActiveSection(item.Name) ? "active" : "")">
                    @item.Title
                </a>
            }
            <a href="/about" class="nav-link about-link @(IsActivePage("/about") ? "active" : "")">
                About
            </a>
        </div>

        @* Hamburger button (visible on mobile via CSS) *@
        <button class="hamburger-btn @(menuOpen ? "open" : "")"
                @onclick="ToggleMenu"
                aria-label="@(menuOpen ? "Close navigation menu" : "Open navigation menu")"
                aria-expanded="@(menuOpen ? "true" : "false")"
                aria-controls="mobile-menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
    </div>
</nav>

@* Mobile menu panel (hidden on desktop via CSS) *@
<div id="mobile-menu" class="mobile-menu @(menuOpen ? "open" : "")" role="navigation" aria-label="Mobile navigation">
    <a href="/" class="mobile-menu-section-header mobile-menu-home @(IsActivePage("/") ? "active" : "")" @onclick="CloseMenu">Home</a>
    @foreach (var sectionItem in SectionCache.Sections)
    {
        <div class="mobile-menu-section">
            <button class="mobile-menu-section-header @(IsActiveSection(sectionItem.Name) ? "active" : "")"
                    @onclick="() => ToggleSection(sectionItem.Name)"
                    aria-expanded="@(expandedSections.Contains(sectionItem.Name) ? "true" : "false")">
                <span>@sectionItem.Title</span>
                <span class="chevron @(expandedSections.Contains(sectionItem.Name) ? "expanded" : "")"></span>
            </button>

            @if (expandedSections.Contains(sectionItem.Name))
            {
                <div class="mobile-menu-sub-items">
                    <a href="/@sectionItem.Name/all" class="@(IsActivePage($"/{sectionItem.Name}/all") || IsActivePage($"/{sectionItem.Name}") ? "active" : "")" @onclick="CloseMenu">All</a>
                    @foreach (var collection in sectionItem.Collections.Where(c => !c.IsCustom))
                    {
                        <a href="/@sectionItem.Name/@collection.Name" class="@(IsActivePage($"/{sectionItem.Name}/{collection.Name}") ? "active" : "")" @onclick="CloseMenu">@collection.Title</a>
                    }
                    @foreach (var customPage in sectionItem.Collections.Where(c => c.IsCustom).OrderBy(c => c.Order).ThenBy(c => c.Title))
                    {
                        <a href="@customPage.Url" class="mobile-menu-custom-page @(IsActivePage(customPage.Url) ? "active" : "")" @onclick="CloseMenu">@customPage.Title</a>
                    }
                </div>
            }
        </div>
    }
    <a href="/about" class="mobile-menu-section-header @(IsActivePage("/about") ? "active" : "")" @onclick="CloseMenu">About Us</a>
</div>

@if (menuOpen)
{
    <div class="mobile-menu-overlay" @onclick="CloseMenu"></div>
}

@code {
    private bool menuOpen;
    private readonly HashSet<string> expandedSections = new(StringComparer.OrdinalIgnoreCase);

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Close menu on navigation
        if (menuOpen)
        {
            menuOpen = false;
            await UnlockBodyScroll();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleMenu()
    {
        menuOpen = !menuOpen;
        if (menuOpen)
        {
            await LockBodyScroll();
        }
        else
        {
            expandedSections.Clear();
            await UnlockBodyScroll();
        }
    }

    [JSInvokable]
    public async Task CloseMenuFromJs()
    {
        if (menuOpen)
        {
            menuOpen = false;
            expandedSections.Clear();
            await UnlockBodyScroll();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CloseMenu()
    {
        menuOpen = false;
        expandedSections.Clear();
        await UnlockBodyScroll();
    }

    private void ToggleSection(string sectionName)
    {
        if (expandedSections.Contains(sectionName))
        {
            expandedSections.Remove(sectionName);
        }
        else
        {
            expandedSections.Clear();
            expandedSections.Add(sectionName);
        }
    }

    private async Task LockBodyScroll()
    {
        await JSRuntime.InvokeVoidAsync("mobileNav.lockScroll");
    }

    private async Task UnlockBodyScroll()
    {
        await JSRuntime.InvokeVoidAsync("mobileNav.unlockScroll");
    }

    private string GetCurrentSection()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath.Trim('/');
        var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        return segments.Length > 0 ? segments[0] : "";
    }

    private bool IsActiveSection(string sectionId)
    {
        return string.Equals(GetCurrentSection(), sectionId, StringComparison.OrdinalIgnoreCase);
    }

    private bool IsActivePage(string path)
    {
        var uri = new Uri(Navigation.Uri);
        return string.Equals(uri.AbsolutePath, path, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}