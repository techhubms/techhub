@using TechHub.Core.DTOs
@using TechHub.Web.Services
@inject TechHubApiClient ApiClient
@inject NavigationManager Navigation
@implements IDisposable
@rendermode InteractiveServer

<header class="site-header">
    <div class="header-content">
        <a href="/" class="site-logo" aria-label="Tech Hub Home">
            <span class="logo-text">Tech Hub</span>
        </a>
        
        @if (sections != null && sections.Any())
        {
            <nav class="main-nav" aria-label="Primary navigation">
                @foreach (var item in sections.Take(8))
                {
                    <a href="/@item.Name" class="nav-link @(IsActiveSection(item.Name) ? "active" : "")">
                        @item.Title
                    </a>
                }
            </nav>
        }
    </div>
</header>

@code {
    private IEnumerable<SectionDto>? sections;
    private string currentSection = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            sections = await ApiClient.GetAllSectionsAsync();
            Navigation.LocationChanged += OnLocationChanged;
            UpdateCurrentSection();
        }
        catch
        {
            // Silently fail - navigation will just not show sections
            sections = Array.Empty<SectionDto>();
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateCurrentSection();
        StateHasChanged();
    }

    private void UpdateCurrentSection()
    {
        var uri = new Uri(Navigation.Uri);
        var path = uri.AbsolutePath.Trim('/');
        
        // Get the first segment - that's our section
        var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        currentSection = segments.Length > 0 ? segments[0] : "";
    }

    private bool IsActiveSection(string sectionId)
    {
        return string.Equals(currentSection, sectionId, StringComparison.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
