name: Weekly Roundup Generation

on:
  schedule:
    # Run every Monday at 8:00 AM UTC (10:00 AM GMT+2)
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD) - optional, defaults to last Monday'
        required: false
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD) - optional, defaults to last Sunday'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  generate-roundup:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # Increased to 4 hours for long-running roundup generation
    env:
      GIT_USER_EMAIL: "reinier.vanmaanen@xebia.com"
      GIT_USER_NAME: "RSS Processing Workflow"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ github.token }}

    - name: Setup PowerShell
      uses: azure/powershell@v2
      with:
        azPSVersion: 'latest'
        inlineScript: |
          Write-Host "PowerShell setup complete"

    - name: Calculate date range
      id: dates
      shell: pwsh
      run: |
        # If manual dates are provided, use them
        if ("${{ github.event.inputs.start_date }}" -and "${{ github.event.inputs.end_date }}") {
          $startDate = "${{ github.event.inputs.start_date }}"
          $endDate = "${{ github.event.inputs.end_date }}"
          Write-Host "Using manual dates: $startDate to $endDate"
        } else {
          # Calculate dates automatically
          $today = Get-Date
          
          # Find last Monday (start of the week we're reporting on)
          $daysFromMonday = ($today.DayOfWeek.value__ + 6) % 7
          if ($daysFromMonday -eq 0) {
            # If today is Monday, go back to last Monday
            $daysFromMonday = 7
          }
          $lastMonday = $today.AddDays(-$daysFromMonday)
          
          # End date is the Sunday before today (end of the week we're reporting on)
          $lastSunday = $lastMonday.AddDays(6)
          
          $startDate = $lastMonday.ToString("yyyy-MM-dd")
          $endDate = $lastSunday.ToString("yyyy-MM-dd")
          
          Write-Host "Calculated dates: $startDate to $endDate"
          Write-Host "Today is: $($today.ToString('yyyy-MM-dd dddd'))"
          Write-Host "Last Monday: $($lastMonday.ToString('yyyy-MM-dd dddd'))"
          Write-Host "Last Sunday: $($lastSunday.ToString('yyyy-MM-dd dddd'))"
        }
        
        # Output for next step
        "start-date=$startDate" >> $env:GITHUB_OUTPUT
        "end-date=$endDate" >> $env:GITHUB_OUTPUT

    - name: Prepare Branch for Roundup
      id: prepare-branch
      shell: pwsh
      run: |
        try {
          # Configure Git user
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          
          # Create a unique branch name with date range
          $branchName = "roundup/${{ steps.dates.outputs.start-date }}-to-${{ steps.dates.outputs.end-date }}"
          Write-Host "üåø Preparing branch: $branchName"
          
          # Check if branch already exists locally and remove it
          $branchExists = git branch --list $branchName
          if ($branchExists) {
              Write-Host "üóëÔ∏è Local branch $branchName already exists, removing it..."
              git branch -D $branchName
          }
          
          # Check if remote branch exists and remove it
          Write-Host "üîç Fetching remote branches..."
          git fetch origin
          $remoteBranchExists = git branch -r --list "origin/$branchName"
          if ($remoteBranchExists) {
              Write-Host "üóëÔ∏è Remote branch $branchName exists, removing it..."
              try {
                  git push origin --delete $branchName
                  Write-Host "üóëÔ∏è Removed remote branch $branchName"
              } catch {
                  Write-Host "‚ö†Ô∏è Failed to remove remote branch $branchName - continuing anyway"
              }
          }
          
          # Create and switch to new branch
          git checkout -b $branchName
          Write-Host "‚úÖ Successfully created and switched to branch: $branchName"
          
          # Output branch name for next steps
          "branch-name=$branchName" >> $env:GITHUB_OUTPUT
        }
        catch {
          Write-Host "‚ùå Error during branch preparation: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }

    - name: Generate Weekly Roundup
      shell: pwsh
      run: |
        try {
          Write-Host "üöÄ Starting Weekly Roundup Generation"
          Write-Host "üìÖ Date Range: ${{ steps.dates.outputs.start-date }} to ${{ steps.dates.outputs.end-date }}"
          Write-Host "üîë Using AI endpoint with secret token"
          
          # Set working directory to the repository root
          Set-Location $env:GITHUB_WORKSPACE
          
          # Run the roundup generation script with default parameters
          & scripts/content-processing/iterative-roundup-generation.ps1 `
            -Token "${{ secrets.AZURE_AI_KEY }}" `
            -Model "gpt-4.1" `
            -Endpoint "https://oai-techhub.openai.azure.com/openai/deployments/gpt-4.1/chat/completions?api-version=2025-01-01-preview" `
            -StartDate "${{ steps.dates.outputs.start-date }}" `
            -EndDate "${{ steps.dates.outputs.end-date }}" `
            -WorkspaceDirectory "${{ github.workspace }}"
            
          Write-Host "‚úÖ Roundup generation completed successfully"
        }
        catch {
          Write-Host "‚ùå Error during roundup generation: $($_.Exception.Message)" -ForegroundColor Red
          Write-Host "Full error details:" -ForegroundColor Red
          Write-Host $_.Exception.ToString() -ForegroundColor Red
          exit 1
        }
      env:
        # Ensure we're in the right directory context
        GITHUB_WORKSPACE: ${{ github.workspace }}

    - name: Commit Generated Roundup
      id: commit-changes
      shell: pwsh
      run: |
        try {
          # Check if there are any changes to commit
          $gitStatus = git status --porcelain
          if ($gitStatus) {
            Write-Host "üìù Changes detected, committing new roundup..."
            
            # Add all changes
            git add .
            
            # Create commit message with date range
            $commitMessage = "ü§ñ Add weekly roundup for ${{ steps.dates.outputs.start-date }} to ${{ steps.dates.outputs.end-date }} - Generated automatically via GitHub Actions"
            git commit -m "$commitMessage"
            
            # Push branch using GITHUB_TOKEN
            git push origin ${{ steps.prepare-branch.outputs.branch-name }}
            
            Write-Host "‚úÖ Successfully committed and pushed changes to branch: ${{ steps.prepare-branch.outputs.branch-name }}"
            
            # Output for next step
            "has-changes=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ÑπÔ∏è No changes to commit - roundup may already exist"
            "has-changes=false" >> $env:GITHUB_OUTPUT
          }
        }
        catch {
          Write-Host "‚ùå Error during git operations: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }

    - name: Create Pull Request
      if: steps.commit-changes.outputs.has-changes == 'true'
      shell: pwsh
      run: |
        try {
          Write-Host "üìã Creating pull request for weekly roundup..."
          
          $branchName = "${{ steps.prepare-branch.outputs.branch-name }}"
          $prTitle = "ü§ñ Weekly Roundup: ${{ steps.dates.outputs.start-date }} to ${{ steps.dates.outputs.end-date }}"
          $prBody = @"
        ## üìÖ Weekly Roundup Generated
        
        **Date Range:** ${{ steps.dates.outputs.start-date }} to ${{ steps.dates.outputs.end-date }}
        
        This pull request contains the automatically generated weekly roundup for the specified date range.
        
        ### ü§ñ Generated Content
        - Weekly roundup markdown file
        - Content aggregated from all collections
        - AI-generated summaries and insights
        
        ### ‚úÖ Ready for Review
        Please review the generated content and merge when ready.
        
        > This PR was automatically created by the Weekly Roundup Generation workflow.
        "@
          
          # Create pull request using GitHub CLI with GITHUB_TOKEN
          $env:GITHUB_TOKEN = "${{ github.token }}"
          gh pr create --title "$prTitle" --body "$prBody" --base main --head $branchName --repo ${{ github.repository }}
          
          Write-Host "‚úÖ Successfully created pull request"
        }
        catch {
          Write-Host "‚ùå Error creating pull request: $($_.Exception.Message)" -ForegroundColor Red
          exit 1
        }

    - name: Upload Debug Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: roundup-debug-${{ steps.dates.outputs.start-date }}-to-${{ steps.dates.outputs.end-date }}
        path: |
          .tmp/roundup-debug/
          _roundups/
        retention-days: 30
