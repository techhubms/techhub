name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy-to-production:
        description: 'Deploy to production (will still deploy to staging first)'
        type: boolean
        default: false
      force-infra-deploy:
        description: 'Force infrastructure deployment even if no infra files changed'
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  # ──────────────────────────────────────────────
  # Detect whether infra files changed
  # ──────────────────────────────────────────────
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infra-changed: ${{ steps.result.outputs.infra-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for infrastructure changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            infra:
              - 'infra/**'

      - name: Determine infra deployment
        id: result
        run: |
          if [[ "${{ steps.changes.outputs.infra }}" == "true" || "${{ inputs.force-infra-deploy }}" == "true" ]]; then
            echo "infra-changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "infra-changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ──────────────────────────────────────────────
  # Shared infrastructure (ACR) — runs first, only when infra changed
  # ──────────────────────────────────────────────
  deploy-shared-infra:
    name: Deploy Shared Infrastructure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infra-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shared infrastructure
        shell: pwsh
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment shared `
            -Mode deploy

  # ──────────────────────────────────────────────
  # Staging infrastructure — only when infra changed
  # Runs after shared infra, in parallel with build
  # ──────────────────────────────────────────────
  deploy-staging-infra:
    name: Deploy Staging Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-shared-infra]
    if: |
      always() &&
      needs.detect-changes.outputs.infra-changed == 'true' &&
      (needs.deploy-shared-infra.result == 'success' || needs.deploy-shared-infra.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy staging infrastructure
        shell: pwsh
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment staging `
            -Mode deploy

  # ──────────────────────────────────────────────
  # Build & push Docker images
  # Runs after shared infra (ACR must exist), in parallel with staging infra
  # ──────────────────────────────────────────────
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: deploy-shared-infra
    if: |
      always() &&
      (needs.deploy-shared-infra.result == 'success' || needs.deploy-shared-infra.result == 'skipped')
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push images
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment staging `
            -Tag "${{ github.sha }}" `
            -RegistryName "${{ secrets.AZURE_CONTAINER_REGISTRY }}" `
            -SkipDeploy

  # ──────────────────────────────────────────────
  # Deploy application to staging
  # Waits for both images and staging infra
  # ──────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging-infra]
    if: |
      always() &&
      needs.build-and-push.result == 'success' &&
      (needs.deploy-staging-infra.result == 'success' || needs.deploy-staging-infra.result == 'skipped')
    environment:
      name: staging
      url: https://${{ steps.deploy.outputs.web-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Staging
        id: deploy
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment staging `
            -Tag "${{ needs.build-and-push.outputs.image-tag }}" `
            -RegistryName "${{ secrets.AZURE_CONTAINER_REGISTRY }}" `
            -SkipBuild -SkipPush

          $webUrl = az containerapp show `
            --name ca-techhub-web-staging `
            --resource-group rg-techhub-staging `
            --query properties.configuration.ingress.fqdn `
            -o tsv
          "web-url=$webUrl" | Out-File -Append -FilePath $env:GITHUB_OUTPUT

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure**: ${{ needs.deploy-staging-infra.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web**: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────
  # Production approval gate
  # ──────────────────────────────────────────────
  approve-production:
    name: Approve Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && inputs.deploy-to-production == true
    environment: production
    steps:
      - run: echo "Production deployment approved by ${{ github.actor }}"

  # ──────────────────────────────────────────────
  # Production infrastructure — only when infra changed + approved
  # ──────────────────────────────────────────────
  deploy-production-infra:
    name: Deploy Production Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, approve-production]
    if: needs.detect-changes.outputs.infra-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy production infrastructure
        shell: pwsh
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment production `
            -Mode deploy

  # ──────────────────────────────────────────────
  # Deploy application to production
  # ──────────────────────────────────────────────
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, approve-production, deploy-production-infra]
    if: |
      always() &&
      needs.approve-production.result == 'success' &&
      needs.build-and-push.result == 'success' &&
      (needs.deploy-production-infra.result == 'success' || needs.deploy-production-infra.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Production
        id: deploy
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment production `
            -Tag "${{ needs.build-and-push.outputs.image-tag }}" `
            -RegistryName "${{ secrets.AZURE_CONTAINER_REGISTRY }}" `
            -SkipBuild -SkipPush

          $webUrl = az containerapp show `
            --name ca-techhub-web-prod `
            --resource-group rg-techhub-prod `
            --query properties.configuration.ingress.fqdn `
            -o tsv
          "web-url=$webUrl" | Out-File -Append -FilePath $env:GITHUB_OUTPUT

      - name: Deployment summary
        run: |
          echo "## Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure**: ${{ needs.deploy-production-infra.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web**: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY
