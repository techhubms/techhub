name: Deploy to Azure

on:
  push:
    branches: [dotnet-migration]
  workflow_dispatch:
    inputs:
      force-infra-deploy:
        description: 'Force infrastructure deployment even if no infra files changed'
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  # ──────────────────────────────────────────────
  # Detect whether infra files changed
  # ──────────────────────────────────────────────
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infra-changed: ${{ steps.result.outputs.infra-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for infrastructure changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            infra:
              - 'infra/**'

      - name: Determine infra deployment
        id: result
        run: |
          if [[ "${{ steps.changes.outputs.infra }}" == "true" || "${{ inputs.force-infra-deploy }}" == "true" ]]; then
            echo "infra-changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "infra-changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ──────────────────────────────────────────────
  # Shared infrastructure (ACR) — runs first, only when infra changed
  # ──────────────────────────────────────────────
  deploy-shared-infra:
    name: Deploy Shared Infrastructure
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infra-changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy shared infrastructure
        shell: pwsh
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment shared `
            -Mode deploy

  # ──────────────────────────────────────────────
  # Build & push Docker images
  # Runs after shared infra (ACR must exist), BEFORE env infra
  # ──────────────────────────────────────────────
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: deploy-shared-infra
    if: |
      always() &&
      (needs.deploy-shared-infra.result == 'success' || needs.deploy-shared-infra.result == 'skipped')
    outputs:
      image-tag: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push images
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment staging `
            -Tag "${{ github.sha }}" `
            -SkipDeploy

  # ──────────────────────────────────────────────
  # Staging infrastructure — only when infra changed
  # Runs after build so image tag can be passed to Bicep
  # ──────────────────────────────────────────────
  deploy-staging-infra:
    name: Deploy Staging Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-shared-infra, build-and-push]
    if: |
      always() &&
      needs.detect-changes.outputs.infra-changed == 'true' &&
      needs.build-and-push.result == 'success' &&
      (needs.deploy-shared-infra.result == 'success' || needs.deploy-shared-infra.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy staging infrastructure
        shell: pwsh
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_ACC_PW }}
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment staging `
            -Mode deploy `
            -ImageTag "${{ needs.build-and-push.outputs.image-tag }}"

  # ──────────────────────────────────────────────
  # Deploy application to staging
  # Waits for both images and staging infra
  # ──────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging-infra]
    if: |
      always() &&
      needs.build-and-push.result == 'success' &&
      needs.deploy-staging-infra.result == 'skipped'
    environment:
      name: staging
      url: https://${{ steps.deploy.outputs.web-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Staging
        id: deploy
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment staging `
            -Tag "${{ needs.build-and-push.outputs.image-tag }}" `
            -SkipBuild -SkipPush

          $webUrl = az containerapp show `
            --name ca-techhub-web-staging `
            --resource-group rg-techhub-staging `
            --query properties.configuration.ingress.fqdn `
            -o tsv
          "web-url=$webUrl" | Out-File -Append -FilePath $env:GITHUB_OUTPUT

      - name: Deployment summary
        run: |
          echo "## Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure**: ${{ needs.deploy-staging-infra.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web**: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────
  # Production infrastructure — only when infra changed
  # Uses GitHub environment protection for approval
  # ──────────────────────────────────────────────
  deploy-production-infra:
    name: Deploy Production Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-staging, build-and-push]
    if: needs.detect-changes.outputs.infra-changed == 'true'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy production infrastructure
        shell: pwsh
        env:
          POSTGRES_ADMIN_PASSWORD: ${{ secrets.POSTGRES_PROD_PW }}
        run: |
          ./scripts/Deploy-Infrastructure.ps1 `
            -Environment production `
            -Mode deploy `
            -ImageTag "${{ needs.build-and-push.outputs.image-tag }}"

  # ──────────────────────────────────────────────
  # Deploy application to production
  # Uses GitHub environment protection for approval
  # ──────────────────────────────────────────────
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging, deploy-staging-infra, deploy-production-infra]
    if: |
      always() &&
      needs.build-and-push.result == 'success' &&
      (needs.deploy-staging.result == 'success' || needs.deploy-staging-infra.result == 'success') &&
      needs.deploy-production-infra.result == 'skipped'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Production
        id: deploy
        shell: pwsh
        run: |
          ./scripts/Deploy-Application.ps1 `
            -Environment production `
            -Tag "${{ needs.build-and-push.outputs.image-tag }}" `
            -SkipBuild -SkipPush

          $webUrl = az containerapp show `
            --name ca-techhub-web-prod `
            --resource-group rg-techhub-prod `
            --query properties.configuration.ingress.fqdn `
            -o tsv
          "web-url=$webUrl" | Out-File -Append -FilePath $env:GITHUB_OUTPUT

      - name: Deployment summary
        run: |
          echo "## Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure**: ${{ needs.deploy-production-infra.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Web**: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY
