name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy-to-production:
        description: 'Deploy to production (will still deploy to staging first)'
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push API image
        run: |
          docker build -f src/TechHub.Api/Dockerfile \
            -t ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:${{ github.sha }} \
            -t ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:latest \
            .
          docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:${{ github.sha }}
          docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:latest

      - name: Build and push Web image
        run: |
          docker build -f src/TechHub.Web/Dockerfile \
            -t ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:${{ github.sha }} \
            -t ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:latest \
            .
          docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:${{ github.sha }}
          docker push ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:latest

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: staging
      url: https://${{ steps.deploy.outputs.web-url }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        id: deploy
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "ðŸš€ Deploying to staging with image tag: $IMAGE_TAG"
          
          # Update API container app
          az containerapp update \
            --name ca-techhub-api-staging \
            --resource-group rg-techhub-staging \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:$IMAGE_TAG
          
          # Update Web container app
          az containerapp update \
            --name ca-techhub-web-staging \
            --resource-group rg-techhub-staging \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:$IMAGE_TAG
          
          # Get Web app URL
          WEB_URL=$(az containerapp show \
            --name ca-techhub-web-staging \
            --resource-group rg-techhub-staging \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30

      - name: Run smoke tests
        run: |
          API_URL="https://$(az containerapp show \
            --name ca-techhub-api-staging \
            --resource-group rg-techhub-staging \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          WEB_URL="https://$(az containerapp show \
            --name ca-techhub-web-staging \
            --resource-group rg-techhub-staging \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          # Test API health endpoint
          echo "Testing API health endpoint..."
          curl -f -s "$API_URL/health" || exit 1
          
          # Test Web homepage
          echo "Testing Web homepage..."
          curl -f -s "$WEB_URL" || exit 1
          
          echo "âœ… Smoke tests passed!"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs**:" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://$(az containerapp show --name ca-techhub-api-staging --resource-group rg-techhub-staging --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_STEP_SUMMARY
          echo "- Web: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All smoke tests passed" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    # Only run if manually triggered with deploy-to-production=true
    if: github.event_name == 'workflow_dispatch' && inputs.deploy-to-production == true
    environment:
      name: production
      url: https://${{ steps.deploy.outputs.web-url }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate staging health
        run: |
          API_URL="https://$(az containerapp show \
            --name ca-techhub-api-staging \
            --resource-group rg-techhub-staging \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          WEB_URL="https://$(az containerapp show \
            --name ca-techhub-web-staging \
            --resource-group rg-techhub-staging \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          echo "ðŸ” Validating staging environment health before production deployment..."
          
          # Test API health
          if curl -f -s "$API_URL/health" > /dev/null; then
            echo "âœ… API health check passed"
          else
            echo "âŒ API health check failed"
            exit 1
          fi
          
          # Test Web
          if curl -f -s "$WEB_URL" > /dev/null; then
            echo "âœ… Web health check passed"
          else
            echo "âŒ Web health check failed"
            exit 1
          fi
          
          echo "âœ… Staging environment is healthy"

      - name: Pre-deployment backup
        run: |
          echo "ðŸ“¸ Creating snapshot of current production configuration..."
          
          # Get current API image
          API_IMAGE=$(az containerapp show \
            --name ca-techhub-api-prod \
            --resource-group rg-techhub-prod \
            --query properties.template.containers[0].image \
            -o tsv)
          
          # Get current Web image
          WEB_IMAGE=$(az containerapp show \
            --name ca-techhub-web-prod \
            --resource-group rg-techhub-prod \
            --query properties.template.containers[0].image \
            -o tsv)
          
          echo "Previous images:"
          echo "  API: $API_IMAGE"
          echo "  Web: $WEB_IMAGE"
          
          # Save for potential rollback
          echo "api_image=$API_IMAGE" >> $GITHUB_ENV
          echo "web_image=$WEB_IMAGE" >> $GITHUB_ENV

      - name: Deploy to Azure Container Apps
        id: deploy
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "ðŸš€ Deploying to production with image tag: $IMAGE_TAG"
          
          # Update API container app
          az containerapp update \
            --name ca-techhub-api-prod \
            --resource-group rg-techhub-prod \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-api:$IMAGE_TAG
          
          # Update Web container app
          az containerapp update \
            --name ca-techhub-web-prod \
            --resource-group rg-techhub-prod \
            --image ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io/techhub-web:$IMAGE_TAG
          
          # Get Web app URL
          WEB_URL=$(az containerapp show \
            --name ca-techhub-web-prod \
            --resource-group rg-techhub-prod \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT

      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting 60 seconds for production deployment to stabilize..."
          sleep 60

      - name: Run smoke tests
        id: smoke-tests
        run: |
          API_URL="https://$(az containerapp show \
            --name ca-techhub-api-prod \
            --resource-group rg-techhub-prod \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          WEB_URL="https://$(az containerapp show \
            --name ca-techhub-web-prod \
            --resource-group rg-techhub-prod \
            --query properties.configuration.ingress.fqdn \
            -o tsv)"
          
          echo "ðŸ§ª Running production smoke tests..."
          
          # Test API health endpoint
          echo "Testing API health endpoint..."
          if ! curl -f -s "$API_URL/health"; then
            echo "âŒ API health check failed"
            exit 1
          fi
          
          # Test API sections endpoint
          echo "Testing API sections endpoint..."
          if ! curl -f -s "$API_URL/api/sections"; then
            echo "âŒ API sections endpoint failed"
            exit 1
          fi
          
          # Test Web homepage
          echo "Testing Web homepage..."
          if ! curl -f -s "$WEB_URL"; then
            echo "âŒ Web homepage failed"
            exit 1
          fi
          
          echo "âœ… All smoke tests passed!"

      - name: Rollback on failure
        if: failure() && steps.smoke-tests.outcome == 'failure'
        run: |
          echo "âŒ Smoke tests failed! Rolling back to previous version..."
          
          # Rollback API
          az containerapp update \
            --name ca-techhub-api-prod \
            --resource-group rg-techhub-prod \
            --image ${{ env.api_image }}
          
          # Rollback Web
          az containerapp update \
            --name ca-techhub-web-prod \
            --resource-group rg-techhub-prod \
            --image ${{ env.web_image }}
          
          echo "ðŸ”„ Rollback complete"
          exit 1

      - name: Monitor deployment
        run: |
          echo "ðŸ“Š Monitoring deployment for 5 minutes..."
          
          for i in {1..10}; do
            echo "Check $i/10..."
            
            API_URL="https://$(az containerapp show \
              --name ca-techhub-api-prod \
              --resource-group rg-techhub-prod \
              --query properties.configuration.ingress.fqdn \
              -o tsv)"
            
            if ! curl -f -s "$API_URL/health" > /dev/null; then
              echo "âŒ Health check failed on attempt $i"
              exit 1
            fi
            
            sleep 30
          done
          
          echo "âœ… Deployment monitoring complete - all checks passed"

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs**:" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://$(az containerapp show --name ca-techhub-api-prod --resource-group rg-techhub-prod --query properties.configuration.ingress.fqdn -o tsv)" >> $GITHUB_STEP_SUMMARY
          echo "- Web: https://${{ steps.deploy.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health Checks**: âœ… All passed" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring**: âœ… 5-minute stability check passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor Application Insights for errors" >> $GITHUB_STEP_SUMMARY
          echo "- Check analytics for user traffic" >> $GITHUB_STEP_SUMMARY
          echo "- Continue monitoring for the next 24 hours" >> $GITHUB_STEP_SUMMARY
