{
  "OutputDir": "_community",
  "FeedLevelAuthor": "rss.livelink.threads-in-node",
  "Link": "https://techcommunity.microsoft.com/t5/microsoft-developer-community/durable-task-extension-for-microsoft-agent-framework-%E3%81%A7/ba-p/4470826",
  "Author": "Madoka Chiyoda",
  "EnhancedContent": "## あなたの AI エージェントが、すべて自動で、クラッシュから復旧し、数千のインスタンスで分散実行され、人間の入力 (承認) を何週間も待ち続けることができ、しかもアイドル状態ではコストゼロで動くようになることを想像してみてください\n\n（これは 2025/11/13 に出された製品チームの記事『[Bulletproof agents with the durable task extension for Microsoft Agent Framework](https://techcommunity.microsoft.com/blog/appsonazureblog/bulletproof-agents-with-the-durable-task-extension-for-microsoft-agent-framework/4467122)』を日本語に翻訳したものです。）\n\n本日 (2025/11/13)、**Durable Task Extension for Microsoft Agent Framework** のパブリックプレビューを発表できることを大変うれしく思います。\n\nこの拡張機能は、[Azure Durable Functions](https://learn.microsoft.com/azure/azure-functions/durable/) の 実績ある耐久実行 (durable execution) (クラッシュや再起動に耐える) と分散実行 (複数インスタンスで動作する) 機能を、[Microsoft Agent Framework](https://learn.microsoft.com/agent-framework/) に直接組み込むことで、本番環境対応の、堅牢でスケーラブルな AI エージェントの構築方法を一新します。\n\nこれにより、セッション管理、障害復旧、スケーリングを自動的に処理するステートフルで堅牢な AI エージェントを Azure にデプロイでき、開発者はエージェントのロジックに完全に集中できるようになります。\n\nたとえば、複数日にわたる会話でコンテキストを維持するカスタマーサービスエージェント、人間による承認 (human-in-the-loop approval workflow) を含むコンテンツパイプライン、または専門的な AI モデルを連携させる完全自動化されたマルチエージェントシステムを構築する場合でも、この **Durable Task Extension for Microsoft Agent Framework** は、サーバーレスのシンプルさで本番レベルの信頼性、スケーラビリティ、そして調整機能を提供します。\n\n## Durable Task Extension の主な機能：\n\n- **サーバーレスホスティング (Serverless Hosting)**：Azure Functions 上にエージェントをデプロイし、数千のインスタンスからゼロまで自動スケーリングを実現しながら、サーバーレスアーキテクチャの利点を維持したまま完全な制御を保持します。\n- **自動セッション管理 (Automatic Session Management)**：エージェントは、プロセスのクラッシュや再起動、インスタンス間の分散実行に耐える、完全な会話コンテキストを保持した永続的なセッションを維持します。\n- **決定的な (deterministic) マルチエージェントオーケストレーション (Deterministic Multi-Agent Orchestrations)**： 予測可能で再現可能なコード駆動の実行パターンを用いて、耐久性のある専門エージェントを調整します。\n(訳註：「決定的な (deterministic)」とは、同じ入力に対しては常に同じ結果を返すもので、その動作が予測可能なものを指します)\n- **サーバーレスによるコスト削減を伴う Human-in-the-Loop (Human-in-the-Loop with Serverless Cost Savings)**： 人間の入力を待つ間、コンピュートリソースを消費せず、コストも発生しません。\n- **Durable Task Scheduler による組み込みの可観測性 (Built-in Observability with Durable Task Scheduler)**：Durable Task Scheduler の UI ダッシュボードを通じて、エージェントの操作やオーケストレーションを深く可視化できます。\n\n### Durable Agent を作成して実行してみる\n\n公式ドキュメント\n\n[https://aka.ms/create-and-run-durable-agent](https://aka.ms/create-and-run-durable-agent)\n\n## コードサンプル (Python/C#)\n\n```\n# Python\n\nendpoint = os.getenv(\"AZURE_OPENAI_ENDPOINT\") deployment_name = os.getenv(\"AZURE_OPENAI_DEPLOYMENT_NAME\", \"gpt-4o-mini\")\n\n# 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します\nagent = AzureOpenAIChatClient( endpoint=endpoint, deployment_name=deployment_name, credential=AzureCliCredential() ).create_agent( instructions=\"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname=\"DocumentPublisher\", tools=[ AIFunctionFactory.Create(search_web), AIFunctionFactory.Create(generate_outline) ] )\n\n# Durable なセッション管理でエージェントをホストするように Function アプリを構成します\napp = AgentFunctionApp(agents=[agent])\n\napp.run() ```\n\n``` // C#\n\nvar endpoint = Environment.GetEnvironmentVariable(\"AZURE_OPENAI_ENDPOINT\"); var deploymentName = Environment.GetEnvironmentVariable(\"AZURE_OPENAI_DEPLOYMENT\") ?? \"gpt-4o-mini\";\n\n// 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します AIAgent agent = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential()) .GetChatClient(deploymentName) .CreateAIAgent( instructions: \"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname: \"DocumentPublisher\", tools: [ AIFunctionFactory.Create(SearchWeb), AIFunctionFactory.Create(GenerateOutline) ]);\n\n// Durable なスレッド管理でエージェントをホストするように Functions アプリを構成します // これにより、HTTP エンドポイントが自動で作成され、状態の永続化が管理されます using IHost app = FunctionsApplication .CreateBuilder(args) .ConfigureFunctionsWebApplication() .ConfigureDurableAgents(options => options.AddAIAgent(agent) ) .Build();\n\napp.Run(); ```\n\n## なぜ Durable Task Extension が必要なのか\n\nAI エージェントが、単純なチャットボットから、複雑で長時間実行されるタスクを処理する高度なシステムへと進化するにつれて、新たな課題が浮上します。\n\n- 会話が数日から数週間にわたるため、プロセスの再起動やクラッシュ、障害を超えて状態を保持する必要があります。\n- ツール呼び出しが通常のタイムアウトを超える時間を要する場合があり、自動チェックポイントと復旧が必要です。\n- 大量のワークロードに対応するため、数千のエージェント会話を同時に処理できるよう、分散インスタンス間での弾力的なスケーリングが求められます。\n- 複数の専門エージェントを、信頼性の高いビジネスプロセスのために、予測可能で再現可能な実行パターンで調整する必要があります。\n- エージェントは、処理を進める前に人間の承認を待つ必要がある場合があり、その間は理想的にはリソースを消費しない (課金されない) ことが望まれます。\n\nDurable Extension は、[Azure Durable Functions](hhttps://learn.microsoft.com/azure/azure-functions/durable/) の機能を [Microsoft Agent Framework](https://learn.microsoft.com/agent-framework/) に拡張することで、これらの課題に対応します。これにより、障害に耐え、弾力的にスケールし、耐久性と分散実行によって予測可能に動作する AI エージェントを構築できます。\n\n### 4 つの柱 : 4D\n\nこの拡張機能は、4 つの基本的な価値の柱、通称「4D」に基づいて構築されています。\n\n- **Durability (耐久性)**\n- すべてのエージェントの状態変更（メッセージ、ツール呼び出し、意思決定）は、自動的に耐久性のあるチェックポイントとして保存されます。エージェントは、インフラ更新やクラッシュから復旧し、長時間の待機中にメモリからアンロードされてもコンテキストを失わずに再開できます。これは、長時間実行される処理や外部イベントを待機するエージェントに不可欠です。\n- **Distributed (分散型の)**\n- エージェントの実行はすべてのインスタンスで利用可能であり、弾力的なスケーリングと自動フェイルオーバーを実現します。正常なノードは、障害が発生したインスタンスの作業をシームレスに引き継ぎ、継続的な運用を保証します。この分散実行モデルにより、数千のステートフルエージェントがスケールアップし、並列で動作できます。\n- **Deterministic** **(決定性)**\n- エージェントのオーケストレーションは、通常のコードとして記述された命令型ロジックを使用して予測可能に実行されます。実行パスを定義することで、自動テスト、検証可能なガードレール、ステークホルダーが信頼できるビジネスクリティカルなワークフローを実現します。必要に応じて明示的な制御フローを提供し、エージェント主導のワークフローを補完します。\n- **Debuggability (デバッグしやすさ)**\n- IDE、デバッガー、ブレークポイント、スタックトレース、単体テストなどの馴染みのある開発ツールやプログラミング言語を使用して開発・デバッグできます。エージェントとそのオーケストレーションはコードとして表現されるため、テスト、デバッグ、保守が容易です。\n\n## 実際の機能の動作\n\n### **サーバーレス ホスティング (Serverless hosting)**\n\nエージェントを [Azure Functions](https://learn.microsoft.com/azure/azure-functions/) （近日中に他の Azure サービスにも拡張予定）にデプロイし、使用していないときはゼロまで、使用時は数千インスタンスまで自動スケーリングします。消費したコンピューティング リソースに対してのみ料金を支払います。このコードファーストのデプロイ手法により、サーバーレス アーキテクチャの利点を維持しながら、コンピュート環境 (compute environment) を完全に制御できます。\n\n```\n# Python\n\nendpoint = os.getenv(\"AZURE_OPENAI_ENDPOINT\") deployment_name = os.getenv(\"AZURE_OPENAI_DEPLOYMENT_NAME\", \"gpt-4o-mini\")\n\n# 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します\nagent = AzureOpenAIChatClient( endpoint=endpoint, deployment_name=deployment_name, credential=AzureCliCredential() ).create_agent( instructions=\"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname=\"DocumentPublisher\", tools=[ AIFunctionFactory.Create(search_web), AIFunctionFactory.Create(generate_outline) ] )\n\n# Durable なセッション管理でエージェントをホストするように Function アプリを構成します\napp = AgentFunctionApp(agents=[agent])\n\napp.run() ```\n\n### **Automatic session management（自動セッション管理）**\n\nエージェントのセッションは、Function アプリで構成した耐久性のあるストレージに自動的にチェックポイントされ、複数インスタンス間での耐久性と分散実行を可能にします。中断やプロセス障害の後でも、どのインスタンスからでもエージェントの実行を再開でき、継続的な運用が保証されます。\n\n内部的には、エージェントは [Durable Entities](https://learn.microsoft.com/azure/azure-functions/durable/durable-functions-entities) として実装されています。これらは、実行間で状態を保持するステートフルなオブジェクトです。このアーキテクチャにより、各エージェントセッションは、会話履歴とコンテキストを保持した信頼性の高い長寿命のエンティティとして機能します。\n\n**シナリオ例:**\n\n複数日から数週間にわたる複雑なサポート案件を処理するカスタマーサービスエージェント。エージェントが再デプロイされたり、別のインスタンスに移動した場合でも、会話履歴、コンテキスト、進捗は保持されます。\n\n```\n# 最初の対話 - ドキュメント作成用の新しいスレッドを開始\ncurl -X POST https://your-function-app.azurewebsites.net/api/agents/DocumentPublisher/threads \\ -H \"Content-Type: application/json\" \\ -d '{\"message\": \"Azure Functions の利点についてのドキュメントを作成してください\"}'\n\n# レスポンスにはスレッド ID と初期のドキュメントのアウトライン／下書きが含まれます\n# {\"threadId\": \"doc789\", \"response\": \"Azure Functions の利点に関する網羅的なドキュメントを作成します。最新情報を検索します… [ドキュメント下書き] # Azure Functions の利点\\n\\n## はじめに\\nAzure Functions は、インフラ管理なしでイベント駆動のコードを実行できるサーバーレスのコンピュートサービスです…\\n\\n## コスト効率\\n- 実行時間に対してのみ支払う\\n- アイドル状態のリソースには料金がかからない\\n- 自動スケーリングにより過剰プロビジョニングを削減…\\n\\n## 開発者の生産性\\n- 複数言語のサポート（C#, Python, JavaScript, Java）\\n- 統合開発ツールと CI/CD …\\n\\n## スケーラビリティ\\n- 需要に基づく自動スケーリング\\n- 何百万ものリクエストをシームレスに処理…\\n\\n参考文献: [Azure ドキュメント、サーバーレス計算に関する研究]\"}\n\n# 2 回目の対話 - 同じスレッドでドキュメントを改善\ncurl -X POST https://your-function-app.azurewebsites.net/api/agents/DocumentPublisher/threads/doc789 \\ -H \"Content-Type: application/json\" \\ -d '{\"message\": \"他の Azure サービスとの統合に関するセクションを追加してもらえますか？\"}'\n\n# エージェントは Azure Functions ドキュメントのコンテキストを保持し、要求されたセクションを追加します\n# {\"threadId\": \"doc789\", \"response\": \"Azure Functions ドキュメントに、包括的な統合セクションを追加しました:\\n\\n## Azure サービスとの統合\\n\\n### Azure Storage\\nBlob Storage、Queue Storage、Table Storage へのトリガーとバインディングにより、イベント駆動アーキテクチャをシームレスに実現…\\n\\n### Azure Event Grid と Event Hubs\\nリアルタイムのイベントストリームを処理し、スケール可能な Pub/Sub パターンを実装…\\n\\n### Azure Cosmos DB\\nドキュメントデータベース操作向けの組み込みバインディングと、変更フィードの自動処理…\\n\\n### Azure Service Bus\\nエンタープライズメッセージング機能による信頼性の高いメッセージ処理…\\n\\n### Azure AI Services\\nOpenAI、Cognitive Services、AI Search を容易に統合してインテリジェントなアプリケーションを実現…\\n\\nこのセクションはスケーラビリティのセクションの後に追加されています。ユースケースやデプロイのベストプラクティスも追加しましょうか？\"}\n```\n\n### **Deterministic multi-agent orchestrations（決定的なマルチエージェントオーケストレーション）**\n\n命令型コードを使用して、複数の専門的な durable agents を調整します。この場合、制御フローは開発者が定義します。これは、エージェントが次のステップを決定するエージェント主導のワークフローとは異なります。 決定的オーケストレーションは、自動チェックポイントと復旧を備えた予測可能で再現可能な実行パターンを提供します。\n\n**シナリオ例:** メール処理システムで、まずスパム検出エージェントを使用し、その分類に基づいて条件付きで異なる専門エージェントにルーティングします。オーケストレーションは、どのステップで障害が発生しても自動的に復旧し、完了済みのエージェント呼び出しは再実行されません。\n\n```\n# Python\n\napp.orchestration_trigger(context_name=\"context\") def document_publishing_orchestration(context: DurableOrchestrationContext): \"\"\"複数の専門エージェントを協調させる決定的オーケストレーション。\"\"\" doc_request = context.get_input()\n\n# オーケストレーションのコンテキストから専門エージェントを取得\nresearch_agent = context.get_agent(\"ResearchAgent\") writer_agent = context.get_agent(\"DocumentPublisherAgent\")\n\n# ステップ 1：Web 検索でトピックを調査する\nresearch_result = yield research_agent.run( messages=f\"次のトピックを調査し、主要な情報を収集してください：{doc_request.topic}\", response_schema=ResearchResult )\n\n# ステップ 2：調査結果に基づいてアウトラインを生成する\noutline = yield context.call_activity(\"generate_outline\", { \"topic\": doc_request.topic, \"research_data\": research_result.findings })\n\n# ステップ 3：調査結果とアウトラインに基づいてドキュメントを作成する\ndocument = yield writer_agent.run( messages=f\"\"\"以下のトピックについて、網羅的なドキュメントを作成してください：{doc_request.topic}\n\n調査結果: {research_result.findings} アウトライン: {outline}\n\n適切な書式で、構造化され読みやすく、魅力的なドキュメントにしてください。必要に応じて出典（引用）も含めてください。\"\"\", response_schema=DocumentResponse )\n\n# ステップ 4：生成したドキュメントを保存して公開する\nreturn yield context.call_activity(\"publish_document\", { \"title\": doc_request.topic, \"content\": document.text, \"citations\": document.citations }) ```\n\n### **Human-in-the-loop（人間を介在させる仕組み）**\n\nオーケストレーションやエージェントは、人間の入力、承認、レビューを待つ間、コンピュートリソースを消費せずに一時停止できます。耐久性のある実行 (durable execution) により、アプリがクラッシュや再起動しても、人間の応答を待つ間、数日から数週間にわたってオーケストレーションを待機させることが可能です。サーバーレスホスティングと組み合わせることで、待機期間中はすべてのコンピュートリソースが停止し、人間が入力を提供するまでコンピュートコストが完全に排除されます。\n\n**シナリオ例:** コンテンツ公開エージェントが下書きを生成し、人間のレビュー担当者に送信して、承認を数日間待機するケース。この間、レビュー期間中はコンピュートリソースを実行（または課金）しません。人間の応答が届くと、オーケストレーションは会話コンテキストと実行状態を完全に保持したまま自動的に再開します。\n\n```\n# Python\n\napp.orchestration_trigger(context_name=\"context\") def content_approval_workflow(context: DurableOrchestrationContext): \"\"\"人間を介在させるワークフロー（待機中はコストゼロ）\"\"\" topic = context.get_input()\n\n# ステップ 1：エージェントを使ってコンテンツを生成\ncontent_agent = context.get_agent(\"ContentGenerationAgent\") draft_content = yield content_agent.run(f\"{topic} についての記事を書いてください\")\n\n# ステップ 2：人間によるレビューを依頼\nyield context.call_activity(\"notify_reviewer\", draft_content)\n\n# ステップ 3：承認を待機（待機中はコンピュートリソースを消費しない）\napproval_event = context.wait_for_external_event(\"ApprovalDecision\") timeout_task = context.create_timer(context.current_utc_datetime + timedelta(hours=24))\n\nwinner = yield context.task_any([approval_event, timeout_task])\n\nif winner == approval_event: timeout_task.cancel() approved = approval_event.result\n\nif approved: result = yield context.call_activity(\"publish_content\", draft_content) return result else: return \"コンテンツは却下されました\" else:\n# タイムアウト時：レビューをエスカレーション\nresult = yield context.call_activity(\"escalate_for_review\", draft_content) return result ```\n\n### **Built-in agent observability（エージェントの組み込み可観測性）**\n\nFunction App を [Durable Task Scheduler](https://learn.microsoft.com/en-us/azure/azure-functions/durable/durable-task-scheduler/durable-task-scheduler) を耐久バックエンドとして構成します（エージェントとオーケストレーションの状態を永続化する仕組み）。は、耐久エージェントに推奨されるバックエンドであり、最高のスループット性能、完全に管理されたインフラ、そして UI ダッシュボードによる組み込みの可観測性を提供します。\n\n**Durable Task Scheduler ダッシュボードは、エージェントの操作を深く可視化します：**\n\n- **会話履歴 (Conversation history):** 各エージェントセッションの完全な会話スレッドを表示し、すべてのメッセージ、ツール呼び出し、任意時点のコンテキストを確認可能\n- **マルチエージェントの可視化 (Multi-agent visualization):** 複数の専門エージェントを呼び出す際の実行フローを、エージェント間のハンドオフ、並列実行、条件分岐を含む視覚的な表現で表示\n- **パフォーマンス指標 (Performance metrics):** エージェントの応答時間、トークン使用量、オーケストレーションの実行時間を監視\n- **実行履歴 (Execution history):** デバッグ用に完全なリプレイ機能を備えた詳細な実行ログにアクセス可能\n\n## **Demo Video**\n\n## **Language support**\n\nThe Durable Task Extension は以下の言語をサポートしています:\n\n- C# (.NET 8.0+) with Azure Functions\n- Python (3.10+) with Azure Functions\n\nSupport for additional computes coming soon.\n\n## **今日から始めてみましょう**\n\n#### [Click here to create and run a durable agent](https://aka.ms/create-and-run-durable-agent)\n\n## **Learn more**\n\n- [Overview documentation](https://aka.ms/durable-extension-for-af)\n- [C# Samples](https://aka.ms/durable-extension-csharp-samples)\n- [Python Samples](https://aka.ms/durable-extension-python-samples)\n\n### **原文**\n\n[Bulletproof agents with the durable task extension for Microsoft Agent Framework | Microsoft Community Hub](https://techcommunity.microsoft.com/blog/appsonazureblog/bulletproof-agents-with-the-durable-task-extension-for-microsoft-agent-framework/4467122)\n\nPublished Nov 19, 2025\n\nVersion 1.0\n\n[.net](/tag/.net?nodeId=board%3AAzureDevCommunityBlog)\n\n[ai](/tag/ai?nodeId=board%3AAzureDevCommunityBlog)\n\n[python](/tag/python?nodeId=board%3AAzureDevCommunityBlog)\n\n[serverless](/tag/serverless?nodeId=board%3AAzureDevCommunityBlog)\n\n[!\\[Madoka Chiyoda&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/dS0yMjk1NDEtUWlmeWVJ?image-coordinates=82%2C46%2C258%2C222&amp;image-dimensions=50x50)](/users/madoka%20chiyoda/229541) [Madoka Chiyoda](/users/madoka%20chiyoda/229541) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined October 18, 2018\n\n[View Profile](/users/madoka%20chiyoda/229541)\n\n/category/azure/blog/azuredevcommunityblog [Microsoft Developer Community Blog](/category/azure/blog/azuredevcommunityblog) Follow this blog board to get notified when there's new activity",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "PubDate": "2025-11-19T21:09:08+00:00",
  "Description": "（これは 2025/11/13 に出された製品チームの記事『[Bulletproof agents with the durable task extension for Microsoft Agent Framework](https://techcommunity.microsoft.com/blog/appsonazureblog/bulletproof-agents-with-the-durable-task-extension-for-microsoft-agent-framework/4467122)』を日本語に翻訳したものです。）\n\n本日 (2025/11/13)、**Durable Task Extension for Microsoft Agent Framework** のパブリックプレビューを発表できることを大変うれしく思います。\n\nこの拡張機能は、[Azure Durable Functions](https://learn.microsoft.com/azure/azure-functions/durable/) の 実績ある耐久実行 (durable execution) (クラッシュや再起動に耐える) と分散実行 (複数インスタンスで動作する) 機能を、[Microsoft Agent Framework](https://learn.microsoft.com/agent-framework/) に直接組み込むことで、本番環境対応の、堅牢でスケーラブルな AI エージェントの構築方法を一新します。\n\nこれにより、セッション管理、障害復旧、スケーリングを自動的に処理するステートフルで堅牢な AI エージェントを Azure にデプロイでき、開発者はエージェントのロジックに完全に集中できるようになります。\n\nたとえば、複数日にわたる会話でコンテキストを維持するカスタマーサービスエージェント、人間による承認 (human-in-the-loop approval workflow) を含むコンテンツパイプライン、または専門的な AI モデルを連携させる完全自動化されたマルチエージェントシステムを構築する場合でも、この **Durable Task Extension for Microsoft Agent Framework** は、サーバーレスのシンプルさで本番レベルの信頼性、スケーラビリティ、そして調整機能を提供します。\n\n## Durable Task Extension の主な機能：\n\n- **サーバーレスホスティング (Serverless Hosting)**：Azure Functions 上にエージェントをデプロイし、数千のインスタンスからゼロまで自動スケーリングを実現しながら、サーバーレスアーキテクチャの利点を維持したまま完全な制御を保持します。\n- **自動セッション管理 (Automatic Session Management)**：エージェントは、プロセスのクラッシュや再起動、インスタンス間の分散実行に耐える、完全な会話コンテキストを保持した永続的なセッションを維持します。\n- **決定的な (deterministic) マルチエージェントオーケストレーション (Deterministic Multi-Agent Orchestrations)**： 予測可能で再現可能なコード駆動の実行パターンを用いて、耐久性のある専門エージェントを調整します。\n(訳註：「決定的な (deterministic)」とは、同じ入力に対しては常に同じ結果を返すもので、その動作が予測可能なものを指します)\n- **サーバーレスによるコスト削減を伴う Human-in-the-Loop (Human-in-the-Loop with Serverless Cost Savings)**： 人間の入力を待つ間、コンピュートリソースを消費せず、コストも発生しません。\n- **Durable Task Scheduler による組み込みの可観測性 (Built-in Observability with Durable Task Scheduler)**：Durable Task Scheduler の UI ダッシュボードを通じて、エージェントの操作やオーケストレーションを深く可視化できます。\n\n### Durable Agent を作成して実行してみる\n\n公式ドキュメント\n\n[https://aka.ms/create-and-run-durable-agent](https://aka.ms/create-and-run-durable-agent)\n\n## コードサンプル (Python/C#)\n\n- # Python\n\nendpoint = os.getenv(\"AZURE\\_OPENAI\\_ENDPOINT\") deployment\\_name = os.getenv(\"AZURE\\_OPENAI\\_DEPLOYMENT\\_NAME\", \"gpt-4o-mini\")\n\n# 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します\nagent = AzureOpenAIChatClient( endpoint=endpoint, deployment\\_name=deployment\\_name, credential=AzureCliCredential() ).create\\_agent( instructions=\"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname=\"DocumentPublisher\", tools=[ AIFunctionFactory.Create(search\\_web), AIFunctionFactory.Create(generate\\_outline) ] )\n\n# Durable なセッション管理でエージェントをホストするように Function アプリを構成します\napp = AgentFunctionApp(agents=[agent])\n\napp.run()\n- // C#\n\nvar endpoint = Environment.GetEnvironmentVariable(\"AZURE\\_OPENAI\\_ENDPOINT\"); var deploymentName = Environment.GetEnvironmentVariable(\"AZURE\\_OPENAI\\_DEPLOYMENT\") ?? \"gpt-4o-mini\";\n\n// 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します AIAgent agent = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential()) .GetChatClient(deploymentName) .CreateAIAgent( instructions: \"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname: \"DocumentPublisher\", tools: [ AIFunctionFactory.Create(SearchWeb), AIFunctionFactory.Create(GenerateOutline) ]);\n\n// Durable なスレッド管理でエージェントをホストするように Functions アプリを構成します // これにより、HTTP エンドポイントが自動で作成され、状態の永続化が管理されます using IHost app = FunctionsApplication .CreateBuilder(args) .ConfigureFunctionsWebApplication() .ConfigureDurableAgents(options => options.AddAIAgent(agent) ) .Build();\n\napp.Run();\n\n## なぜ Durable Task Extension が必要なのか\n\nAI エージェントが、単純なチャットボットから、複雑で長時間実行されるタスクを処理する高度なシステムへと進化するにつれて、新たな課題が浮上します。\n\n- 会話が数日から数週間にわたるため、プロセスの再起動やクラッシュ、障害を超えて状態を保持する必要があります。\n- ツール呼び出しが通常のタイムアウトを超える時間を要する場合があり、自動チェックポイントと復旧が必要です。\n- 大量のワークロードに対応するため、数千のエージェント会話を同時に処理できるよう、分散インスタンス間での弾力的なスケーリングが求められます。\n- 複数の専門エージェントを、信頼性の高いビジネスプロセスのために、予測可能で再現可能な実行パターンで調整する必要があります。\n- エージェントは、処理を進める前に人間の承認を待つ必要がある場合があり、その間は理想的にはリソースを消費しない (課金されない) ことが望まれます。\n\nDurable Extension は、[Azure Durable Functions](hhttps://learn.microsoft.com/azure/azure-functions/durable/) の機能を [Microsoft Agent Framework](https://learn.microsoft.com/agent-framework/) に拡張することで、これらの課題に対応します。これにより、障害に耐え、弾力的にスケールし、耐久性と分散実行によって予測可能に動作する AI エージェントを構築できます。\n\n### 4 つの柱 : 4D\n\nこの拡張機能は、4 つの基本的な価値の柱、通称「4D」に基づいて構築されています。\n\n- **Durability (耐久性)**\n- すべてのエージェントの状態変更（メッセージ、ツール呼び出し、意思決定）は、自動的に耐久性のあるチェックポイントとして保存されます。エージェントは、インフラ更新やクラッシュから復旧し、長時間の待機中にメモリからアンロードされてもコンテキストを失わずに再開できます。これは、長時間実行される処理や外部イベントを待機するエージェントに不可欠です。\n- **Distributed (分散型の)**\n- エージェントの実行はすべてのインスタンスで利用可能であり、弾力的なスケーリングと自動フェイルオーバーを実現します。正常なノードは、障害が発生したインスタンスの作業をシームレスに引き継ぎ、継続的な運用を保証します。この分散実行モデルにより、数千のステートフルエージェントがスケールアップし、並列で動作できます。\n- **Deterministic** **(決定性)**\n- エージェントのオーケストレーションは、通常のコードとして記述された命令型ロジックを使用して予測可能に実行されます。実行パスを定義することで、自動テスト、検証可能なガードレール、ステークホルダーが信頼できるビジネスクリティカルなワークフローを実現します。必要に応じて明示的な制御フローを提供し、エージェント主導のワークフローを補完します。\n- **Debuggability (デバッグしやすさ)**\n- IDE、デバッガー、ブレークポイント、スタックトレース、単体テストなどの馴染みのある開発ツールやプログラミング言語を使用して開発・デバッグできます。エージェントとそのオーケストレーションはコードとして表現されるため、テスト、デバッグ、保守が容易です。\n\n## 実際の機能の動作\n\n### **サーバーレス ホスティング (Serverless hosting)**\n\nエージェントを [Azure Functions](https://learn.microsoft.com/azure/azure-functions/) （近日中に他の Azure サービスにも拡張予定）にデプロイし、使用していないときはゼロまで、使用時は数千インスタンスまで自動スケーリングします。消費したコンピューティング リソースに対してのみ料金を支払います。このコードファーストのデプロイ手法により、サーバーレス アーキテクチャの利点を維持しながら、コンピュート環境 (compute environment) を完全に制御できます。\n- # Python\n\nendpoint = os.getenv(\"AZURE\\_OPENAI\\_ENDPOINT\") deployment\\_name = os.getenv(\"AZURE\\_OPENAI\\_DEPLOYMENT\\_NAME\", \"gpt-4o-mini\")\n\n# 標準的な Microsoft Agent Framework パターンに従って AI エージェントを作成します\nagent = AzureOpenAIChatClient( endpoint=endpoint, deployment\\_name=deployment\\_name, credential=AzureCliCredential() ).create\\_agent( instructions=\"\"\"あなたは、どんなテーマに対しても読みやすく構造化された、 魅力的なドキュメントを作成するプロフェッショナルなコンテンツライターです。\n\nテーマが与えられたら、次の手順で進めてください。\n1. Web 検索ツールを使ってテーマをリサーチする\n2. ドキュメントのアウトラインを生成する\n3. 適切な書式で説得力のあるドキュメントを書く\n4. 関連する例と出典（引用）を含める\"\"\",\nname=\"DocumentPublisher\", tools=[ AIFunctionFactory.Create(search\\_web), AIFunctionFactory.Create(generate\\_outline) ] )\n\n# Durable なセッション管理でエージェントをホストするように Function アプリを構成します\napp = AgentFunctionApp(agents=[agent])\n\napp.run()\n\n### **Automatic session management（自動セッション管理）**\n\nエージェントのセッションは、Function アプリで構成した耐久性のあるストレージに自動的にチェックポイントされ、複数インスタンス間での耐久性と分散実行を可能にします。中断やプロセス障害の後でも、どのインスタンスからでもエージェントの実行を再開でき、継続的な運用が保証されます。\n\n内部的には、エージェントは [Durable Entities](https://learn.microsoft.com/azure/azure-functions/durable/durable-functions-entities) として実装されています。これらは、実行間で状態を保持するステートフルなオブジェクトです。このアーキテクチャにより、各エージェントセッションは、会話履歴とコンテキストを保持した信頼性の高い長寿命のエンティティとして機能します。\n\n**シナリオ例:**\n\n複数日から数週間にわたる複雑なサポート案件を処理するカスタマーサービスエージェント。エージェントが再デプロイされたり、別のインスタンスに移動した場合でも、会話履歴、コンテキスト、進捗は保持されます。\n- # 最初の対話 - ドキュメント作成用の新しいスレッドを開始\ncurl -X POST https://your-function-app.azurewebsites.net/api/agents/DocumentPublisher/threads \\ -H \"Content-Type: application/json\" \\ -d '{\"message\": \"Azure Functions の利点についてのドキュメントを作成してください\"}'\n\n# レスポンスにはスレッド ID と初期のドキュメントのアウトライン／下書きが含まれます\n# {\"threadId\": \"doc789\", \"response\": \"Azure Functions の利点に関する網羅的なドキュメントを作成します。最新情報を検索します… [ドキュメント下書き] # Azure Functions の利点\\n\\n## はじめに\\nAzure Functions は、インフラ管理なしでイベント駆動のコードを実行できるサーバーレスのコンピュートサービスです…\\n\\n## コスト効率\\n- 実行時間に対してのみ支払う\\n- アイドル状態のリソースには料金がかからない\\n- 自動スケーリングにより過剰プロビジョニングを削減…\\n\\n## 開発者の生産性\\n- 複数言語のサポート（C#, Python, JavaScript, Java）\\n- 統合開発ツールと CI/CD …\\n\\n## スケーラビリティ\\n- 需要に基づく自動スケーリング\\n- 何百万ものリクエストをシームレスに処理…\\n\\n参考文献: [Azure ドキュメント、サーバーレス計算に関する研究]\"}\n\n# 2 回目の対話 - 同じスレッドでドキュメントを改善\ncurl -X POST https://your-function-app.azurewebsites.net/api/agents/DocumentPublisher/threads/doc789 \\ -H \"Content-Type: application/json\" \\ -d '{\"message\": \"他の Azure サービスとの統合に関するセクションを追加してもらえますか？\"}'\n\n# エージェントは Azure Functions ドキュメントのコンテキストを保持し、要求されたセクションを追加します\n# {\"threadId\": \"doc789\", \"response\": \"Azure Functions ドキュメントに、包括的な統合セクションを追加しました:\\n\\n## Azure サービスとの統合\\n\\n### Azure Storage\\nBlob Storage、Queue Storage、Table Storage へのトリガーとバインディングにより、イベント駆動アーキテクチャをシームレスに実現…\\n\\n### Azure Event Grid と Event Hubs\\nリアルタイムのイベントストリームを処理し、スケール可能な Pub/Sub パターンを実装…\\n\\n### Azure Cosmos DB\\nドキュメントデータベース操作向けの組み込みバインディングと、変更フィードの自動処理…\\n\\n### Azure Service Bus\\nエンタープライズメッセージング機能による信頼性の高いメッセージ処理…\\n\\n### Azure AI Services\\nOpenAI、Cognitive Services、AI Search を容易に統合してインテリジェントなアプリケーションを実現…\\n\\nこのセクションはスケーラビリティのセクションの後に追加されています。ユースケースやデプロイのベストプラクティスも追加しましょうか？\"}\n\n### **Deterministic multi-agent orchestrations（決定的なマルチエージェントオーケストレーション）**\n\n命令型コードを使用して、複数の専門的な durable agents を調整します。この場合、制御フローは開発者が定義します。これは、エージェントが次のステップを決定するエージェント主導のワークフローとは異なります。 決定的オーケストレーションは、自動チェックポイントと復旧を備えた予測可能で再現可能な実行パターンを提供します。\n\n**シナリオ例:** メール処理システムで、まずスパム検出エージェントを使用し、その分類に基づいて条件付きで異なる専門エージェントにルーティングします。オーケストレーションは、どのステップで障害が発生しても自動的に復旧し、完了済みのエージェント呼び出しは再実行されません。\n- # Python\n\napp.orchestration\\_trigger(context\\_name=\"context\") def document\\_publishing\\_orchestration(context: DurableOrchestrationContext): \"\"\"複数の専門エージェントを協調させる決定的オーケストレーション。\"\"\" doc\\_request = context.get\\_input()\n\n# オーケストレーションのコンテキストから専門エージェントを取得\nresearch\\_agent = context.get\\_agent(\"ResearchAgent\") writer\\_agent = context.get\\_agent(\"DocumentPublisherAgent\")\n\n# ステップ 1：Web 検索でトピックを調査する\nresearch\\_result = yield research\\_agent.run( messages=f\"次のトピックを調査し、主要な情報を収集してください：{doc\\_request.topic}\", response\\_schema=ResearchResult )\n\n# ステップ 2：調査結果に基づいてアウトラインを生成する\noutline = yield context.call\\_activity(\"generate\\_outline\", { \"topic\": doc\\_request.topic, \"research\\_data\": research\\_result.findings })\n\n# ステップ 3：調査結果とアウトラインに基づいてドキュメントを作成する\ndocument = yield writer\\_agent.run( messages=f\"\"\"以下のトピックについて、網羅的なドキュメントを作成してください：{doc\\_request.topic}\n\n調査結果: {research\\_result.findings} アウトライン: {outline}\n\n適切な書式で、構造化され読みやすく、魅力的なドキュメントにしてください。必要に応じて出典（引用）も含めてください。\"\"\", response\\_schema=DocumentResponse )\n\n# ステップ 4：生成したドキュメントを保存して公開する\nreturn yield context.call\\_activity(\"publish\\_document\", { \"title\": doc\\_request.topic, \"content\": document.text, \"citations\": document.citations })\n\n### **Human-in-the-loop（人間を介在させる仕組み）**\n\nオーケストレーションやエージェントは、人間の入力、承認、レビューを待つ間、コンピュートリソースを消費せずに一時停止できます。耐久性のある実行 (durable execution) により、アプリがクラッシュや再起動しても、人間の応答を待つ間、数日から数週間にわたってオーケストレーションを待機させることが可能です。サーバーレスホスティングと組み合わせることで、待機期間中はすべてのコンピュートリソースが停止し、人間が入力を提供するまでコンピュートコストが完全に排除されます。\n\n**シナリオ例:** コンテンツ公開エージェントが下書きを生成し、人間のレビュー担当者に送信して、承認を数日間待機するケース。この間、レビュー期間中はコンピュートリソースを実行（または課金）しません。人間の応答が届くと、オーケストレーションは会話コンテキストと実行状態を完全に保持したまま自動的に再開します。\n- # Python\n\napp.orchestration\\_trigger(context\\_name=\"context\") def content\\_approval\\_workflow(context: DurableOrchestrationContext): \"\"\"人間を介在させるワークフロー（待機中はコストゼロ）\"\"\" topic = context.get\\_input()\n\n# ステップ 1：エージェントを使ってコンテンツを生成\ncontent\\_agent = context.get\\_agent(\"ContentGenerationAgent\") draft\\_content = yield content\\_agent.run(f\"{topic} についての記事を書いてください\")\n\n# ステップ 2：人間によるレビューを依頼\nyield context.call\\_activity(\"notify\\_reviewer\", draft\\_content)\n\n# ステップ 3：承認を待機（待機中はコンピュートリソースを消費しない）\napproval\\_event = context.wait\\_for\\_external\\_event(\"ApprovalDecision\") timeout\\_task = context.create\\_timer(context.current\\_utc\\_datetime + timedelta(hours=24))\n\nwinner = yield context.task\\_any([approval\\_event, timeout\\_task])\n\nif winner == approval\\_event: timeout\\_task.cancel() approved = approval\\_event.result\n\nif approved: result = yield context.call\\_activity(\"publish\\_content\", draft\\_content) return result else: return \"コンテンツは却下されました\" else:\n# タイムアウト時：レビューをエスカレーション\nresult = yield context.call\\_activity(\"escalate\\_for\\_review\", draft\\_content) return result\n\n### **Built-in agent observability（エージェントの組み込み可観測性）**\n\nFunction App を [Durable Task Scheduler](https://learn.microsoft.com/en-us/azure/azure-functions/durable/durable-task-scheduler/durable-task-scheduler) を耐久バックエンドとして構成します（エージェントとオーケストレーションの状態を永続化する仕組み）。は、耐久エージェントに推奨されるバックエンドであり、最高のスループット性能、完全に管理されたインフラ、そして UI ダッシュボードによる組み込みの可観測性を提供します。\n\n**Durable Task Scheduler ダッシュボードは、エージェントの操作を深く可視化します：**\n\n- **会話履歴 (Conversation history):** 各エージェントセッションの完全な会話スレッドを表示し、すべてのメッセージ、ツール呼び出し、任意時点のコンテキストを確認可能\n- **マルチエージェントの可視化 (Multi-agent visualization):** 複数の専門エージェントを呼び出す際の実行フローを、エージェント間のハンドオフ、並列実行、条件分岐を含む視覚的な表現で表示\n- **パフォーマンス指標 (Performance metrics):** エージェントの応答時間、トークン使用量、オーケストレーションの実行時間を監視\n- **実行履歴 (Execution history):** デバッグ用に完全なリプレイ機能を備えた詳細な実行ログにアクセス可能\n\n![]()![]()![]()\n\n## **Demo Video**\n\n## **Language support**\n\nThe Durable Task Extension は以下の言語をサポートしています:\n\n- C# (.NET 8.0+) with Azure Functions\n- Python (3.10+) with Azure Functions\n\nSupport for additional computes coming soon.\n\n## **今日から始めてみましょう**\n\n#### [Click here to create and run a durable agent](https://aka.ms/create-and-run-durable-agent)\n\n## **Learn more**\n\n- [Overview documentation](https://aka.ms/durable-extension-for-af)\n- [C# Samples](https://aka.ms/durable-extension-csharp-samples)\n- [Python Samples](https://aka.ms/durable-extension-python-samples)\n\n### **原文**\n\n[Bulletproof agents with the durable task extension for Microsoft Agent Framework | Microsoft Community Hub](https://techcommunity.microsoft.com/blog/appsonazureblog/bulletproof-agents-with-the-durable-task-extension-for-microsoft-agent-framework/4467122)",
  "FeedName": "Microsoft Tech Community",
  "ProcessedDate": "2025-11-19 22:04:41",
  "Tags": [],
  "Title": "Durable Task Extension for Microsoft Agent Framework で、堅牢なエージェントを構築する"
}
