{
  "FeedName": "Microsoft Tech Community",
  "Description": "In managing data within Azure blob storage accounts and Azure data lake gen 2 storage accounts, organizations often encounter scenarios where blobs have been deleted but remain in a soft-deleted state. To calculate the remaining retention days for all such blobs across an entire storage account can be a critical requirement for customers seeking to optimize data management and ensure compliance with retention policies.\n\nAdditionally, certain blobs may have an expiry time set, scheduling their deletion for a future date. To facilitate the identification and monitoring of these blobs and their respective expiry times, a custom query has been written to efficiently list and calculate expiry information, enabling users to proactively manage their storage resources.\n\nThe expiry time for Azure blobs is set using the Set Blob Expiry operation. This feature is present in only Hierarchical namespace enabled storage accounts.\n\nWe can set the expiry with below steps:\n\ni) Azure Storage action- [About Azure Storage Actions - Azure Storage Actions | Microsoft Learn](https://learn.microsoft.com/en-us/azure/storage-actions/overview#supported-regions) Storage action can be used to set blob expiry, share a high-level snippet for the operation below\n\n![]()\n\nii) REST API- [Set Blob Expiry (REST API) - Azure Storage | Microsoft Learn](https://learn.microsoft.com/en-us/rest/api/storageservices/set-blob-expiry?tabs=microsoft-entra-id) to set the expiry time for your blobs. This ensures that each blob has a defined lifecycle and will be deleted after the specified period.\n\nIn this blog, it is a step-by-step process of listing the expiry time and retention of the blobs using Blob Inventory report and then parsing it using Synapse.\n\n**1. Set blob inventory rule**\n\n![]()\n\nGet CSV file from blob inventory run. Go to the container where inventory reports are getting stored. Navigate to the recent date folder and get url of Blob Inventory csv life. Sharing the below snippet for reference:\n\n![]()\n\n**2. Create an Azure Synapse workspace**\n\nNext, [create an Azure Synapse workspace](https://learn.microsoft.com/en-us/azure/synapse-analytics/get-started-create-workspace) where you will execute a SQL query to report the inventory results.\n\nCreate the SQL query: After you create your Azure Synapse workspace, do the following steps.\n\n- Navigate to [https://web.azuresynapse.net](https://web.azuresynapse.net/).\n- Select the **Develop** tab on the left edge.\n- Select the large plus sign (+) to add an item.\n- Select **SQL script**.\n\n**3. Use the sample query below to get the expiry time and remaining retention days of blob respectively**\n\n*select*\n\n*LEFT([Name], CHARINDEX('/', [Name]) - 1) AS Container,*\n\n*RIGHT([Name], LEN([Name])- CHARINDEX('/',[Name])) AS Blob,*\n\n*[Expiry-time]*\n\n*from OPENROWSET(*\n\n*bulk '',*\n\n*format='csv', parser\\_version='2.0', header\\_row=true*\n\n*) as Source*\n\n![]()\n\nFor blobs which got deleted directly, you can calculate the remaining retention days since the data is present in soft deleted state and will be deleted permanently after the retention days complete.\n\n*select*\n\n*LEFT([Name], CHARINDEX('/', [Name]) - 1) AS Container,*\n\n*RIGHT([Name], LEN([Name])- CHARINDEX('/',[Name])) AS Blob,*\n\n*[Expiry-time],*\n\n*RemainingRetentionDays*\n\n*from OPENROWSET(*\n\n*bulk '',*\n\n*format='csv', parser\\_version='2.0', header\\_row=true*\n\n*) as Source*\n\n![]()\n\nIn the above snippet, the Null value represents that the blob is not deleted and no expiry time is set on the blob yet.\n\nPlease Note: Calculating blob expiry from blob inventory is one way, customer can explore other options such as Powershell and Azure CLI to achieve the same.\n\n**Reference links:-**[**Set Blob Expiry (REST API) - Azure Storage | Microsoft Learn**](https://learn.microsoft.com/en-us/rest/api/storageservices/set-blob-expiry?tabs=microsoft-entra-id)[**Create a storage task - Azure Storage Actions | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage-actions/storage-tasks/storage-task-create?tabs=azure-portal)[**Azure Storage blob inventory | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage/blobs/blob-inventory)[**Calculate blob count and size using Azure Storage inventory | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage/blobs/calculate-blob-count-size)",
  "FeedLevelAuthor": "rss.livelink.threads-in-node",
  "Link": "https://techcommunity.microsoft.com/t5/azure-paas-blog/deriving-expiry-days-and-remaining-retention-days-for-blobs/ba-p/4466586",
  "Author": "Harshi_mrinal",
  "PubDate": "2025-11-11T05:35:25+00:00",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "ProcessedDate": "2025-11-11 06:03:32",
  "Title": "Deriving expiry days and remaining retention days for blobs through blob inventory",
  "Tags": [],
  "OutputDir": "_community",
  "EnhancedContent": "In managing data within Azure blob storage accounts and Azure data lake gen 2 storage accounts, organizations often encounter scenarios where blobs have been deleted but remain in a soft-deleted state. To calculate the remaining retention days for all such blobs across an entire storage account can be a critical requirement for customers seeking to optimize data management and ensure compliance with retention policies.\n\nAdditionally, certain blobs may have an expiry time set, scheduling their deletion for a future date. To facilitate the identification and monitoring of these blobs and their respective expiry times, a custom query has been written to efficiently list and calculate expiry information, enabling users to proactively manage their storage resources.\n\nThe expiry time for Azure blobs is set using the Set Blob Expiry operation. This feature is present in only Hierarchical namespace enabled storage accounts.\n\nWe can set the expiry with below steps:\n\ni) Azure Storage action- [About Azure Storage Actions - Azure Storage Actions | Microsoft Learn](https://learn.microsoft.com/en-us/azure/storage-actions/overview#supported-regions) Storage action can be used to set blob expiry, share a high-level snippet for the operation below\n\nii) REST API- [Set Blob Expiry (REST API) - Azure Storage | Microsoft Learn](https://learn.microsoft.com/en-us/rest/api/storageservices/set-blob-expiry?tabs=microsoft-entra-id) to set the expiry time for your blobs. This ensures that each blob has a defined lifecycle and will be deleted after the specified period.\n\nIn this blog, it is a step-by-step process of listing the expiry time and retention of the blobs using Blob Inventory report and then parsing it using Synapse.\n\n**1. Set blob inventory rule**\n\nGet CSV file from blob inventory run. Go to the container where inventory reports are getting stored. Navigate to the recent date folder and get url of Blob Inventory csv life. Sharing the below snippet for reference:\n\n**2. Create an Azure Synapse workspace**\n\nNext, [create an Azure Synapse workspace](https://learn.microsoft.com/en-us/azure/synapse-analytics/get-started-create-workspace) where you will execute a SQL query to report the inventory results.\n\nCreate the SQL query: After you create your Azure Synapse workspace, do the following steps.\n\n- Navigate to [https://web.azuresynapse.net](https://web.azuresynapse.net/).\n- Select the **Develop** tab on the left edge.\n- Select the large plus sign (+) to add an item.\n- Select **SQL script**.\n\n**3. Use the sample query below to get the expiry time and remaining retention days of blob respectively**\n\n*select*\n\n*LEFT([Name], CHARINDEX('/', [Name]) - 1) AS Container,*\n\n*RIGHT([Name], LEN([Name])- CHARINDEX('/',[Name])) AS Blob,*\n\n*[Expiry-time]*\n\n*from OPENROWSET(*\n\n*bulk '&lt;URL to your inventory CSV file&gt;',*\n\n*format='csv', parser\\_version='2.0', header\\_row=true*\n\n*) as Source*\n\nFor blobs which got deleted directly, you can calculate the remaining retention days since the data is present in soft deleted state and will be deleted permanently after the retention days complete.\n\n*select*\n\n*LEFT([Name], CHARINDEX('/', [Name]) - 1) AS Container,*\n\n*RIGHT([Name], LEN([Name])- CHARINDEX('/',[Name])) AS Blob,*\n\n*[Expiry-time],*\n\n*RemainingRetentionDays*\n\n*from OPENROWSET(*\n\n*bulk '&lt;URL to your inventory CSV file&gt;',*\n\n*format='csv', parser\\_version='2.0', header\\_row=true*\n\n*) as Source*\n\nIn the above snippet, the Null value represents that the blob is not deleted and no expiry time is set on the blob yet.\n\nPlease Note: Calculating blob expiry from blob inventory is one way, customer can explore other options such as Powershell and Azure CLI to achieve the same.\n\n**Reference links:-**[**Set Blob Expiry (REST API) - Azure Storage | Microsoft Learn**](https://learn.microsoft.com/en-us/rest/api/storageservices/set-blob-expiry?tabs=microsoft-entra-id)[**Create a storage task - Azure Storage Actions | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage-actions/storage-tasks/storage-task-create?tabs=azure-portal)[**Azure Storage blob inventory | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage/blobs/blob-inventory)[**Calculate blob count and size using Azure Storage inventory | Microsoft Learn**](https://learn.microsoft.com/en-us/azure/storage/blobs/calculate-blob-count-size)\n\nUpdated Nov 03, 2025\n\nVersion 1.0\n\n[azure storage](/tag/azure%20storage?nodeId=board%3AAzurePaaSBlog)\n\n[!\\[Harshi_mrinal&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/m_assets/avatars/default/avatar-1.svg?image-dimensions=50x50)](/users/harshi_mrinal/2171186) [Harshi_mrinal](/users/harshi_mrinal/2171186) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined November 28, 2023\n\n[View Profile](/users/harshi_mrinal/2171186)\n\n/category/azure/blog/azurepaasblog [Azure PaaS Blog](/category/azure/blog/azurepaasblog) Follow this blog board to get notified when there's new activity"
}
