{
  "ProcessedDate": "2025-11-18 18:07:20",
  "Tags": [],
  "Author": "ranjsharma",
  "OutputDir": "_community",
  "PubDate": "2025-11-18T17:33:43+00:00",
  "Title": "Integrating Azure Application Gateway v2 with Azure API Management for secure and scalable API",
  "FeedLevelAuthor": "rss.livelink.threads-in-node",
  "FeedName": "Microsoft Tech Community",
  "Link": "https://techcommunity.microsoft.com/t5/azure-networking-blog/integrating-azure-application-gateway-v2-with-azure-api/ba-p/4470804",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "Description": "Why Application Gateway v2 + Azure API Management?\n\n- Layer-7 routing with path-based rules, host headers, URL rewrites, and WAF protection (OWASP Core Rule Set).\n\n- Azure API Management provides API abstraction, versioning, throttling, caching, JWT validation, and per-API policies.\n\n- Combined, App Gateway becomes the internet-facing secure entry point and Azure API Management the control plane for API governance.\n\nScenario:\n\nInternet → App Gateway (WAF) → Azure API Management (External) → Backends\n\nBest when Azure API Management needs to be publicly reachable but protected by WAF and central routing.\n\n[Client] ─HTTPS──> [App Gateway v2 (WAF)] ─HTTPS──> [Azure API Management (External)] ─> [Private/On-prem/Azure Backends]\n\nPros: Simple, fast to implement, WAF in front, supports CDN/Front Door chaining.\n\nCons: Azure API Management is public; additional steps required for IP allow-lists and mTLS.\n\nScenario2:\n\nInternet → App Gateway (WAF) → Azure API Management (Internal) via Private Endpoint\n\nAzure API Management is internal; only App Gateway is public. Zero-trust friendly.\n\n[Client] ─HTTPS──> [App Gateway v2 (WAF, Public)] ─HTTPS──> [Private Endpoint] ─> [Azure API Management (Internal)] ─> [Backends]\n\nPros: Azure API Management is not exposed to the internet; traffic flows through App Gateway + Private Link.\n\nCons: Requires vNet planning, DNS, and App Gateway-to-Private Link name resolution.\n\nScenario3:\n\nAzure API Management (External) → App Gateway (Internal) → Private Backends\n\nAzure API Management is the public front door; App Gateway does L7 routing to internal services.\n\n[Client] ─HTTPS──> [Azure API Management (External)] ─HTTPS──> [App Gateway (Internal/WAF)] ─> [Backends]\n\nPros: Privileged Identity Management security & governance is your internet front door.\n\nCons: More Azure API Management policy work; App Gateway must be reachable from Azure API Management.\n\nNetwork & DNS design checklist:\n\n- Virtual networks & subnets:\n\n- App Gateway-Subnet (required dedicated subnet)\n\n- Azure API Management-Subnet (for internal tier)\n\n- Shared-services-Subnet for Bastion/jumpbox/logging\n\n- Private Link: Enable Azure API Management private endpoint in Azure API Management-Subnet.\n\n- Private DNS Zones: privatelink.azure-api.net for Azure API Management, custom zones for backends.\n\n- Name resolution: App Gateway must resolve Azure API Management private FQDN via vNet DNS or Azure Private DNS.\n\n- Firewall & NSGs: Restrict inbound/outbound; allow only required ports to Azure API Management, Key Vault, Log Analytics.\n\n- Hybrid Connectivity: Site-to-site VPN or ExpressRoute for on-prem backends; consider Azure Firewall or NVA.\n\nCertificates & TLS\n\n- Custom Domains:\n\n- App Gateway: api.contoso.com\n\n- Azure API Management: gateway.contoso.com (with custom hostname on Azure API Management)\n\n- TLS Ports: HTTPS 443 end-to-end; disable TLS 1.0/1.1.\n\n- Cert storage: Use Azure Key Vault for SSL certs; integrate App Gateway & Azure API Management with Key Vault (managed identity).\n\n- mTLS (Client Certs): Enforce on Azure API Management with policies; optionally on App Gateway via mutual auth for selected listeners.\n\nWAF (Web Application Firewall) on App Gateway v2\n\n- Modes: Detection vs prevention (recommend prevention once tuned).\n\n- CRS: Start with 3.2; baseline exclusions for APIs (JSON payloads).\n\n- Managed rules: Enable bot protection, set anomaly scoring, create exclusions for headers like Authorization.\n\n- Logging: Send WAF logs to Log Analytics; build alerts for blocked requests spikes.\n\nAzure API Management Policies – Common patterns\n\n- Inbound: `validate-jwt`, `check-header`, `rate-limit`, `ip-filter`, `set-backend-service`\n\n- Backend: `retry`, `forward-request` with mTLS\n\n- Outbound: `set-header`, `find-and-replace`, `cache`\n\n- Global vs API vs Operation: Keep global minimal; override at API/operation for precision.\n\n- Dev, Test, Prod: Parameterize via named values and Key Vault references.\n\nExample – JWT validation and rate limit:\n\nxml\n\n/v2.0/.well-known/openid-configuration\" />\n\napi://contoso-app-id\n\nhttps://sts.windows.net//\n\n## Terraform – Core Resources (App Gateway v2 + Azure API Management)\n\nNote: Simplified example; parameterize for prod, add Key Vault integrations, diagnostics, and role assignments.\n\n# Variables (example)\n\nvariable \"location\" { default = \"eastus\" }\n\nvariable \"rg\\_name\" { default = \"rg-appgw-apim\" }\n\nvariable \"vnet\\_name\" { default = \"vnet-core\" }\n\nvariable \"appgw\\_subnet\" { default = \"snet-appgw\" }\n\nvariable \"apim\\_subnet\" { default = \"snet-apim\" }\n\nprovider \"azurerm\" { features {} }\n\nresource \"azurerm\\_resource\\_group\" \"rg\" {\n\nname = var.rg\\_name\n\nlocation = var.location\n\n}\n\nresource \"azurerm\\_virtual\\_network\" \"vnet\" {\n\nname = var.vnet\\_name\n\nlocation = var.location\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\naddress\\_space = [\"10.10.0.0/16\"]\n\n}\n\nresource \"azurerm\\_subnet\" \"snet\\_appgw\" {\n\nname = var.appgw\\_subnet\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nvirtual\\_network\\_name = azurerm\\_virtual\\_network.vnet.name\n\naddress\\_prefixes = [\"10.10.1.0/24\"]\n\n}\n\nresource \"azurerm\\_subnet\" \"snet\\_apim\" {\n\nname = var.apim\\_subnet\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nvirtual\\_network\\_name = azurerm\\_virtual\\_network.vnet.name\n\naddress\\_prefixes = [\"10.10.2.0/24\"]\n\n}\n\n# Public IP for App Gateway\n\nresource \"azurerm\\_public\\_ip\" \"appgw\\_pip\" {\n\nname = \"pip-appgw\"\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nlocation = var.location\n\nallocation\\_method = \"Static\"\n\nsku = \"Standard\"\n\n}\n\n# Application Gateway v2 (WAF)\n\nresource \"azurerm\\_application\\_gateway\" \"appgw\" {\n\nname = \"agw-v2-waf\"\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nlocation = var.location\n\nsku {\n\nname = \"WAF\\_v2\"\n\ntier = \"WAF\\_v2\"\n\ncapacity = 2\n\n}\n\ngateway\\_ip\\_configuration {\n\nname = \"appgw-ipcfg\"\n\nsubnet\\_id = azurerm\\_subnet.snet\\_appgw.id\n\n}\n\nfrontend\\_port {\n\nname = \"https-port\"\n\nport = 443\n\n}\n\nfrontend\\_ip\\_configuration {\n\nname = \"appgw-feip\"\n\npublic\\_ip\\_address\\_id = azurerm\\_public\\_ip.appgw\\_pip.id\n\n}\n\nssl\\_certificate {\n\nname = \"ssl-agw\"\n\ndata = filebase64(\"certs/agw.pfx\")\n\npassword = var.agw\\_pfx\\_password\n\n}\n\nhttp\\_listener {\n\nname = \"listener-https\"\n\nfrontend\\_ip\\_configuration\\_name = \"appgw-feip\"\n\nfrontend\\_port\\_name = \"https-port\"\n\nprotocol = \"Https\"\n\nssl\\_certificate\\_name = \"ssl-agw\"\n\nhost\\_name = \"api.contoso.com\"\n\n}\n\nbackend\\_address\\_pool {\n\nname = \"apim-bepool\"\n\n# For Azure API Management private endpoint, use FQDN via custom probe, or IP when static\n\nfqdns = [\"gateway.contoso.internal\"]\n\n}\n\nbackend\\_http\\_settings {\n\nname = \"https-settings\"\n\ncookie\\_based\\_affinity = \"Disabled\"\n\nport = 443\n\nprotocol = \"Https\"\n\npick\\_host\\_name\\_from\\_backend\\_address = true\n\nrequest\\_timeout = 30\n\nprobe\\_name = \"apim-probe\"\n\n}\n\nprobe {\n\nname = \"apim-probe\"\n\nprotocol = \"Https\"\n\npath = \"/status-0123456789abcdef\"\n\npick\\_host\\_name\\_from\\_backend\\_http\\_settings = true\n\ninterval = 30\n\ntimeout = 30\n\nunhealthy\\_threshold = 3\n\n}\n\nrequest\\_routing\\_rule {\n\nname = \"route-to-apim\"\n\nrule\\_type = \"Basic\"\n\nhttp\\_listener\\_name = \"listener-https\"\n\nbackend\\_address\\_pool\\_name = \"apim-bepool\"\n\nbackend\\_http\\_settings\\_name = \"https-settings\"\n\n}\n\nwaf\\_configuration {\n\nenabled = true\n\nfirewall\\_mode = \"Prevention\"\n\nrule\\_set\\_type = \"OWASP\"\n\nrule\\_set\\_version = \"3.2\"\n\n}\n\n}\n\n# Azure API Management (Developer SKU for demo – use Premium for prod & VNET integration)\n\nresource \"azurerm\\_api\\_management\" \"apim\" {\n\nname = \"apim-contoso\"\n\nlocation = var.location\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\npublisher\\_name = \"Contoso\"\n\npublisher\\_email = \"admin@contoso.com\"\n\nsku\\_name = \"Developer\\_1\"\n\nvirtual\\_network\\_type = \"None\" # Use \"Internal\" for vNet, then add private endpoint\n\n}\n\n## Azure DevOps – CI/CD YAML (App Gateway + Azure API Management via Terraform)\n\n`yaml\n\ntrigger:\n\nbranches:\n\ninclude: [ main ]\n\npool:\n\nvmImage: 'ubuntu-latest'\n\nvariables:\n\nTF\\_VERSION: '1.8.5'\n\nARM\\_USE\\_MSI: true\n\nstages:\n\n- stage: Validate\n\njobs:\n\n- job: tf\\_validate\n\nsteps:\n\n- task: Bash@3\n\ndisplayName: 'Install Terraform'\n\ninputs:\n\ntargetType: 'inline'\n\nscript: |\n\nsudo apt-get update && sudo apt-get install -y unzip\n\ncurl -L -o tf.zip https://releases.hashicorp.com/terraform/${TF\\_VERSION}/terraform\\_${TF\\_VERSION}\\_linux\\_amd64.zip\n\nunzip tf.zip && sudo mv terraform /usr/local/bin/\n\nterraform -version\n\n- task: AzureCLI@2\n\ndisplayName: 'Terraform init & validate'\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform init -backend-config=backend.hcl\n\nterraform fmt -check\n\nterraform validate\n\n- stage: Plan\n\njobs:\n\n- job: tf\\_plan\n\nsteps:\n\n- task: AzureCLI@2\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform plan -out=tfplan\n\n- publish: tfplan\n\nartifact: tfplan\n\n- stage: Apply\n\ncondition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))\n\njobs:\n\n- job: tf\\_apply\n\nsteps:\n\n- download: current\n\nartifact: tfplan\n\n- task: AzureCLI@2\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform apply -auto-approve tfplan\n\n##Observability & diagnostics\n\n- Access Logs: App Gateway & WAF logs to Log Analytics; query with KQL.\n\n- Azure API Management Metrics: Requests, backend duration, cache hits; enable diagnostic settings to Log Analytics/Storage/Event Hub.\n\n- End-to-end tracing: Correlate `x-correlation-id` across App Gateway, Azure API Management, and backend logs.\n\n- Alerts: 4xx/5xx thresholds, WAF blocks spike, Azure API Management throttling events, TLS certificate expiry.\n\n## Security hardening\n\n- Enforce TLS 1.2+, disable weak ciphers.\n\n- WAF exclusions tuned minimally; regular rule reviews.\n\n- Azure API Management IP allow-lists for admin endpoints; use RBAC and separate admin vs gateway hostnames.\n\n- Private Endpoints for Azure API Management & backends; deny public network access where possible.\n\n- mTLS from App Gateway→Azure API Management or Client→Azure API Management when required (Key Vault for client certs).\n\n- DDoS Protection on vNet with public exposure; consider Azure Front Door WAF for global edge.\n\n## Cost & Performance\n\n- Right-size App Gateway v2 capacity; enable autoscaling for variable traffic.\n\n- Use Azure API Management Premium only if you need vNet, multi-region, or zone redundancy; otherwise consider Standard/Developer for non-prod.\n\n- Caching policies in Azure API Management reduce backend load; use response compression.\n\n- Health probes optimized for backend responsiveness (avoid tight intervals).\n\n## Troubleshooting\n\n- App Gateway 502/504: Check backend health, probe path, SNI/host header, TLS ciphers, DNS resolution to Azure API Management.\n\n- Azure API Management 401/403: Validate JWT audience/issuer; clock skew; named values; policy order.\n\n- Private Endpoint: DNS record in `privatelink.azure-api.net` exists; App Gateway subnet can resolve; NSG not blocking.\n\n- Cert Issues: PFX password correct; full chain present; key usage supports server auth.\n\n- Performance: Turn on App Gateway autoscaling; review Azure API Management throttling; check backend rate limits.\n\n## Production checklist\n\n- Custom domains & cert rotation via Key Vault\n\n- WAF in Prevention with tuned exclusions\n\n- Azure API Management policies for auth, rate limiting, cache, headers\n\n- Private endpoints + DNS validated end-to-end\n\n- Autoscaling & health probes tuned\n\n- Diagnostics & alerts configured\n\n- CI/CD gated approvals; Terraform state secured\n\n- Runbooks for failover & certificate renewal",
  "EnhancedContent": "## This post walks through integrating Azure Application Gateway v2 (with WAF) and Azure API Management to deliver a secure, scalable, and enterprise-grade API front door. We’ll cover reference architectures, networking, certificates, Azure API Management policies, zero-trust patterns with private endpoints, and end-to-end automation using Terraform and Azure DevOps.\n\nWhy Application Gateway v2 + Azure API Management?\n\n- Layer-7 routing with path-based rules, host headers, URL rewrites, and WAF protection (OWASP Core Rule Set).\n\n- Azure API Management provides API abstraction, versioning, throttling, caching, JWT validation, and per-API policies.\n\n- Combined, App Gateway becomes the internet-facing secure entry point and Azure API Management the control plane for API governance.\n\nScenario:\n\nInternet → App Gateway (WAF) → Azure API Management (External) → Backends\n\nBest when Azure API Management needs to be publicly reachable but protected by WAF and central routing.\n\n[Client] ─HTTPS──&gt; [App Gateway v2 (WAF)] ─HTTPS──&gt; [Azure API Management (External)] ─&gt; [Private/On-prem/Azure Backends]\n\nPros: Simple, fast to implement, WAF in front, supports CDN/Front Door chaining.\n\nCons: Azure API Management is public; additional steps required for IP allow-lists and mTLS.\n\nScenario2:\n\nInternet → App Gateway (WAF) → Azure API Management (Internal) via Private Endpoint\n\nAzure API Management is internal; only App Gateway is public. Zero-trust friendly.\n\n[Client] ─HTTPS──&gt; [App Gateway v2 (WAF, Public)] ─HTTPS──&gt; [Private Endpoint] ─&gt; [Azure API Management (Internal)] ─&gt; [Backends]\n\nPros: Azure API Management is not exposed to the internet; traffic flows through App Gateway + Private Link.\n\nCons: Requires vNet planning, DNS, and App Gateway-to-Private Link name resolution.\n\nScenario3:\n\nAzure API Management (External) → App Gateway (Internal) → Private Backends\n\nAzure API Management is the public front door; App Gateway does L7 routing to internal services.\n\n[Client] ─HTTPS──&gt; [Azure API Management (External)] ─HTTPS──&gt; [App Gateway (Internal/WAF)] ─&gt; [Backends]\n\nPros: Privileged Identity Management security & governance is your internet front door.\n\nCons: More Azure API Management policy work; App Gateway must be reachable from Azure API Management.\n\nNetwork & DNS design checklist:\n\n- Virtual networks & subnets:\n\n- App Gateway-Subnet (required dedicated subnet)\n\n- Azure API Management-Subnet (for internal tier)\n\n- Shared-services-Subnet for Bastion/jumpbox/logging\n\n- Private Link: Enable Azure API Management private endpoint in Azure API Management-Subnet.\n\n- Private DNS Zones: privatelink.azure-api.net for Azure API Management, custom zones for backends.\n\n- Name resolution: App Gateway must resolve Azure API Management private FQDN via vNet DNS or Azure Private DNS.\n\n- Firewall & NSGs: Restrict inbound/outbound; allow only required ports to Azure API Management, Key Vault, Log Analytics.\n\n- Hybrid Connectivity: Site-to-site VPN or ExpressRoute for on-prem backends; consider Azure Firewall or NVA.\n\nCertificates & TLS\n\n- Custom Domains:\n\n- App Gateway: api.contoso.com\n\n- Azure API Management: gateway.contoso.com (with custom hostname on Azure API Management)\n\n- TLS Ports: HTTPS 443 end-to-end; disable TLS 1.0/1.1.\n\n- Cert storage: Use Azure Key Vault for SSL certs; integrate App Gateway & Azure API Management with Key Vault (managed identity).\n\n- mTLS (Client Certs): Enforce on Azure API Management with policies; optionally on App Gateway via mutual auth for selected listeners.\n\nWAF (Web Application Firewall) on App Gateway v2\n\n- Modes: Detection vs prevention (recommend prevention once tuned).\n\n- CRS: Start with 3.2; baseline exclusions for APIs (JSON payloads).\n\n- Managed rules: Enable bot protection, set anomaly scoring, create exclusions for headers like Authorization.\n\n- Logging: Send WAF logs to Log Analytics; build alerts for blocked requests spikes.\n\nAzure API Management Policies – Common patterns\n\n- Inbound: `validate-jwt`, `check-header`, `rate-limit`, `ip-filter`, `set-backend-service`\n\n- Backend: `retry`, `forward-request` with mTLS\n\n- Outbound: `set-header`, `find-and-replace`, `cache`\n\n- Global vs API vs Operation: Keep global minimal; override at API/operation for precision.\n\n- Dev, Test, Prod: Parameterize via named values and Key Vault references.\n\nExample – JWT validation and rate limit:\n\nxml\n\n&lt;policies&gt;\n\n&lt;inbound&gt;\n\n&lt;base /&gt;\n\n&lt;validate-jwt header-name=\"Authorization\" failed-validation-httpcode=\"401\"&gt;\n\n&lt;openid-config url=\"https://login.microsoftonline.com/&lt;tenant-id&gt;/v2.0/.well-known/openid-configuration\" /&gt;\n\n&lt;audiences&gt;\n\n&lt;audience&gt;api://contoso-app-id&lt;/audience&gt;\n\n&lt;/audiences&gt;\n\n&lt;issuers&gt;\n\n&lt;issuer&gt;https://sts.windows.net/&lt;tenant-id&gt;/&lt;/issuer&gt;\n\n&lt;/issuers&gt;\n\n&lt;/validate-jwt&gt;\n\n&lt;rate-limit calls=\"100\" renewal-period=\"60\" /&gt;\n\n&lt;/inbound&gt;\n\n&lt;backend&gt;\n\n&lt;forward-request /&gt;\n\n&lt;/backend&gt;\n\n&lt;outbound&gt;\n\n&lt;base /&gt;\n\n&lt;/outbound&gt;\n\n&lt;/policies&gt;\n\n## Terraform – Core Resources (App Gateway v2 + Azure API Management)\n\nNote: Simplified example; parameterize for prod, add Key Vault integrations, diagnostics, and role assignments.\n\n# Variables (example)\n\nvariable \"location\" { default = \"eastus\" }\n\nvariable \"rg\\_name\" { default = \"rg-appgw-apim\" }\n\nvariable \"vnet\\_name\" { default = \"vnet-core\" }\n\nvariable \"appgw\\_subnet\" { default = \"snet-appgw\" }\n\nvariable \"apim\\_subnet\" { default = \"snet-apim\" }\n\nprovider \"azurerm\" { features {} }\n\nresource \"azurerm\\_resource\\_group\" \"rg\" {\n\nname     = var.rg\\_name\n\nlocation = var.location\n\n}\n\nresource \"azurerm\\_virtual\\_network\" \"vnet\" {\n\nname                = var.vnet\\_name\n\nlocation            = var.location\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\naddress\\_space       = [\"10.10.0.0/16\"]\n\n}\n\nresource \"azurerm\\_subnet\" \"snet\\_appgw\" {\n\nname                 = var.appgw\\_subnet\n\nresource\\_group\\_name  = azurerm\\_resource\\_group.rg.name\n\nvirtual\\_network\\_name = azurerm\\_virtual\\_network.vnet.name\n\naddress\\_prefixes     = [\"10.10.1.0/24\"]\n\n}\n\nresource \"azurerm\\_subnet\" \"snet\\_apim\" {\n\nname                 = var.apim\\_subnet\n\nresource\\_group\\_name  = azurerm\\_resource\\_group.rg.name\n\nvirtual\\_network\\_name = azurerm\\_virtual\\_network.vnet.name\n\naddress\\_prefixes     = [\"10.10.2.0/24\"]\n\n}\n\n# Public IP for App Gateway\n\nresource \"azurerm\\_public\\_ip\" \"appgw\\_pip\" {\n\nname                = \"pip-appgw\"\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nlocation            = var.location\n\nallocation\\_method   = \"Static\"\n\nsku                 = \"Standard\"\n\n}\n\n# Application Gateway v2 (WAF)\n\nresource \"azurerm\\_application\\_gateway\" \"appgw\" {\n\nname                = \"agw-v2-waf\"\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\nlocation            = var.location\n\nsku {\n\nname = \"WAF\\_v2\"\n\ntier = \"WAF\\_v2\"\n\ncapacity = 2\n\n}\n\ngateway\\_ip\\_configuration {\n\nname      = \"appgw-ipcfg\"\n\nsubnet\\_id = azurerm\\_subnet.snet\\_appgw.id\n\n}\n\nfrontend\\_port {\n\nname = \"https-port\"\n\nport = 443\n\n}\n\nfrontend\\_ip\\_configuration {\n\nname                 = \"appgw-feip\"\n\npublic\\_ip\\_address\\_id = azurerm\\_public\\_ip.appgw\\_pip.id\n\n}\n\nssl\\_certificate {\n\nname     = \"ssl-agw\"\n\ndata     = filebase64(\"certs/agw.pfx\")\n\npassword = var.agw\\_pfx\\_password\n\n}\n\nhttp\\_listener {\n\nname                           = \"listener-https\"\n\nfrontend\\_ip\\_configuration\\_name = \"appgw-feip\"\n\nfrontend\\_port\\_name             = \"https-port\"\n\nprotocol                       = \"Https\"\n\nssl\\_certificate\\_name           = \"ssl-agw\"\n\nhost\\_name                      = \"api.contoso.com\"\n\n}\n\nbackend\\_address\\_pool {\n\nname = \"apim-bepool\"\n\n# For Azure API Management private endpoint, use FQDN via custom probe, or IP when static\n\nfqdns = [\"gateway.contoso.internal\"]\n\n}\n\nbackend\\_http\\_settings {\n\nname                  = \"https-settings\"\n\ncookie\\_based\\_affinity = \"Disabled\"\n\nport                  = 443\n\nprotocol              = \"Https\"\n\npick\\_host\\_name\\_from\\_backend\\_address = true\n\nrequest\\_timeout       = 30\n\nprobe\\_name            = \"apim-probe\"\n\n}\n\nprobe {\n\nname                = \"apim-probe\"\n\nprotocol            = \"Https\"\n\npath                = \"/status-0123456789abcdef\"\n\npick\\_host\\_name\\_from\\_backend\\_http\\_settings = true\n\ninterval            = 30\n\ntimeout             = 30\n\nunhealthy\\_threshold = 3\n\n}\n\nrequest\\_routing\\_rule {\n\nname                       = \"route-to-apim\"\n\nrule\\_type                  = \"Basic\"\n\nhttp\\_listener\\_name         = \"listener-https\"\n\nbackend\\_address\\_pool\\_name  = \"apim-bepool\"\n\nbackend\\_http\\_settings\\_name = \"https-settings\"\n\n}\n\nwaf\\_configuration {\n\nenabled            = true\n\nfirewall\\_mode      = \"Prevention\"\n\nrule\\_set\\_type      = \"OWASP\"\n\nrule\\_set\\_version   = \"3.2\"\n\n}\n\n}\n\n# Azure API Management (Developer SKU for demo – use Premium for prod & VNET integration)\n\nresource \"azurerm\\_api\\_management\" \"apim\" {\n\nname                = \"apim-contoso\"\n\nlocation            = var.location\n\nresource\\_group\\_name = azurerm\\_resource\\_group.rg.name\n\npublisher\\_name      = \"Contoso\"\n\npublisher\\_email     = \"admin@contoso.com\"\n\nsku\\_name            = \"Developer\\_1\"\n\nvirtual\\_network\\_type = \"None\" # Use \"Internal\" for vNet, then add private endpoint\n\n}\n\n## Azure DevOps – CI/CD YAML (App Gateway + Azure API Management via Terraform)\n\n`yaml\n\ntrigger:\n\nbranches:\n\ninclude: [ main ]\n\npool:\n\nvmImage: 'ubuntu-latest'\n\nvariables:\n\nTF\\_VERSION: '1.8.5'\n\nARM\\_USE\\_MSI: true\n\nstages:\n\n- stage: Validate\n\njobs:\n\n- job: tf\\_validate\n\nsteps:\n\n- task: Bash@3\n\ndisplayName: 'Install Terraform'\n\ninputs:\n\ntargetType: 'inline'\n\nscript: |\n\nsudo apt-get update && sudo apt-get install -y unzip\n\ncurl -L -o tf.zip https://releases.hashicorp.com/terraform/${TF\\_VERSION}/terraform\\_${TF\\_VERSION}\\_linux\\_amd64.zip\n\nunzip tf.zip && sudo mv terraform /usr/local/bin/\n\nterraform -version\n\n- task: AzureCLI@2\n\ndisplayName: 'Terraform init & validate'\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform init -backend-config=backend.hcl\n\nterraform fmt -check\n\nterraform validate\n\n- stage: Plan\n\njobs:\n\n- job: tf\\_plan\n\nsteps:\n\n- task: AzureCLI@2\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform plan -out=tfplan\n\n- publish: tfplan\n\nartifact: tfplan\n\n- stage: Apply\n\ncondition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))\n\njobs:\n\n- job: tf\\_apply\n\nsteps:\n\n- download: current\n\nartifact: tfplan\n\n- task: AzureCLI@2\n\ninputs:\n\nazureSubscription: '$(AZURE\\_SERVICE\\_CONNECTION)'\n\nscriptType: 'bash'\n\nscriptLocation: 'inlineScript'\n\ninlineScript: |\n\nterraform apply -auto-approve tfplan\n\n##Observability & diagnostics\n\n- Access Logs: App Gateway & WAF logs to Log Analytics; query with KQL.\n\n- Azure API Management Metrics: Requests, backend duration, cache hits; enable diagnostic settings to Log Analytics/Storage/Event Hub.\n\n- End-to-end tracing: Correlate `x-correlation-id` across App Gateway, Azure API Management, and backend logs.\n\n- Alerts: 4xx/5xx thresholds, WAF blocks spike, Azure API Management throttling events, TLS certificate expiry.\n\n## Security hardening\n\n- Enforce TLS 1.2+, disable weak ciphers.\n\n- WAF exclusions tuned minimally; regular rule reviews.\n\n- Azure API Management IP allow-lists for admin endpoints; use RBAC and separate admin vs gateway hostnames.\n\n- Private Endpoints for Azure API Management & backends; deny public network access where possible.\n\n- mTLS from App Gateway→Azure API Management or Client→Azure API Management when required (Key Vault for client certs).\n\n- DDoS Protection on vNet with public exposure; consider Azure Front Door WAF for global edge.\n\n## Cost & Performance\n\n- Right-size App Gateway v2 capacity; enable autoscaling for variable traffic.\n\n- Use Azure API Management Premium only if you need vNet, multi-region, or zone redundancy; otherwise consider Standard/Developer for non-prod.\n\n- Caching policies in Azure API Management reduce backend load; use response compression.\n\n- Health probes optimized for backend responsiveness (avoid tight intervals).\n\n## Troubleshooting\n\n- App Gateway 502/504: Check backend health, probe path, SNI/host header, TLS ciphers, DNS resolution to Azure API Management.\n\n- Azure API Management 401/403:  Validate JWT audience/issuer; clock skew; named values; policy order.\n\n- Private Endpoint:  DNS record in `privatelink.azure-api.net` exists; App Gateway subnet can resolve; NSG not blocking.\n\n- Cert Issues: PFX password correct; full chain present; key usage supports server auth.\n\n- Performance: Turn on App Gateway autoscaling; review Azure API Management throttling; check backend rate limits.\n\n## Production checklist\n\n- Custom domains & cert rotation via Key Vault\n\n- WAF in Prevention with tuned exclusions\n\n- Azure API Management policies for auth, rate limiting, cache, headers\n\n- Private endpoints + DNS validated end-to-end\n\n- Autoscaling & health probes tuned\n\n- Diagnostics & alerts configured\n\n- CI/CD gated approvals; Terraform state secured\n\n- Runbooks for failover & certificate renewal\n\nUpdated Nov 18, 2025\n\nVersion 2.0\n\n[application gateway](/tag/application%20gateway?nodeId=board%3AAzureNetworkingBlog)\n\n[!\\[ranjsharma&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/m_assets/avatars/default/avatar-4.svg?image-dimensions=50x50)](/users/ranjsharma/2999223) [ranjsharma](/users/ranjsharma/2999223) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined April 16, 2025\n\n[View Profile](/users/ranjsharma/2999223)\n\n/category/azure/blog/azurenetworkingblog [Azure Networking Blog](/category/azure/blog/azurenetworkingblog) Follow this blog board to get notified when there's new activity"
}
