{
  "Description": "Migrating from NSG Flow Logs to VNet Flow Logs in Azure: Implementation with Terraform\n\nAuthor: Ibrahim Baig (Consultant)\n\n# Executive Summary\n\nMicrosoft is retiring Network Security Group (NSG) flow logs and recommends migrating to Virtual Network (VNet) flow logs. After June 30, 2025, new NSG flow logs cannot be created, and all NSG flow logs will be retired by September 30, 2027. Migrating to VNet flow logs ensures continued support and provides broader, simpler network visibility.\n\n![]()\n\n# What Changed & Key Dates\n\n- June 30, 2025: Creation of new NSG flow logs is blocked.\n\n- September 30, 2027: NSG flow logs are retired (resources deleted; historical blobs remain per retention policy).\n\n- Microsoft provides migration scripts and policy guidance for NSG→VNet flow logs.\n\n# Why Migrate? (Benefits)\n\n## Operational Simplicity & Coverage\n\n- Enable logging at the VNet, subnet, or NIC scope—no dependency on NSG.\n\n- Broader visibility across all workloads inside a VNet, not just NSG-governed traffic.\n\n## Security & Analytics\n\n- Native integration with Traffic Analytics for enriched insights.\n\n- Monitor Azure Virtual Network Manager (AVNM) security admin rules.\n\n## Continuity & Cost Parity\n\n- VNet flow logs are priced the same as NSG flow logs (with 5 GB/month free).\n\n# What’s New in VNet Flow Logs\n\n- Scopes: Enable at VNet, subnet, or NIC level.\n\n- Storage: JSON logs to Azure Storage.\n\n- At-scale enablement: Built-in Azure Policy for auditing and auto-deployment.\n\n- Analytics: Traffic Analytics add-on for deep insights.\n\n- AVNM awareness: Observe centrally managed security admin rules.\n\n# Traffic Analytics: Capabilities & Value\n\nTraffic Analytics (TA) is a powerful add-on for VNet flow logs, providing:\n\n- Automated Traffic Insights: Visualize traffic flows, identify top talkers, and detect anomalous patterns.\n\n- Threat Detection: Surface suspicious flows, lateral movement, and communication with malicious IPs.\n\n- Network Segmentation Validation: Confirm that segmentation policies are effective and spot unintended access.\n\n- Performance Monitoring: Analyze bandwidth usage, latency, and flow volumes for troubleshooting.\n\n- Customizable Dashboards: Drill down by subnet, region, or workload for targeted investigations.\n\n- Integration: Seamless with Azure Monitor and Log Analytics for alerting and automation.\n\nFor practical recipes and advanced use cases, see https://blog.cloudtrooper.net/2024/05/08/vnet-flow-logs-recipes/.\n\n# GAP:\n\nThe Terraform Registry page for azurerm\\_network\\_watcher\\_flow\\_log does not yet provide an explicit VNet flow logs example. In practice, you use the same resource and set target\\_resource\\_id to the ID of the VNet (or Subnet/NIC).\n\nRegistry page (latest): https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network\\_watcher\\_flow\\_log\n\nImportant notes:\n\n- Same resource block: azurerm\\_network\\_watcher\\_flow\\_log\n\n- Use target\\_resource\\_id = (instead of legacy network\\_security\\_group\\_id)\n\n- As of 30 July 2025, creating new NSG flow logs is no longer possible (provider notes); migrate to VNet/Subnet/NIC targets.\n\n- Keep your azurerm provider up-to-date, earlier builds had validation gaps for subnet/NIC IDs; these were tracked and addressed in provider issues.\n\n# Implementation Guide\n\n## Option A — Terraform (Recommended for IaC)\n\nNote: Use a dedicated Storage account for flow logs, as lifecycle rules may be overwritten.\n\n- terraform {\nrequired\\_version = \">= 1.5\" required\\_providers { azurerm = { source = \"hashicorp/azurerm\" version = \">= 3.110.0\" # or latest } } }\n\nprovider \"azurerm\" { features {} }\n\ndata \"azurerm\\_network\\_watcher\" \"this\" { name = \"NetworkWatcher\\_${var.region}\" resource\\_group\\_name = \"NetworkWatcherRG\" }\n\nresource \"azurerm\\_network\\_watcher\\_flow\\_log\" \"vnet\\_flow\\_log\" { name = \"${var.vnet\\_name}-flowlog\" network\\_watcher\\_name = data.azurerm\\_network\\_watcher.this.name resource\\_group\\_name = data.azurerm\\_network\\_watcher.this.resource\\_group\\_name target\\_resource\\_id = azurerm\\_virtual\\_network.vnet.id storage\\_account\\_id = azurerm\\_storage\\_account.flowlogs\\_sa.id enabled = true\n\nretention\\_policy { enabled = true days = 30 }\n\ntraffic\\_analytics { enabled = true workspace\\_id = azurerm\\_log\\_analytics\\_workspace.law.workspace\\_id workspace\\_region = azurerm\\_log\\_analytics\\_workspace.law.location workspace\\_resource\\_id = azurerm\\_log\\_analytics\\_workspace.law.id interval\\_in\\_minutes = 60 }\n\ntags = { owner = \"network-platform\" environment = var.env } }\n\n## Option B — Azure CLI\n- az network watcher flow-log create \\\n--location westus \\ --resource-group MyResourceGroup \\ --name myVNetFlowLog \\ --vnet MyVNetName \\ --storage-account mystorageaccount \\ --workspace \"/subscriptions//resourceGroups//providers/Microsoft.OperationalInsights/workspaces/\" \\ --traffic-analytics true \\ --interval 60\n\n## Option C — Azure Portal\n\n- Go to Network Watcher → Flow logs → + Create.\n\n- Choose Flow log type = Virtual network; select VNet/Subnet/NIC, Storage account, and optionally enable Traffic Analytics.\n\n## Option D — At Scale via Azure Policy\n\n- Use built-in policies to audit and auto-deploy VNet flow logs (DeployIfNotExists).\n\n# Migration Approach (NSG → VNet Flow Logs)\n\n1. Inventory existing NSG flow logs.\n2. Choose migration method: Microsoft script or Azure Policy.\n3. Run both in parallel temporarily to validate.\n4. Disable NSG flow logs before retirement.\n\n# Challenges & Mitigations\n\n- Permissions: Ensure required roles on Log Analytics workspace.\n\n- Terraform lifecycle: Use a dedicated Storage account.\n\n- Tooling compatibility: Verify SIEM/NDR support.\n\n- Provider/API maturity: Use current azurerm provider.\n\n# Validation Checklist\n\n- Storage: New blobs appear in the configured Storage account.\n\n- Traffic Analytics: Data visible in Log Analytics workspace.\n\n- AVNM: Confirm traffic allowed/denied states appear in logs.\n\n# Cost Considerations\n\n- VNet flow logs ingestion: $0.50/GB after 5 GB free/month.\n\n- Traffic Analytics processing: $2.30/GB (60-min) or $3.50/GB (10-min).\n\n# Traffic Analytics Deep Dive:\n\nVNet Flow Logs are stored in Azure Blob Storage. Optionally, you can enable Traffic Analytics, which will do two things: it will enrich the flow logs with additional information, and will send everything to a Log Analytics Workspace for easy querying. This “enrich and forward to Log Analytics” operation will happen in intervals, either every 10 minutes or every hour.\n\n**Table Structure: NTAIPDetails**This table will contain some enrichment data about public IP addresses, including whether they belong to Azure services and their region, and geolocation information for other public IPs. Here you can see a sample of what that table looks like:\n\n![]()\n- NTAIpDetails\n| distinct FlowType, PublicIpDetails, Location\n\n**Table Structure: NTATopologyDetails**\n\nThis table contains information about different elements of your topology, including VNets, subnets, route tables, routes, NSGs, Application Gateways and much more. Here you cans see what it looks like:\n\n![]()\n\n**Table Structure: NTANetAnalytics**\n\nAlright, now we are coming to more interesting things: this table is the one containing the flows we are looking for. Records in this table will contain the usual attributes you would expect such as source and destination IP, protocol, and destination port. Additionally, data will be enriched with information such as:\n\n- Source and destination VM\n- Source and destination NIC\n- Source and destination subnet\n- Source and destination load balancer\n- Flow encryption (yes/no)\n- Whether the flow is going over ExpressRoute\n- And many more\n\nFurther below you can read some scenarios with detailed queries that will show you some examples of ways you can extract information from VNet Flow Logs and Traffic Analytics. Of course, these are just some of the scenarios that came to mind on my topology, the idea is that you can get inspiration from these queries to support your individual use case.\n\n**Example Scenario:**\n\nImagine you want to see with which IP addresses a given virtual machine has been talking to in the last few days:\n- NTANetAnalytics\n| where TimeGenerated > ago(10d) | where SrcIp == \"10.10.1.4\" and strlen(DestIp)>0 | summarize TotalBytes=sum(BytesDestToSrc+BytesSrcToDest) by SrcIp, DestIp![]()\n\nSimilarly, you can play around with such KQL queries in the workspace to deep dive into the Flow Logs.\n\n# References & Further Reading\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/nsg-flow-logs-overview\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/nsg-flow-logs-migrate\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-overview\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-manage\n\nhttps://learn.microsoft.com/en-us/cli/azure/network/watcher/flow-log?view=azure-cli-latest\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-policy\n\nhttps://azure.microsoft.com/en-us/pricing/details/network-watcher/\n\nhttps://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network\\_watcher\\_flow\\_log\n\nhttps://blog.cloudtrooper.net/2024/05/08/vnet-flow-logs-recipes/",
  "FeedName": "Microsoft Tech Community",
  "ProcessedDate": "2025-11-08 09:03:49",
  "FeedLevelAuthor": "rss.livelink.threads-in-node",
  "PubDate": "2025-11-08T08:29:35+00:00",
  "FeedUrl": "https://techcommunity.microsoft.com/t5/s/gxcuf89792/rss/Category?category.id=Azure",
  "Tags": [],
  "EnhancedContent": "Migrating from NSG Flow Logs to VNet Flow Logs in Azure: Implementation with Terraform\n\nAuthor: Ibrahim Baig (Consultant)\n\n# Executive Summary\n\nMicrosoft is retiring Network Security Group (NSG) flow logs and recommends migrating to Virtual Network (VNet) flow logs. After June 30, 2025, new NSG flow logs cannot be created, and all NSG flow logs will be retired by September 30, 2027. Migrating to VNet flow logs ensures continued support and provides broader, simpler network visibility.\n\n# What Changed & Key Dates\n\n- June 30, 2025: Creation of new NSG flow logs is blocked.\n\n- September 30, 2027: NSG flow logs are retired (resources deleted; historical blobs remain per retention policy).\n\n- Microsoft provides migration scripts and policy guidance for NSG→VNet flow logs.\n\n# Why Migrate? (Benefits)\n\n## Operational Simplicity & Coverage\n\n- Enable logging at the VNet, subnet, or NIC scope—no dependency on NSG.\n\n- Broader visibility across all workloads inside a VNet, not just NSG-governed traffic.\n\n## Security & Analytics\n\n- Native integration with Traffic Analytics for enriched insights.\n\n- Monitor Azure Virtual Network Manager (AVNM) security admin rules.\n\n## Continuity & Cost Parity\n\n- VNet flow logs are priced the same as NSG flow logs (with 5 GB/month free).\n\n# What’s New in VNet Flow Logs\n\n- Scopes: Enable at VNet, subnet, or NIC level.\n\n- Storage: JSON logs to Azure Storage.\n\n- At-scale enablement: Built-in Azure Policy for auditing and auto-deployment.\n\n- Analytics: Traffic Analytics add-on for deep insights.\n\n- AVNM awareness: Observe centrally managed security admin rules.\n\n# Traffic Analytics: Capabilities & Value\n\nTraffic Analytics (TA) is a powerful add-on for VNet flow logs, providing:\n\n- Automated Traffic Insights: Visualize traffic flows, identify top talkers, and detect anomalous patterns.\n\n- Threat Detection: Surface suspicious flows, lateral movement, and communication with malicious IPs.\n\n- Network Segmentation Validation: Confirm that segmentation policies are effective and spot unintended access.\n\n- Performance Monitoring: Analyze bandwidth usage, latency, and flow volumes for troubleshooting.\n\n- Customizable Dashboards: Drill down by subnet, region, or workload for targeted investigations.\n\n- Integration: Seamless with Azure Monitor and Log Analytics for alerting and automation.\n\nFor practical recipes and advanced use cases, see https://blog.cloudtrooper.net/2024/05/08/vnet-flow-logs-recipes/.\n\n# GAP:\n\nThe Terraform Registry page for azurerm\\_network\\_watcher\\_flow\\_log does not yet provide an explicit VNet flow logs example. In practice, you use the same resource and set target\\_resource\\_id to the ID of the VNet (or Subnet/NIC).\n\nRegistry page (latest): https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network\\_watcher\\_flow\\_log\n\nImportant notes:\n\n- Same resource block: azurerm\\_network\\_watcher\\_flow\\_log\n\n- Use target\\_resource\\_id = &lt;resource ID of VNet/Subnet/NIC&gt; (instead of legacy network\\_security\\_group\\_id)\n\n- As of 30 July 2025, creating new NSG flow logs is no longer possible (provider notes); migrate to VNet/Subnet/NIC targets.\n\n- Keep your azurerm provider up-to-date, earlier builds had validation gaps for subnet/NIC IDs; these were tracked and addressed in provider issues.\n\n# Implementation Guide\n\n## Option A — Terraform (Recommended for IaC)\n\nNote: Use a dedicated Storage account for flow logs, as lifecycle rules may be overwritten.\n\n``` terraform { required_version = \">= 1.5\" required_providers { azurerm = { source = \"hashicorp/azurerm\" version = \">= 3.110.0\" # or latest } } }\n\nprovider \"azurerm\" { features {} }\n\ndata \"azurerm_network_watcher\" \"this\" { name = \"NetworkWatcher_${var.region}\" resource_group_name = \"NetworkWatcherRG\" }\n\nresource \"azurerm_network_watcher_flow_log\" \"vnet_flow_log\" { name = \"${var.vnet_name}-flowlog\" network_watcher_name = data.azurerm_network_watcher.this.name resource_group_name = data.azurerm_network_watcher.this.resource_group_name target_resource_id = azurerm_virtual_network.vnet.id storage_account_id = azurerm_storage_account.flowlogs_sa.id enabled = true\n\nretention_policy { enabled = true days = 30 }\n\ntraffic_analytics { enabled = true workspace_id = azurerm_log_analytics_workspace.law.workspace_id workspace_region = azurerm_log_analytics_workspace.law.location workspace_resource_id = azurerm_log_analytics_workspace.law.id interval_in_minutes = 60 }\n\ntags = { owner = \"network-platform\" environment = var.env } }\n\n```\n\n## Option B — Azure CLI\n\n``` az network watcher flow-log create \\ --location westus \\ --resource-group MyResourceGroup \\ --name myVNetFlowLog \\ --vnet MyVNetName \\ --storage-account mystorageaccount \\ --workspace \"/subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.OperationalInsights/workspaces/<LAWName>\" \\ --traffic-analytics true \\ --interval 60\n\n```\n\n## Option C — Azure Portal\n\n- Go to Network Watcher → Flow logs → + Create.\n\n- Choose Flow log type = Virtual network; select VNet/Subnet/NIC, Storage account, and optionally enable Traffic Analytics.\n\n## Option D — At Scale via Azure Policy\n\n- Use built-in policies to audit and auto-deploy VNet flow logs (DeployIfNotExists).\n\n# Migration Approach (NSG → VNet Flow Logs)\n\n1. Inventory existing NSG flow logs.\n2. Choose migration method: Microsoft script or Azure Policy.\n3. Run both in parallel temporarily to validate.\n4. Disable NSG flow logs before retirement.\n\n# Challenges & Mitigations\n\n- Permissions: Ensure required roles on Log Analytics workspace.\n\n- Terraform lifecycle: Use a dedicated Storage account.\n\n- Tooling compatibility: Verify SIEM/NDR support.\n\n- Provider/API maturity: Use current azurerm provider.\n\n# Validation Checklist\n\n- Storage: New blobs appear in the configured Storage account.\n\n- Traffic Analytics: Data visible in Log Analytics workspace.\n\n- AVNM: Confirm traffic allowed/denied states appear in logs.\n\n# Cost Considerations\n\n- VNet flow logs ingestion: $0.50/GB after 5 GB free/month.\n\n- Traffic Analytics processing: $2.30/GB (60-min) or $3.50/GB (10-min).\n\n# Traffic Analytics Deep Dive:\n\nVNet Flow Logs are stored in Azure Blob Storage. Optionally, you can enable Traffic Analytics, which will do two things: it will enrich the flow logs with additional information, and will send everything to a Log Analytics Workspace for easy querying. This “enrich and forward to Log Analytics” operation will happen in intervals, either every 10 minutes or every hour.\n\n**Table Structure: NTAIPDetails**This table will contain some enrichment data about public IP addresses, including whether they belong to Azure services and their region, and geolocation information for other public IPs. Here you can see a sample of what that table looks like:\n\n``` NTAIpDetails | distinct FlowType, PublicIpDetails, Location ```\n\n**Table Structure: NTATopologyDetails**\n\nThis table contains information about different elements of your topology, including VNets, subnets, route tables, routes, NSGs, Application Gateways and much more. Here you cans see what it looks like:\n\n**Table Structure: NTANetAnalytics**\n\nAlright, now we are coming to more interesting things: this table is the one containing the flows we are looking for. Records in this table will contain the usual attributes you would expect such as source and destination IP, protocol, and destination port. Additionally, data will be enriched with information such as:\n\n- Source and destination VM\n- Source and destination NIC\n- Source and destination subnet\n- Source and destination load balancer\n- Flow encryption (yes/no)\n- Whether the flow is going over ExpressRoute\n- And many more\n\nFurther below you can read some scenarios with detailed queries that will show you some examples of ways you can extract information from VNet Flow Logs and Traffic Analytics. Of course, these are just some of the scenarios that came to mind on my topology, the idea is that you can get inspiration from these queries to support your individual use case.\n\n**Example Scenario:**\n\nImagine you want to see with which IP addresses a given virtual machine has been talking to in the last few days:\n\n``` NTANetAnalytics | where TimeGenerated > ago(10d) | where SrcIp == \"10.10.1.4\" and strlen(DestIp)>0 | summarize TotalBytes=sum(BytesDestToSrc+BytesSrcToDest) by SrcIp, DestIp ```\n\nSimilarly, you can play around with such KQL queries in the workspace to deep dive into the Flow Logs.\n\n# References & Further Reading\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/nsg-flow-logs-overview\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/nsg-flow-logs-migrate\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-overview\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-manage\n\nhttps://learn.microsoft.com/en-us/cli/azure/network/watcher/flow-log?view=azure-cli-latest\n\nhttps://learn.microsoft.com/en-us/azure/network-watcher/vnet-flow-logs-policy\n\nhttps://azure.microsoft.com/en-us/pricing/details/network-watcher/\n\nhttps://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network\\_watcher\\_flow\\_log\n\nhttps://blog.cloudtrooper.net/2024/05/08/vnet-flow-logs-recipes/\n\nUpdated Nov 08, 2025\n\nVersion 1.0\n\n[azure virtual machines](/tag/azure%20virtual%20machines?nodeId=board%3AAzureInfrastructureBlog)\n\n[!\\[ibrahimbaig&#x27;s avatar\\](https://techcommunity.microsoft.com/t5/s/gxcuf89792/m_assets/avatars/default/avatar-1.svg?image-dimensions=50x50)](/users/ibrahimbaig/2318497) [ibrahimbaig](/users/ibrahimbaig/2318497) ![Icon for Microsoft rank](https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/cmstNC05WEo0blc?image-dimensions=100x16&amp;constrain-image=true)Microsoft\n\nJoined February 19, 2024\n\n[View Profile](/users/ibrahimbaig/2318497)\n\n/category/azure/blog/azureinfrastructureblog [Azure Infrastructure Blog](/category/azure/blog/azureinfrastructureblog) Follow this blog board to get notified when there's new activity",
  "Author": "ibrahimbaig",
  "Link": "https://techcommunity.microsoft.com/t5/azure-infrastructure-blog/azure-vnet-flow-logs-with-terraform-the-complete-migration-and/ba-p/4468225",
  "Title": "Azure VNet Flow Logs with Terraform: The Complete Migration and Traffic Analytics Guide",
  "OutputDir": "_community"
}
