{
  "Tags": [
    "Javascript",
    "Web"
  ],
  "OutputDir": "_posts",
  "FeedLevelAuthor": "Rick Strahl's Web Log",
  "ProcessedDate": "2025-08-05 14:25:42",
  "FeedUrl": "https://feeds.feedburner.com/rickstrahl",
  "Title": "Lazy Loading the Mermaid Diagram Library",
  "Description": "The Mermaid library is a large beast, and if you're using it selectively in your Web content you probably want to make sure you don't load it unless you actually need it, due to it's download footprint and load time. If you're loading Mermaid with server only code it's pretty straight forward, but if you use it on the client there you may want to delay loading the library until you actually need to display a diagram.",
  "Link": "https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library",
  "FeedName": "Rick Strahl's Blog",
  "Author": "Rick Strahl",
  "EnhancedContent": "![](/images/HeroImages/RickHero9.jpg) ![](/images/rick175x175.jpg)\n\nhttps://twitter.com/rickstrahl https://feeds.feedburner.com/rickstrahl\n\n[Contact](https://west-wind.com/contact/)   • [Articles](https://west-wind.com/articles.aspx)   • [Products](https://store.west-wind.com)   • [Support](https://support.west-wind.com)   • [Advertise](https://weblog.west-wind.com/advertise)\n\nSponsored by:\n\n[!\\[\\](https://websurge.west-wind.com/images/WebSurgeLogo.png) **West Wind WebSurge**](https://websurge.west-wind.com?utm_campaign=westwind-weblog-sponsored)\n- Rest Client and Http Load Testing for Windows\nhttps://websurge.west-wind.com?utm_campaign=westwind-weblog-sponsored\n\n[advertise here](/advertise)\n\nShare on:\n\nhttps://twitter.com/intent/tweet?url=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;text=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library&amp;via=RickStrahl https://www.facebook.com/sharer/sharer.php?u=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;t=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library http://www.reddit.com/submit?url=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;title=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library\n\nMay 10, 2025 • from Maui, Hawaii\n\n:P\n\nOn this page:\n\n![Mermaid Loading Banner](https://weblog.west-wind.com/images/2025/Lazy-Loading-the-Mermaid-Diagram-Library/MermaidLoading.jpg)\n\nThe [Mermaid Diagrams Library](http://mermaid.js.org/) is a widely used, open source Javascript diagram library that uses text based markup to render diagrams. It's easy to use and integrate, but it's a large beast, and if you're using it selectively in your Web content you probably want to make sure you don't load it unless you actually need it due to it's large download footprint and load time. If you're loading Mermaid with server only code it's pretty straight forward, but if you use it on the client you may want to delay load the script file until you actually need to display a diagram.\n\nIf you're anything like me in my Mermaid usage, you probably have only a few pages that actually use Mermaid while the majority of other content doesn't use it. It's easy enough to slap Mermaid into a page, but personally I prefer to not load it until the page that it's on actually needs it. In my case that tends to be a very small percentage of pages.\n\nIn addition there's the issue of client side navigation: If you decide to conditionally load Mermaid, you may end up loading a page that doesn't use Mermaid so you don't load it, but then navigate on the client to a page that does use it.\n\nThe latter is a common use case for me as I use Mermaid primarily in documentation scenarios, where literally one or two pages use Mermaid and the rest do not.\n\nIn the past I've often just eaten the download and load time hit - because you know *'we need to get stuff done and get it working'*. But it's always nagged at me and so today I created a small loader that essentially can lazy load Mermaid **when it's actually needed**, both for server rendered pages (generic) or for client navigation (app specific).\n\n[!\\[\\](/images/sponsors/banner-example.png?v=1.2)](https://markdownmonster.west-wind.com?ut=weblog)\n\n## The easy way: Server Only Rendering\n\nIf you're rendering Mermaid into purely server generated code, loading Mermaid on demand might be pretty simple as long as you can examine the content of the page when the page is rendered.\n\nIn my scenario I'm dealing with Markdown content so I can look for ````mermaid` in my content to determine if I need to initialize Mermaid on an outgoing request.\n\nIn my case this is easy as the main content is user provided in a specific field that i can look at. In this case I can conditionally render the Mermaid initialization code into the page (Razor):\n\n```csharp @if (Topic.Body?.Contains(\"\\n```mermaid\") ?? false) { <script id=\"MermaidScript\" src=\"@Model.Configuration.Markdown.MermaidDiagramsUrl\"></script> <script> mermaid.initialize({startOnLoad: true});\n\ndocument.addEventHandler(\"DOMContentLoaded\", ()=> { function renderMermaid() { mermaid.init(undefined,'.mermaid'); } document.addEventHandler('previewUpdated', () => { renderMermaid(); }); renderMermaid(); }); </script>\n\n<style> pre.mermaid { border: none !important; } </style> }\n\n```\n\nI also use similar code to this in my Desktop App documentation solution which uses a Handlebars like rendering engine. Same idea - I can render my previews with the script embedded as needed.\n\n### Server Rendering may not work reliably\n\nThis worked great for the offline app and previewing - but I ran into problems once I published my application into a documentation viewer HTML page, that uses client navigation to navigate topics.\n\nThe initial topic is 'server rendered' (static page but Mermaid was rendered into it as needed). But if I start out on a topic that doesn't have Mermaid in it, then navigate to another topic that does have Mermaid in it, the Mermaid script and startup code are not available and the diagrams don't render.\n\n## Loading Mermaid On Demand\n\nThere a couple of ways you can deal with this:\n\n1. Just always load Mermaid and *fogettaboutit*\n2. Lazy load Mermaid **only when it's needed**\n\nWe already talked about option #1 - it works but it wastes resources.\n\nFor option #2, the following code is a small component that handles Mermaid lazy loading and a couple of other useful features:\n\n- On demand loading of the Mermaid script library\n- Event based refresh via `previewRefresh`\nevent handler\n- Optionally pass in Library Url\n- Optionally pass in Mermaid configuration options\n- Easy to use and remember\n\nThe component ends up being a drop in script block that is called as a one-line function.\n\n***Note:** This scenario specifically uses the straight script version of Mermaid (USM) and the `previewRefresh` implementation is specific to my application that fires these events (namely when the document is previewed and navigated via client link navigation).*\n\nHere's the code:\n\n```javascript /* Loads mermaid onto a page if there's mermaid code in the page, and renders any mermaid diagrams. */ function mermaidLoader(mermaidUrl = \"https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js\", mermaidConfig = { startOnLoad: true, theme: \"default\", themeVariables: { primaryColor: \"#ffcc00\", edgeLabelBackground: \"#ffffff\", tertiaryColor: \"#ffffff\" } }) { // handle previewUpdated event - must be declared here so always available! document.addEventListener(\"previewUpdated\", ()=> renderMermaid());\n\nif (!window.mermaid) { if (!document.querySelector(\".mermaid\")) return; loadMermaid(); // also fires initial render on load return; }\n\nfunction initializeMermaid() { mermaid = window.mermaid; mermaid.initialize(mermaidConfig); renderMermaid(); }\n\nfunction renderMermaid() { if (!document.querySelector(\".mermaid\")) return;\n\nif (!window.mermaid) loadMermaid(); else mermaid.init(undefined,'.mermaid'); }\n\nfunction loadMermaid() { if (window.mermaid) return;\n\nconst script = document.createElement(\"script\"); script.src = mermaidUrl; script.async = true; script.onload = function () { initializeMermaid(); }; document.head.appendChild(script); } }\n\n```\n\nWhat's nice is that you can drop this into a top level application page with a single line of code:\n\n```javascript <script> document.addEventListener(\"DOMContentLoaded\", ()=> { docMonster.initializeLayout(); setTimeout(docMonster.tocExpandTop, 5);\n\n// THIS: check for, load and run mermaid mermaidLoader(); }); </script>\n\n```\n\n> >\n> Note that you do need to wait for page load, so that you can accurately check for Mermaid script in the page - so execute in `DOMContentLoaded`\n> event or `$()`\n> etc.\n> >\n\nAs you can see there's no URL specified and no configuration provided so everything uses defaults. Unless the page contains Mermaid tags, the script is not loaded which improves page load time - in my case for 99% of my pages don't use Mermaid so between script load and parsing of the large library page load time improves quite a bit for pages that don't use it.\n\nThe function can pass in:\n\n- the Mermaid Library Url\n- a Mermaid configuration object\n\nWith parameters it looks like this:\n\n```js mermaidLoader(\"@MarkdownMonster.mmApp.Configuration.Markdown.MermaidDiagramsUrl\", { startOnLoad: true, theme: \"dark\", themeVariables: { primaryColor: \"#ffcc00\", edgeLabelBackground: \"#ffffff\", tertiaryColor: \"#ffffff\" } });\n\n```\n\nNote that I'm providing the Mermaid Url here using a server generated configuration setting, but that's optional. The default Mermaid Url is likely appropriate in 90% of use cases unless you want to use a local copy (which wouldn't be cached as well).\n\nMermaid configuration is useful primarily for switching the rendering scheme. Mermaid has some pretty horrific default themes unfortunately, and none of them work very well with both light and dark themes, so providing at minimum some configuration based on the render theme is not unusual.\n\n#### Client Page Refresh Notifications\n\nOne important aspect of this component is that it also handles client navigation and more importantly loading the script from client code, so that the library isn't loaded until needed.\n\nFor client page updates my host application creates a `previewUpdated` event:\n\n```javascript // Raise a previewUpdated event on the document var event = new Event(\"previewUpdated\", { bubbles: false, cancelable: true }); event.target = document; event.currentTarget = document; document.dispatchEvent(event);\n\n```\n\nThat event is then captured by the `mermaidLoader` :\n\n```js document.addEventListener(\"previewUpdated\", ()=> renderMermaid());\n\n```\n\nwhich then goes on to call `renderMermaid()` which in turn checks to see if the library is already loaded and if not loads it:\n\n```javascript function renderMermaid() { if (!document.querySelector(\".mermaid\")) return;\n\nif (!window.mermaid) loadMermaid(); else mermaid.init(undefined,'.mermaid'); }\n\n```\n\nThe `loadMermaid` call handles inserting the script and then process Mermaid scripts. Otherwise `mermaid.init()` just processes the page.\n\nThe code for this seems a little circuitous with the nested function calls, but breaking out like this allows for both server rendered code (initial page load) and client code (client navigation) to use the same logic.\n\n## Workey, Workey\n\nTo see how this works you can check out the Markdown Monster documentation which uses this component.\n\nIf you go to this page which includes some sample Mermaid charts:\n\n- [Rendering Mermaid Charts](https://markdownmonster.west-wind.com/docs/Markdown-Rendering-Extensions/Rendering-Mermaid-Charts.html)\n\nYou can use the browser tools to see that this page - if you access it directly - loads the Mermaid library and it's immediately loaded when the page come up.\n\nIf you go to most other pages directly - or if you navigate in the tree Refresh the page to completely reload the page - you'll see that the Mermaid library **is not immediately loaded**. It's not loaded until you navigate in the tree to a page that contains Mermaid tags, using client navigation. In this use case, Mermaid usage is two pages out of the entire documentation which makes it worth the extra effort to avoid loading anything Mermaid related unless the page uses it.\n\n[!\\[\\](/images/Sponsors/Websurge-Display.png)](https://websurge.west-wind.com?ut=weblog)\n\n## Summary\n\nNothing too exciting but whenever I use Mermaid I end up with a similar situation and I tend to just slap Mermaid on the page and take the 660k download hit, but it's just wasted resources. The code I show here is simple and reusable and it handles a multiple scenarios including client navigation automatically. Next time I'll be ready 😄\n\n## Resources\n\n- [Mermaid Diagrams](http://mermaid.js.org/)\n- [Mermaid Configuration Options](http://mermaid.js.org/intro/syntax-reference.html#configuration)\n\n### Other Posts you might also like\n\n- [Client Templating with jQuery](https://weblog.west-wind.com/posts/2008/Oct/13/Client-Templating-with-jQuery)\n- [Embedding ASP.NET Server Variables in Client JavaScript](https://weblog.west-wind.com/posts/2008/Feb/12/Embedding-ASPNET-Server-Variables-in-Client-JavaScript)\n- [Accepting Raw Request Body Content with ASP.NET Web API](https://weblog.west-wind.com/posts/2013/Dec/13/Accepting-Raw-Request-Body-Content-with-ASPNET-Web-API)\n- [Taking the new Chromium WebView2 Control for a Spin in .NET - Part 1](https://weblog.west-wind.com/posts/2021/Jan/14/Taking-the-new-Chromium-WebView2-Control-for-a-Spin-in-NET-Part-1)\n\nShare on:\n\nhttps://twitter.com/intent/tweet?url=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;text=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library&amp;via=RickStrahl\n\nhttps://www.facebook.com/sharer/sharer.php?u=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;t=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library http://www.reddit.com/submit?url=https://weblog.west-wind.com/posts/2025/May/10/Lazy-Loading-the-Mermaid-Diagram-Library&amp;title=Lazy%20Loading%20the%20Mermaid%20Diagram%20Library\n\n![Make Donation](/images/donation.png \"Find this content useful? Consider making a small donation.\")\n\nIs this content useful to you? **Consider making a small donation** to show your support.\n\nPosted in **[Javascript](/ShowPosts.aspx?Category=Javascript)  [Web](/ShowPosts.aspx?Category=Web)**",
  "PubDate": "2025-05-11T09:26:29+00:00"
}
