{
  "Tags": [
    ".NET",
    "ASP.NET Core",
    "authorization",
    "Blazor WebAssembly",
    "Keycloak",
    "RBAC",
    "Role-Based Authorization",
    "roles",
    "Web API"
  ],
  "OutputDir": "_posts",
  "FeedLevelAuthor": "Code Maze",
  "ProcessedDate": "2025-08-05 14:18:56",
  "FeedUrl": "https://code-maze.com/feed/",
  "Title": "Implement Roles With Keycloak, Web API and Blazor WebAssembly (RBA)",
  "Description": "In this article, we will take a step further from the previous one by implementing role-based authorization with Keycloak, Blazor WebAssembly, and Web API. If you haven’t read the previous one, I strongly recommend doing that to gain a full picture of the authentication implementation. By assigning roles to users in Keycloak, we can control […]\n\nThe post [Implement Roles With Keycloak, Web API and Blazor WebAssembly (RBA)](https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/) appeared first on [Code Maze](https://code-maze.com).",
  "Link": "https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/",
  "FeedName": "Code Maze Blog",
  "Author": "Marinko Spasojević",
  "EnhancedContent": "# Implement Roles With Keycloak, Web API and Blazor WebAssembly (RBA)\n\nPosted by [Marinko Spasojević](https://code-maze.com/author/marinko/) | Updated Date Feb 27, 2025 | [2](https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/#comments)\n\n![Implement Roles With Keycloak, Web API and Blazor WebAssembly (RBA)](https://code-maze.com/wp-content/uploads/2021/12/social-dotnet-security.png)\n\n[!\\[Code Maze Book Collection\\](https://code-maze.com/wp-content/uploads/2024/10/courses-template-wide.png)](https://courses.code-maze.com/courses/?source=tbanner&p=keycloak-roles-blazor-webassembly-web-api/)\n\nReady to take your skills to the next level? Jump into our high-impact courses in web development and software architecture, all with a focus on mastering the .NET/C# framework. Whether you're **building sleek web applications or designing scalable software solutions**, our expert-led training will give you the tools to succeed. Visit our **[COURSES](https://courses.code-maze.com/courses/?source=tbanner&p=keycloak-roles-blazor-webassembly-web-api/)** page now and kickstart your journey!\n\nIn this article, we will take a step further from the previous one by implementing role-based authorization with Keycloak, Blazor WebAssembly, and Web API. If you haven’t read [the previous one](https://code-maze.com/keycloak-authentication-with-asp-net-core-web-api-and-blazor-webassembly/), I strongly recommend doing that to gain a full picture of the authentication implementation.\n\nTo download the source code for the video, visit our [Patreon page](https://www.patreon.com/posts/source-code-role-123218422?utm_medium=clipboard_copy&amp;utm_source=copyLink&amp;utm_campaign=postshare_fan&amp;utm_content=web_share) (YouTube Patron tier).\n\nBy assigning roles to users in Keycloak, we can control access to specific API endpoints and UI elements in the Blazor app. This ensures that only authorized users can perform certain actions, enhancing security and user management.\n\nSo, let’s start.\n\nSupport Code Maze on Patreon to get rid of ads and get the best discounts on our products!\n\n[![Become a patron at Patreon!](https://code-maze.com/wp-content/plugins/patron-plugin-pro/plugin/lib/patron-button-and-widgets-by-codebard/images/become_a_patron_button.png)](https://www.patreon.com/oauth2/become-patron?response_type=code&amp;min_cents=100&amp;client_id=9_akhcsDQMGo-FTlVmNpM_uxSV4fbW3vnrz7CBRV9RxwjMPCLfWgodhrcE0UuHH4&amp;scope=identity%20identity[email]&amp;redirect_uri=https://code-maze.com/patreon-authorization/&amp;state=eyJmaW5hbF9yZWRpcmVjdF91cmkiOiJodHRwczpcL1wvY29kZS1tYXplLmNvbVwvaGF0ZW9hcy1hc3BuZXQtY29yZS13ZWItYXBpXC8ifQ%3D%3D&amp;utm_source=https%3A%2F%2Fcode-maze.com%2Fhateoas-aspnet-core-web-api%2F&amp;utm_medium=patreon_wordpress_plugin&amp;utm_campaign=11086160&amp;utm_term=&amp;utm_content=post_unlock_button)\n\n**VIDEO**: Role-based Authorization With Keycloak, ASP.NET Core Web API and Blazor WASM.\n\n## Add Roles in Keycloak\n\nIn the previous article, we registered a user manually, and for that user, we can manually assign roles.\n\nBut first, let’s create some roles.\n\nTo do that let’s navigate to the BlazorWebApiRealm realm, and open the “Realm roles” menu:\n\n[![Creating Roles With Keycloack](https://code-maze.com/wp-content/uploads/2025/02/Creating-Roles-With-Keycloack.png)](https://code-maze.com/wp-content/uploads/2025/02/Creating-Roles-With-Keycloack.png)\n\nWe create two roles, `Administrator` and `Visitor` , and for each role, we have to click the `Create role` button, add the role name, and click the `Save` button.\n\n### Assign a Role to an Existing User in Keycloak\n\nOnce we have the required roles, we have to assign the `Administrator` role to the existing user.\n\nTo do that:\n\n- Let’s navigate to the Users menu on the left – as you can see in the previous image the menu is just below the `Realm roles`\n- Select the codemaze user – the one we created in the previous article\n- Open the Role mapping tab\n- Click the Assign role button\n- In a drop-down list select `Filter by realm roles`\n- Choose the `Administrator`\nrole and click the `Assign` button\n\n## Enable Automatic Registration in Keycloak\n\nWe also want to enable new registered users to get a role assigned automatically. To do that, we need first to enable user registration by:\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n- Navigating to the Realm settings menu – bit down in the menu on the left\n- Open the Login tab\n- Check the User registration box (set it to ON)\n\n[![Automatic User Registration in Keycloak](https://code-maze.com/wp-content/uploads/2025/02/Automatic-User-Registration-in-Keycloak-e1739872564856.png)](https://code-maze.com/wp-content/uploads/2025/02/Automatic-User-Registration-in-Keycloak.png)\n\nAlso, now, on the same page, we can navigate to the User registration tab (the last tab on the right):\n\n- Click the Assign role button\n- Change the DDL to Filter by realm roles\n- Select the role we want newly registered users to have by default (the Visitor role)\n- Click the `Assign`\nbutton\n\nWith this prepared, we assign roles with Keycloak to all registered users.\n\n## Test Role Implementation With Keycloak and Blazor WASM\n\nSo, let’s run the Blazor app and click the `Log in` button:\n\n[![The Register link on the Login Form in Keycloak](https://code-maze.com/wp-content/uploads/2025/02/The-Register-link-on-the-Login-Form-in-Keycloak.png)](https://code-maze.com/wp-content/uploads/2025/02/The-Register-link-on-the-Login-Form-in-Keycloak.png)\n\nWe can see the Register link now, so let’s click on it, and populate the registration form to register a new user. We will register a CodeMazeVisitor user.\n\nOnce we do that, the new user will be registered and logged in.\n\nTo check if the role is included, we can inspect the application tab of dev tools, and in the session storage find the oidc entry (the same as we did in the previous article). There we can copy the access token and decode it. We should see `realm_access` with roles:\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n``` \"realm_access\": { \"roles\": [ \"default-roles-blazorwebapirealm\", \"offline_access\", \"uma_authorization\", \"Visitor\" ] ```\n\nBut, we don’t want that. We want to have a role mapper for this to make it more intuitive.\n\n## Mapping Roles in Keycloak For the Blazor WASM App\n\nSo, to create a correct mapping, let’s open the `Client Scopes` menu and find the `roles` scope, and click on it:\n\n[![Roles scope in Keycloak](https://code-maze.com/wp-content/uploads/2025/02/Roles-scope-in-Keycloak.png)](https://code-maze.com/wp-content/uploads/2025/02/Roles-scope-in-Keycloak.png)\n\nOnce we’ve clicked on that scope, we will see a new Roles page with the `Settings` tab active.\n\nBut, we want to:\n\n- Click on the `Mappers`\ntab\n- Find `realm roles`\nmapper\n- Change `Token Claim Name`\nto `role` (not roles—Blazor expects role)\n- Set the `Add to ID Token`\ncheckbox to `Yes` to include the claim in the ID Token\n- `Add to Access Token`\nand `Multivalued` options are already set to `Yes`\n- But we also want to set the `Add to UserInfo`\nto `Yes`\n- Finally, let’s click the `Save`\nbutton\n\nAgain, for each of these options, you have a question mark icon that provides some explanation about that option.\n\nNow to enable roles in the Blazor app, we need to modify the OIDC configuration inside the `Program` class:\n\n``` builder.Services.AddOidcAuthentication(options => { options.ProviderOptions.Authority = \"http://localhost:8080/realms/BlazorWebApiRealm\"; options.ProviderOptions.ClientId = \"blazor-client\"; options.ProviderOptions.ResponseType = \"code\"; options.ProviderOptions.DefaultScopes.Add(\"blazor_api_scope\"); options.UserOptions.RoleClaim = \"role\"; }); ```\n\nBecause of the mapping, Keycloak stores the roles under the “role” claim, so we are mapping that here.\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\nNow if we log in again and inspect the token:\n\n``` \"role\": [ \"default-roles-blazorwebapirealm\", \"offline_access\", \"uma_authorization\", \"Visitor\" ], ```\n\nWe can see the role claim here with multiple roles as an array of strings.\n\n## Using Roles To Protect the Blazor WASM App\n\nNow, we can protect the Weather page to be accessed only by the administrators:\n\n``` @page \"/weather\" @inject HttpClient Http @using Microsoft.AspNetCore.Authorization @attribute [Authorize(Roles = \"Administrator\")] ```\n\nAlso, since we have two users with different roles assigned, we can test this by hiding the Weather menu from the users with the Visitor role inside the NavMenu component:\n\n``` <AuthorizeView Roles=\"Administrator\"> <div class=\"nav-item px-3\"> <NavLink class=\"nav-link\" href=\"weather\"> <span class=\"bi bi-list-nested-nav-menu\" aria-hidden=\"true\"></span> Weather </NavLink> </div> </AuthorizeView> ```\n\nBut, if you log in now (it doesn’t matter which user you use) this still won’t work. We won’t be able to see the Weather menu on the left. That’s because the role claim is an array of strings.\n\nSo, we have to work our way around that.\n\n## Working With Multiple Roles Inside the Keycloak Role Claim\n\nTo be able to parse the role claim from the array of strings to the “single-role-per-claim” claims, we have to create a new class:\n\n``` public class MultipleRoleClaimsPrincipalFactory<TAccount> : AccountClaimsPrincipalFactory<TAccount> where TAccount : RemoteUserAccount { public MultipleRoleClaimsPrincipalFactory(IAccessTokenProviderAccessor accessor) : base(accessor) { }\n\npublic async override ValueTask<ClaimsPrincipal> CreateUserAsync(TAccount account, RemoteAuthenticationUserOptions options) { var user = await base.CreateUserAsync(account, options); var claimsIdentity = (ClaimsIdentity)user.Identity; if (account != null) { MapArrayClaimsToMultipleSeparateClaims(account, claimsIdentity); }\n\nreturn user; }\n\nprivate static void MapArrayClaimsToMultipleSeparateClaims(TAccount account, ClaimsIdentity claimsIdentity) { foreach (var prop in account.AdditionalProperties) { var key = prop.Key; var value = prop.Value; if (value != null && (value is JsonElement element && element.ValueKind == JsonValueKind.Array)) { claimsIdentity.RemoveClaim(claimsIdentity.FindFirst(prop.Key)); var claims = element.EnumerateArray() .Select(x => new Claim(prop.Key, x.ToString())); claimsIdentity.AddClaims(claims); } } } } ```\n\nThis class – `MultipleRoleClaimsPrincipalFactory<TAccount>` , extends `AccountClaimsPrincipalFactory<TAccount>` to properly handle role claims stored as arrays in Keycloak. By default, Keycloak sends roles in a single claim as an array of strings, but .NET expects each role as a separate claim. This class ensures that each role is added individually to the `ClaimsPrincipal` .\n\nIf you look at the code, you will see it is not that complicated. We just create a user, and if the account exists, we call `MapArrayClaimsToMultipleSeparateClaims` to transform any array-based claims into multiple individual claims.\n\nAlso, we need to call this class in `Program` :\n\n``` builder.Services.AddOidcAuthentication(options => { options.ProviderOptions.Authority = \"http://localhost:8080/realms/BlazorWebApiRealm\"; options.ProviderOptions.ClientId = \"blazor-client-test\"; options.ProviderOptions.ResponseType = \"code\"; options.ProviderOptions.DefaultScopes.Add(\"blazor_api_scope\"); options.UserOptions.RoleClaim = \"role\"; }).AddAccountClaimsPrincipalFactory<MultipleRoleClaimsPrincipalFactory<RemoteUserAccount>>(); ```\n\nNow, we can test with the Visitor user – we won’t see the Weather page and won’t be able to access it through URI.\n\nBut if we log in as an administrator – we will be able to see the page and the data.\n\nAdditionally, we can protect API with the administrator role, and everything will work:\n\n``` [HttpGet] [Authorize(Roles = \"Administrator\")] public IEnumerable<WeatherForecast> Get() ```\n\nYou can test it again.\n\n## Conclusion\n\nBy transforming role claims from arrays into individual claims, we ensure proper implementation of roles with Keycloak, Blazor WebAssembly, and .NET Web API. This allows for proper authorization checks and ensures users have the correct permissions. With this setup, role-based access control (RBAC) is fully functional, enhancing security and user management in the application.\n\n[!\\[Code Maze Book Collection\\](https://code-maze.com/wp-content/uploads/2024/10/courses-template-wide.png)](https://courses.code-maze.com/courses/?source=bbanner&p=keycloak-roles-blazor-webassembly-web-api/)\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\nReady to take your skills to the next level? Jump into our high-impact courses in web development and software architecture, all with a focus on mastering the .NET/C# framework. Whether you're **building sleek web applications or designing scalable software solutions**, our expert-led training will give you the tools to succeed. Visit our **[COURSES](https://courses.code-maze.com/courses/?source=bbanner&p=keycloak-roles-blazor-webassembly-web-api/)** page now and kickstart your journey!\n\nLiked it? Take a second to support Code Maze on Patreon and get the ad free reading experience!\n\n[![Become a patron at Patreon!](https://code-maze.com/wp-content/plugins/patron-plugin-pro/plugin/lib/patron-button-and-widgets-by-codebard/images/become_a_patron_button.png)](https://www.patreon.com/oauth2/become-patron?response_type=code&min_cents=100&client_id=9_akhcsDQMGo-FTlVmNpM_uxSV4fbW3vnrz7CBRV9RxwjMPCLfWgodhrcE0UuHH4&scope=identity%20identity[email]&redirect_uri=https://code-maze.com/patreon-authorization/&state=eyJmaW5hbF9yZWRpcmVjdF91cmkiOiJodHRwczpcL1wvY29kZS1tYXplLmNvbVwva2V5Y2xvYWstcm9sZXMtYmxhem9yLXdlYmFzc2VtYmx5LXdlYi1hcGlcLyJ9&utm_source=https%3A%2F%2Fcode-maze.com%2Fkeycloak-roles-blazor-webassembly-web-api%2F&utm_medium=patreon_wordpress_plugin&utm_campaign=11086160&utm_term=&utm_content=post_unlock_button)\n\nShare:\n\nhttp://www.facebook.com/sharer.php?u=https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/&#038;t=Implement%20Roles%20With%20Keycloak%2C%20Web%20API%20and%20Blazor%20WebAssembly%20%28RBA%29http://twitter.com/intent/tweet?text=Implement%20Roles%20With%20Keycloak%2C%20Web%20API%20and%20Blazor%20WebAssembly%20%28RBA%29%20https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/http://www.linkedin.com/shareArticle?mini=true&#038;url=https://code-maze.com/keycloak-roles-blazor-webassembly-web-api/&#038;title=Implement%20Roles%20With%20Keycloak%2C%20Web%20API%20and%20Blazor%20WebAssembly%20%28RBA%29\n\n![](data:image/gif;base64,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)\n\n#### Courses – Code Maze\n\n[!\\[code maze courses side\\](https://code-maze.com/wp-content/uploads/2024/10/code-maze-courses-template-v3.png)](https://courses.code-maze.com/courses/)\n\nWhether you want to master web development or software architecture you should check our [COURSES](https://courses.code-maze.com/courses/) and pick the one that you like.\n\n#### Ad 1\n\n#### Ad 2\n\n#### Ad 3\n\n#### Ad 4",
  "PubDate": "2025-02-21T07:20:52+00:00"
}
