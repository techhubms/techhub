{
  "Tags": [
    "entity framework core",
    "EntityFrameworkCore",
    "filtering",
    "global query filter"
  ],
  "OutputDir": "_posts",
  "FeedLevelAuthor": "Code Maze",
  "ProcessedDate": "2025-08-05 14:18:57",
  "FeedUrl": "https://code-maze.com/feed/",
  "Title": "Global Query Filters in Entity Framework Core",
  "Description": "In this article, we will discuss Entity Framework Core’s global query filters and how to use them. We will also consider other scenarios related to using query filters that we need to be aware of. Let’s dive in. What Is a Global Query Filter? Global query filters are a handy feature of Entity Framework (EF) […]\n\nThe post [Global Query Filters in Entity Framework Core](https://code-maze.com/efcore-global-query-filters/) appeared first on [Code Maze](https://code-maze.com).",
  "Link": "https://code-maze.com/efcore-global-query-filters/",
  "FeedName": "Code Maze Blog",
  "Author": "Gergő Vándor",
  "EnhancedContent": "# Global Query Filters in Entity Framework Core\n\nPosted by [Gergő Vándor](https://code-maze.com/author/gergovandor/) | Dec 23, 2024 | [3](https://code-maze.com/efcore-global-query-filters/#comments)\n\n![Global Query Filters in Entity Framework Core](https://code-maze.com/wp-content/uploads/2021/12/social-entity-framewrok.png)\n\n[!\\[Code Maze Book Collection\\](https://code-maze.com/wp-content/uploads/2024/10/courses-template-wide.png)](https://courses.code-maze.com/courses/?source=tbanner&p=efcore-global-query-filters/)\n\nReady to take your skills to the next level? Jump into our high-impact courses in web development and software architecture, all with a focus on mastering the .NET/C# framework. Whether you're **building sleek web applications or designing scalable software solutions**, our expert-led training will give you the tools to succeed. Visit our **[COURSES](https://courses.code-maze.com/courses/?source=tbanner&p=efcore-global-query-filters/)** page now and kickstart your journey!\n\nIn this article, we will discuss Entity Framework Core’s global query filters and how to use them. We will also consider other scenarios related to using query filters that we need to be aware of.\n\nTo download the source code for this article, you can visit our [GitHub repository](https://github.com/CodeMazeBlog/CodeMazeGuides/tree/main/dotnet-efcore/GlobalQueryFilters).\n\nLet’s dive in.\n\n## What Is a Global Query Filter?\n\nGlobal query filters are a handy feature of Entity Framework (EF) Core that enables us to apply a `WHERE` condition to all queries on a given entity type. These filters are defined at the model level, so we can keep our regular queries separate from our always-applied filters. But when would we want this behavior?\n\nSupport Code Maze on Patreon to get rid of ads and get the best discounts on our products!\n\n[![Become a patron at Patreon!](https://code-maze.com/wp-content/plugins/patron-plugin-pro/plugin/lib/patron-button-and-widgets-by-codebard/images/become_a_patron_button.png)](https://www.patreon.com/oauth2/become-patron?response_type=code&amp;min_cents=100&amp;client_id=9_akhcsDQMGo-FTlVmNpM_uxSV4fbW3vnrz7CBRV9RxwjMPCLfWgodhrcE0UuHH4&amp;scope=identity%20identity[email]&amp;redirect_uri=https://code-maze.com/patreon-authorization/&amp;state=eyJmaW5hbF9yZWRpcmVjdF91cmkiOiJodHRwczpcL1wvY29kZS1tYXplLmNvbVwvaGF0ZW9hcy1hc3BuZXQtY29yZS13ZWItYXBpXC8ifQ%3D%3D&amp;utm_source=https%3A%2F%2Fcode-maze.com%2Fhateoas-aspnet-core-web-api%2F&amp;utm_medium=patreon_wordpress_plugin&amp;utm_campaign=11086160&amp;utm_term=&amp;utm_content=post_unlock_button)\n\n## Global Query Filter Use Cases\n\nOne reason to use global query filters is for row-level security. For example, we might store entities in a table and want to restrict users to seeing only entities they create. In this scenario, we can apply a global query filter using the current user’s ID as a parameter and compare it against the entity’s “created by” property.\n\nA similar concept is that of [multitenancy](https://code-maze.com/aspnetcore-multitenant-application/). If we want to ensure that every user can only access data in their tenant, we can use the tenant ID as the parameter for the global query filter.\n\nFinally, and probably **the most common use case for a global query filter is implementing soft delete.** This may be for performance reasons, for record-keeping, or for restoration. When using soft delete, we mark an entity as deleted instead of actually removing it from the database. Since the entity remains in the database, we need to filter out the soft deleted records when retrieving active records.\n\nLet’s see an implementation of this last use case.\n\n## Implementing a Global Query Filter\n\nFor simplicity, let’s start by setting up EF Core in a console application:\n\n``` md GlobalQueryFilters cd GlobalQueryFilters dotnet new console ```\n\nNow let’s install the necessary NuGet packages:\n\n``` dotnet add package Microsoft.EntityFrameworkCore dotnet add package Microsoft.EntityFrameworkCore.InMemory ```\n\nIn this article, we will use EF Core’s in-memory database as data storage, but we could use any EF Core-supported database.\n\nNext, let’s create the `DbContext` :\n\n``` public sealed class SoftDeleteDbContext(DbContextOptions<SoftDeleteDbContext> options) : DbContext(options) { } ```\n\nFor now, we leave it empty. In the next section, we will create our entity and populate the `DbContext` .\n\nFinally, in the `Program` class, let’s register our `DbContext` :\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n``` var services = new ServiceCollection(); services.AddDbContext<SoftDeleteDbContext>(options => options.UseInMemoryDatabase(\"GlobalQueryFilters\"));\n\nvar serviceProvider = services.BuildServiceProvider(); ```\n\nHere, we’re creating a [dependency injection container](https://code-maze.com/dependency-injection-aspnet/#whatisdi), registering the `DbContext` , and then building our `ServiceProvider` .\n\n## Setting Up the Global Query Filter\n\nNow let’s create a simple entity with an `Id` and an `IsDeleted` flag:\n\n``` public sealed class SoftDeleteEntity { public Guid Id { get; private set; } public bool IsDeleted { get; set; } } ```\n\nThen let’s override the `OnModelCreating()` method on the `DbContext` :\n\n``` protected override void OnModelCreating(ModelBuilder modelBuilder) { modelBuilder.Entity<SoftDeleteEntity>().HasKey(s => s.Id); modelBuilder.Entity<SoftDeleteEntity>().Property(s => s.IsDeleted).IsRequired(); modelBuilder.Entity<SoftDeleteEntity>().HasQueryFilter(entity => !entity.IsDeleted); } ```\n\nHere, we configure the `Id` property as the key and then mark the `IsDeleted` property as required. **Lastly, we add our global query filter**, which returns true only if the entity being queried has *not* been deleted.\n\nSince we’re using the in-memory database, we don’t have to create a [migration](https://code-maze.com/migrations-and-seed-data-efcore/#creatingandapplyingmigrations), but we should remember to add one as needed for other databases.\n\nNow we are ready to test our query filter.\n\n## Testing the Global Query Filter\n\nLet’s return to the `Program` class and add this testing code after the call to `BuildServiceProvider()` :\n\n``` var dbContext = serviceProvider.GetRequiredService<SoftDeleteDbContext>();\n\nvar entity = new SoftDeleteEntity(); dbContext.SoftDeleteEntities.Add(entity); await dbContext.SaveChangesAsync();\n\nConsole.WriteLine($\"New entity added with id: {entity.Id}\");\n\nvar entityToDelete = await dbContext.SoftDeleteEntities .FirstOrDefaultAsync(e => e.Id == entity.Id); Console.WriteLine($\"Entity queried from DB: {entityToDelete!.Id}\");\n\nentityToDelete.IsDeleted = true; await dbContext.SaveChangesAsync();\n\nConsole.WriteLine(\"Entity soft deleted\");\n\nvar entityAfterDelete = await dbContext.SoftDeleteEntities.FirstOrDefaultAsync(e => e.Id == entity.Id); Console.WriteLine($\"Entity queried from DB after soft delete: {entityAfterDelete?.Id.ToString() ?? \"null\"}\"); ```\n\nTo understand this code better, let’s run it and then inspect it along with its output:\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n``` New entity added with id: b56e23a7-3333-4397-3acf-08dcfbf3bcbf Entity queried from DB: b56e23a7-3333-4397-3acf-08dcfbf3bcbf Entity soft deleted Entity queried from DB after soft delete: null ```\n\nFirst, we request the `DbContext` from the dependency injection container. Then we create a new `SoftDeleteEntity` , add it to the context, and commit the changes. Next, we query the entity by its ID to ensure it exists.\n\nBy default the `IsDeleted` property is false, so our query filter shouldn’t filter the newly added entity. **However, it is important to note that our global query filter is already running on our first** `FirstOrDefaultAsync()` **call.** As the first two lines of output show, the entity was saved and retrieved.\n\nNext, we soft delete the entity by setting `IsDeleted` to true and persisting the changes. Finally, we execute our query again, and the last line of output shows that the global query filter excluded the soft-deleted entity.\n\nNow that we have seen how global query filters work, let’s review some important information to keep in mind when using them.\n\n## Disabling Global Query Filters\n\nSometimes we want to opt out of using a global query filter for a specific query. For example, when we would like to display deleted entities for restoration purposes. Fortunately, **EF Core provides a convenient way to disable the query filter, by simply calling the `IgnoreQueryFilters()` extension method** in the LINQ tree.\n\nLet’s add a new query to the end of the `Program` class:\n\n``` var entityAfterDeleteWithDisabledQueryFilter = await dbContext.SoftDeleteEntities .IgnoreQueryFilters() .FirstOrDefaultAsync(e => e.Id == entity.Id);\n\nConsole.WriteLine(\"Entity queried from DB after soft delete with disabled query filter: \" + entityAfterDeleteWithDisabledQueryFilter?.Id.ToString() ?? \"null\"); ```\n\nNow, let’s rerun the application and inspect the output:\n\n``` New entity added with id: 04a64c96-48a2-41f8-0a53-08dcfd79062d Entity queried from DB: 04a64c96-48a2-41f8-0a53-08dcfd79062d Entity soft deleted Entity queried from DB after soft delete: null Entity queried from DB after soft delete with disabled query filter: 04a64c96-48a2-41f8-0a53-08dcfd79062d ```\n\nInstead of `null` , the output is the entity’s `Id` . This shows that we successfully disabled the query filter.\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n## Filtered Required Navigation Properties\n\nThere is a significant pitfall to be aware of when using global query filters. **If we define a required navigation property on our entity and a query filter filters that navigation but not the parent entity, then the result will still exclude the parent entity.**\n\nLet’s implement an example to understand this behavior.\n\nWe will start with a new entity called `ChildEntity` :\n\n``` public sealed class ChildEntity { public Guid Id { get; private set; } public ParentEntity Parent { get; private set; } = null!; } ```\n\nNext, let’s create a new `ParentEntity` that has a required navigation to its children:\n\n``` public sealed class ParentEntity(IEnumerable<ChildEntity> children) { public Guid Id { get; private set; } public bool IsDeleted { get; set; } public IEnumerable<ChildEntity> Children { get; private set; } = children;\n\nprivate ParentEntity() : this(null!){} // ctor for EF } ```\n\nAfter that, we will configure this relationship in a new `DbContext` :\n\n``` public sealed class NavPropDbContext(DbContextOptions<NavPropDbContext> options) : DbContext(options) { public DbSet<ChildEntity> Children { get; private set; } = null!; public DbSet<ParentEntity> ParentEntities { get; private set; } = null!;\n\nprotected override void OnModelCreating(ModelBuilder modelBuilder) { modelBuilder.Entity<ParentEntity>().HasKey(s => s.Id); modelBuilder.Entity<ParentEntity>().Property(s => s.IsDeleted).IsRequired(); modelBuilder.Entity<ParentEntity>().HasQueryFilter(entity => !entity.IsDeleted); modelBuilder.Entity<ParentEntity>().HasMany(s => s.Children).WithOne(c => c.Parent).IsRequired();\n\nmodelBuilder.Entity<ChildEntity>().HasKey(c => c.Id); } } ```\n\nWe add a `Children` `DbSet` and configure the relationship between parent and child as a simple many-to-one **required** relationship. When a relationship is marked as required, **EF Core uses an** `INNER JOIN` **when querying the database**.\n\n### The Program Class Modification\n\nNow let’s modify our `Program` class to register the new `DbContext` immediately under the previous one:\n\n`services.AddDbContext<NavPropDbContext>(options => options.UseInMemoryDatabase(\"GlobalQueryFilters\"));`\n\nFinally, let’s add this code to the bottom of the `Program` class:\n\n``` var navPropDbContext = serviceProvider.GetRequiredService<NavPropDbContext>();\n\nvar child = new ChildEntity(); var parent = new ParentEntity([child]); navPropDbContext.ParentEntities.Add(parent); await navPropDbContext.SaveChangesAsync();\n\nConsole.WriteLine($\"New parent added with id: {parent.Id}\"); Console.WriteLine($\"New child added with id: {child.Id}\");\n\nparent.IsDeleted = true; await navPropDbContext.SaveChangesAsync();\n\nConsole.WriteLine(\"Parent soft deleted\");\n\nvar childAfterParentDelete = await navPropDbContext.Children .Include(c => c.Parent) .FirstOrDefaultAsync(c => c.Id == child.Id);\n\nConsole.WriteLine($\"Child queried after parent is soft deleted: {childAfterParentDelete?.Id.ToString() ?? \"null\"}\"); ```\n\nWe create a child for our entity, then soft delete the parent and query the created child.\n\nNow with everything set up, let’s see the output of our app:\n\n``` New parent added with id: 7cd9f915-cc09-4231-afa5-08dcfd884154 New child added with id: d5a42220-3217-461e-ed5d-08dcfd884159 Parent soft deleted Child queried from DB after parent is soft deleted: null ```\n\nSince we previously marked the relationship as required, and then filtered the parent out by soft deleting it, the query did not return any children, due to the `INNER JOIN` .\n\nSo it is important to consider relationships when declaring global query filters. The best solution for this problem is to create a global query filter for children too, with their parent’s filter condition:\n\n`modelBuilder.Entity<ChildEntity>().HasQueryFilter(c => !c.Parent.IsDeleted);`\n\nThis way, we clearly indicate our intention. If a parent is filtered out by its query filter, we don’t want the children either. Or, if we need the children regardless of their parent’s status, we can always ignore the query filter, as we saw earlier. Finally, it’s also possible to configure the relationship as optional instead of required. In this case, EF Core will use a `LEFT JOIN` rather than an `INNER JOIN` when querying, so children will always be returned.\n\n## Conclusion\n\nIn this article, we explored EF Core’s global query filter feature. We discussed what it is, and when we might use it, and created an example implementation for soft deleting entities. Finally, we discussed other important considerations when using global query filters and how to mitigate potential issues.\n\nIs this material useful to you? Consider subscribing and get **ASP.NET Core Web API Best Practices** eBook for [FREE!](https://code-maze.com/free-ebook-aspnetcore-webapi-best-practices/)\n\n[!\\[Code Maze Book Collection\\](https://code-maze.com/wp-content/uploads/2024/10/courses-template-wide.png)](https://courses.code-maze.com/courses/?source=bbanner&p=efcore-global-query-filters/)\n\nReady to take your skills to the next level? Jump into our high-impact courses in web development and software architecture, all with a focus on mastering the .NET/C# framework. Whether you're **building sleek web applications or designing scalable software solutions**, our expert-led training will give you the tools to succeed. Visit our **[COURSES](https://courses.code-maze.com/courses/?source=bbanner&p=efcore-global-query-filters/)** page now and kickstart your journey!\n\nLiked it? Take a second to support Code Maze on Patreon and get the ad free reading experience!\n\n[![Become a patron at Patreon!](https://code-maze.com/wp-content/plugins/patron-plugin-pro/plugin/lib/patron-button-and-widgets-by-codebard/images/become_a_patron_button.png)](https://www.patreon.com/oauth2/become-patron?response_type=code&min_cents=100&client_id=9_akhcsDQMGo-FTlVmNpM_uxSV4fbW3vnrz7CBRV9RxwjMPCLfWgodhrcE0UuHH4&scope=identity%20identity[email]&redirect_uri=https://code-maze.com/patreon-authorization/&state=eyJmaW5hbF9yZWRpcmVjdF91cmkiOiJodHRwczpcL1wvY29kZS1tYXplLmNvbVwvZWZjb3JlLWdsb2JhbC1xdWVyeS1maWx0ZXJzXC8ifQ%3D%3D&utm_source=https%3A%2F%2Fcode-maze.com%2Fefcore-global-query-filters%2F&utm_medium=patreon_wordpress_plugin&utm_campaign=11086160&utm_term=&utm_content=post_unlock_button)\n\nShare:\n\nhttp://www.facebook.com/sharer.php?u=https://code-maze.com/efcore-global-query-filters/&#038;t=Global%20Query%20Filters%20in%20Entity%20Framework%20Corehttp://twitter.com/intent/tweet?text=Global%20Query%20Filters%20in%20Entity%20Framework%20Core%20https://code-maze.com/efcore-global-query-filters/http://www.linkedin.com/shareArticle?mini=true&#038;url=https://code-maze.com/efcore-global-query-filters/&#038;title=Global%20Query%20Filters%20in%20Entity%20Framework%20Core\n\n![](data:image/gif;base64,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)\n\n#### Courses – Code Maze\n\n[!\\[code maze courses side\\](https://code-maze.com/wp-content/uploads/2024/10/code-maze-courses-template-v3.png)](https://courses.code-maze.com/courses/)\n\nWhether you want to master web development or software architecture you should check our [COURSES](https://courses.code-maze.com/courses/) and pick the one that you like.\n\n#### Ad 1\n\n#### Ad 2\n\n#### Ad 3\n\n#### Ad 4",
  "PubDate": "2024-12-23T04:47:32+00:00"
}
