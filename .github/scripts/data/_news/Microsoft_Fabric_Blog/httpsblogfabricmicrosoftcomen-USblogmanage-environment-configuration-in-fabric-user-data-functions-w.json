{
  "Description": "Data Engineers working with Microsoft Fabric often need to manage environment-specific configurations, including the modification of Lakehouse names, file paths, or schema names for development, testing, and production environments. In this scenario, you would want to avoid hard coding this information. This is where variable libraries in Fabric can help data engineers manage their environment configuration when working with Fabric User data …\n\n[Continue reading “Manage environment configuration in Fabric User data functions with variable libraries “](https://blog.fabric.microsoft.com/en-us/blog/manage-environment-configuration-in-fabric-user-data-functions-with-variable-libraries/)",
  "Title": "Manage environment configuration in Fabric User data functions with variable libraries",
  "PubDate": "2025-11-24T12:47:12+00:00",
  "Author": "Microsoft Fabric Blog",
  "Link": "https://blog.fabric.microsoft.com/en-US/blog/manage-environment-configuration-in-fabric-user-data-functions-with-variable-libraries/",
  "ProcessedDate": "2025-11-24 20:02:40",
  "OutputDir": "_news",
  "FeedLevelAuthor": "Microsoft Fabric Blog",
  "FeedUrl": "https://blog.fabric.microsoft.com/en-us/blog/feed/",
  "Tags": [],
  "EnhancedContent": "Data Engineers working with Microsoft Fabric often need to manage environment-specific configurations, including the modification of Lakehouse names, file paths, or schema names for development, testing, and production environments. In this scenario, you would want to avoid hard coding this information. This is where [variable libraries](https://learn.microsoft.com/fabric/cicd/variable-library/get-started-variable-libraries) in Fabric can help data engineers manage their environment configuration when working with [Fabric User data function](https://learn.microsoft.com/en-us/fabric/data-engineering/user-data-functions/user-data-functions-overview).\n\nBenefits of using variable libraries:\n\n- **Consistency:** Define values once and reuse them across multiple user data functions within your workspace.\n\n- **Security:** Keep sensitive data out of your code by referencing secure variables.\n\n- **Flexibility:** Update configurations without redeploying code.\n\n- **Deployment pipeline integration:** Variables can be injected into CI/CD workflows  when working with [deployment pipelines](https://learn.microsoft.com/fabric/cicd/deployment-pipelines/intro-to-deployment-pipelines?tabs=new-ui) in Fabric.\n\n## Adding a variable library to a user data function\n\n1. Using **Develop mode**, find and select **Manage connections** in the ribbon of the Functions portal editor. Manage connections allows to reference to any Fabric item supported by User data functions such as Fabric SQL Database or Variable library. Learn more on what is supported.\n\n1. Select a variable library item that will be referenced in your code.\n\n1. Once created, the new connection to variable library is added. Make a note of the **Alias**field. You will use the alias to reference the item in your code.\n\n**NOTE:** Always use the latest `fabric-user-data-functions` library.\n\n![](//dataplatformblogwebfd-d3h9cbawf0h8ecgf.b01.azurefd.net/wp-content/uploads/2025/11/image-61.png)\n\n## Accessing Variable values in user data functions\n\nTo retrieve variable values stored in a library item within your function, reference the library using the alias assigned during setup. This method enhances code flexibility and security by enabling dynamic access to configuration values or secrets without the need for hardcoding.\n\n### Example\n\nImplements a Fabric User Data Function that sends a chat request to **Azure OpenAI** using configuration values from **Fabric Variable Library** and secrets from **Azure Key Vault**.\n\n**Code snippet**\n\n```\n# Select 'Manage connections' and add a connection to a Variable Library\n\n# Replace the alias \"<My Variable Library Alias>\" with your connection alias.\n\nfrom openai import AzureOpenAI\n\nfrom azure.keyvault.secrets import SecretClient\n\nudf = fn.UserDataFunctions()\n\n@udf.generic_connection(argName=\"keyVaultClient\", audienceType=\"KeyVault\")\n\n@udf.connection(argName=\"varLib\", alias=\"<My Variable Library Alias>\")\n\n@udf.function()\n\ndef chat_request(prompt: str, keyVaultClient: fn.FabricItem, varLib: fn.FabricVariablesClient) -> str:\n\n'''\n\nDescription: Sends a chat completion request to an Azure OpenAI model using configuration values\n\nretrieved from a Fabric Variable Library and Azure Key Vault.\n\nPre-requisites:\n\n* Create an Azure OpenAI endpoint in Azure Portal\n\n* Create an Azure Key Vault and store your Azure OpenAI API key as a secret\n\n* Grant your Fabric User Data Functions item owner's identity access to read secrets (Access policies or RBAC). Guidance: https://learn.microsoft.com/en-us/fabric/data-factory/azure-key-vault-reference-overview\n\n* Create a Variable Library in Fabric and add variables for:\n\n- KEY_VAULT_URL: Your Azure Key Vault URL (e.g., \"https://your-keyvault.vault.azure.net/\")\n\n- API_KEY_SECRET_NAME: Name of the secret in Key Vault containing the API key\n\n- ENDPOINT: Your Azure OpenAI endpoint URL\n\n- MODEL: Your deployed model name\n\n* Add the openai and azure-keyvault-secrets libraries to your function dependencies\n\n* Ensure fabric-user-data-functions library is using the latest version\n\nArgs:\n\nprompt (str): The user input or query to be processed by the model.\n\nvarLib (fn.FabricVariablesClient): A client instance to access stored variables in Variable Library\n\nfor Key Vault URL, secret name, endpoint, and model name.\n\nReturns:\n\nstr: The generated response from the Azure OpenAI model.\n\n'''\n# Retrieve configuration from Variable Library\n\nvariables = varLib.getVariables()\n\nkey_vault_url = variables[\"KEY_VAULT_URL\"]\n\napi_key_secret_name = variables[\"API_KEY_SECRET_NAME\"]\n\nendpoint = variables[\"ENDPOINT\"]\n\nmodel_name = variables[\"MODEL\"]\n\n# Obtain a credential from the generic Key Vault connection (Fabric-managed identity)\n\ncredential = keyVaultClient.get_access_token()\n\nsecret_client = SecretClient(vault_url=key_vault_url, credential=credential)\n\nkey = secret_client.get_secret(api_key_secret_name).value\n\napi_version = \"2024-12-01-preview\"\n\nclient = AzureOpenAI(\n\napi_version=api_version,\n\nazure_endpoint=endpoint,\n\napi_key=key,\n\n)\n\nresponse = client.chat.completions.create(\n\nmessages=[\n\n{\n\n\"role\": \"system\",\n\n\"content\": \"You are a helpful assistant.\",\n\n},\n\n{\n\n\"role\": \"user\",\n\n\"content\": prompt\n\n}\n\n],\n\nmax_completion_tokens=13107,\n\ntemperature=1.0,\n\ntop_p=1.0,\n\nfrequency_penalty=0.0,\n\npresence_penalty=0.0,\n\nmodel=model_name\n\n)\n\nreturn (response.choices[0].message.content) ```\n\nThis code does the following:\n\n1. It fetches Key Vault URL, secret name, endpoint, and model details from Variable Library. Update these values:\n- KEY\\_VAULT\\_URL = https://my-keyvault.vault.azure.net/\n- API\\_KEY\\_SECRET\\_NAME = “openai-api-key”\n- ENDPOINT = https://your-resource.openai.azure.com/\n- MODEL = “gpt-4”.\n2. Use the generic Key Vault connection to obtain an access token (managed by Fabric).\n3. Retrieve the API key securely from Azure Key Vault using SecretClient.\n4. Initialize the AzureOpenAI client with the retrieved configuration.\n5. Send a chat completion request with the given prompt and system instructions.\n6. Return the content of the first message in the response.\n\n## Conclusion\n\nVariable libraries in User data functions ensure consistency by letting you define values once and reuse them. They improve security through referencing sensitive information securely, not directly in code. You can update configurations without redeploying and integrate variables into deployment pipelines for seamless CI/CD workflows with Fabric. Checkout these [sample functions](https://github.com/microsoft/fabric-user-data-functions-samples/tree/main/PYTHON).",
  "FeedName": "Microsoft Fabric Blog"
}
